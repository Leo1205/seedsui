//国际化
var lang = {
	"rule": {
		"required": "不能为空",
		"number":"只能为数字",
		"username": "只能包括字母、数字和下划线",
		"password": "格式不正确",
		"phone": "手机号码输入不正确",
		"mail": "邮箱格式不正确",
		"chinese": "只能填写中文",
		"minlength": "最小长度为",
		"maxlength": "最大长度为",
		"unit": "位",
		"minnumber":"最小值为",
		"maxnumber":"最大值为",
		"twice": "两次",
		"compare": "输入不一致",
		"safelvl":"不安全，请增强",
		"specialchar":"不能包含特殊字符"
	}
};

//Device
var Device=(function(){
	var u=navigator.userAgent,app=navigator.appVersion;
	function isPc(){
		var userAgentInfo = navigator.userAgent;  
		var agents = new Array("Android", "iPhone", "SymbianOS", "Windows Phone", "iPad", "iPod");  
		var flag = true;
		for (var i=0;i<agents.length;i++) {  
			if (u.indexOf(agents[i])>0){ 
				flag = false; break; 
			}
		}  
		return flag; 
	}
	return{
	    //四大内核
	    isTrident:u.indexOf('Trident') > -1,
	    isPresto:u.indexOf('Presto') > -1,
	    isWebKit:u.indexOf('AppleWebKit') > -1,
	    isGecko:u.indexOf('Gecko') > -1 && u.indexOf('KHTML') == -1,
	    //设备判断
	    isMobile:!!u.match(/AppleWebKit.*Mobile.*/), //是否为移动终端
	    isIPhone:u.indexOf('iPhone') > -1 || u.indexOf('Mac') > -1, //是否为iPhone或者QQHD浏览器
	    isIPad:u.indexOf('iPad') > -1, //是否iPad
	    isWebApp:u.indexOf('Safari') == -1, //是否web应该程序，没有头部与底部
	    isPc:isPc(),//是否是PC端
	    //平台判断
	    isAndroid:u.indexOf('Android') > -1 || u.indexOf('Linux') > -1, //android终端或者uc浏览器
	    isIos:!!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),//ios终端
	    //isWebview =u.toLowerCase().indexOf("webview") > -1,
	    //应用程序判断
		isWeixin:app.toLowerCase().indexOf("micromessenger") > -1,//判断是否是微信
		isUC:app.toLowerCase().indexOf("ucbrowser") > -1,//判断是否是UC
		isQQ:app.toLowerCase().indexOf("mqqbrowser") > -1,//判断是否是UC
	    language:(navigator.browserLanguage || navigator.language).toLowerCase(),
	    userAgent:u,
	    appVersion:app,
	    isOnline:window.navigator.online,
	    isExmobi:app.toLowerCase().indexOf("exmobi") > -1,//判断是否是Exmobi
   }
})();

//事件函数
(function(window,document,undefined){
	
	function _swipe_(element,type,handler){
		var xDown, yDown,xUp,yUp,xDiff,yDiff;
		element.addEventListener( 'touchstart', function( e ){
			var touches = e.touches[0];
			xDown = touches.clientX;
			yDown = touches.clientY;
		}, false);
		
		element.addEventListener( 'touchend', function( e ){
			var touches = e.changedTouches[0],
			xUp = touches.clientX,
			yUp = touches.clientY;
			xDiff=xDown - xUp;
			yDiff=yDown - yUp;
			//单击事件
			if( Math.abs(xDown - xUp) < 6 && Math.abs(yDown - yUp) < 6 ){
				if(type==="tap"){
					handler(e);
				}
				return "tap";
			}
			//上下滑动
			if(Math.abs(yDiff)>Math.abs(xDiff)){
				if(yDiff>0){
					if(type==="swipeup"){
						handler(e);
					}
					return "swipeup";
				}
				
				if(type==="swipedown"){
					handler(e);
				}
				return "swipedown";
			}
			//左右滑动
			if(xDiff>0){
				if(type==="swipeleft"){
					handler(e);
				}
				return "swipeleft";
			}
			if(type==="swiperight"){
				handler(e);
			}
			return "swiperight";
		}, false );
	};
	//transtionend事件与animationend兼容写法
	var transitionend,animationend;
	function whichKernel(){
		var t,
		el = document.createElement("fakeelement");
		var transitions = {
			"transition"      : ["transitionend","animationend"],
			"OTransition"     : ["oTransitionEnd","oAnimationEnd"],
			"MozTransition"   : ["transitionend","animationend"],
			"WebkitTransition": ["webkitTransitionEnd","webkitAnimationEnd"]
		};
		for (t in transitions){
			if (el.style[t] !== undefined){
				transitionend=transitions[t][0];
				animationend=transitions[t][1];
				break;
			}
		}
	};
	window.EventUtil = {
		/**
		 * 绑定事件
		 * 
		 * @method addHandler
		 * @param element //元素对象
		 * @param type //事件类型
		 * @param handler //响应函数
		 * @return void
		 */
		callback:function(fun,event){
			fun(event);
		},
		addHandler:function (element, type, handler) {
			//tap、swipeleft、swiperight、swipedown、swipeup
			if(type==="tap" || type==="swipeleft" ||  type==="swiperight" ||  type==="swipedown" ||  type==="swipeup"){
				_swipe_(element,type,handler);
				return;
			}
			//animationend
			if(type.toLowerCase()==="animationend"){
				if(!animationend){
					//whichKernel();
					transitionend="webkitTransitionEnd";
					animationend="webkitAnimationEnd";
				}
				if (element.addEventListener) {
					element.addEventListener(animationend, handler, false);
				}else if(element.attachEvent){
					element.attachEvent(animationend, handler);
				}
				//webkitAnimationEnd oanimationend msAnimationEnd animationend
				return;
			}
			//TransitionEnd
			if(type.toLowerCase()==="transitionend"){
				if(!transitionend){
					//whichKernel();
					transitionend="webkitTransitionEnd";
					animationend="webkitAnimationEnd";
				}
				if (element.addEventListener) {
					element.addEventListener(transitionend, handler, false);
				}else if(element.attachEvent){
					element.attachEvent(transitionend, handler);
				}
				return;
			}
			//oninput
			if(type.toLowerCase()==="input" || type.toLowerCase()==="propertychange"){
				type="input";
				if(element.attachEvent){
					type="propertychange";
				}
			}
			//系统事件
			if (element.addEventListener) {
				element.addEventListener(type, handler, false);
			} else if (element.attachEvent) {
				element.attachEvent("on" + type, handler);
			} else {
				element["on" + type] = handler;
			}
		},
		removeHandler:function(element, type, handler) {
			if (element.removeEventListener) {
				element.removeEventListener(type, handler, false);
			} else if (element.detachEvent) {
				element.detachEvent("on" + type, handler);
			} else {
				element["on" + type] = null;
			}
		},
		preventDefault:function (e) {
			if (e.preventDefault) {
				e.preventDefault();
			} else {
				e.returnValue = false;
			}
		},
		stopPropagation:function(e){
			if(e.stopPropagation){
				e.stopPropagation();
			}else{
				e.cancelBubble=true;
			}
		},
		event:function(e){
			return e?e:window.e;
		},
		type:function(e){
			return e.type;
		},
		target:function(e){
			return e.target || e.srcElement;
		}
	};
})(window,document,undefined);

//Page 单页模式
(function(window,document,undefined){
    window.Page=function(params){
    	/*=========================
          Model
          ===========================*/
		var defaults={
			"isTakeHistory":true,
			"pageBtn":"[data-toggle=page]",
			"pageClass":"page",
			"pageActiveClass":"active",
			"defaultAnimation":"slideLeft",
			"duration":"300"

			/*callbacks
			onOpenStart:function(Page)//开窗前
			onOpenEnd:function(Page)//开窗完成时动画
			onCloseStart:function(Page)//关窗前
			onCloseEnd:function(Page)//关窗完成时动画
			*/
		}

		params=params||{};
		for(var def in defaults){
			if(params[def]===undefined){
				params[def]=defaults[def];
			}
		}
		var s=this;
		s.params=params;
		//Pages
		s.pages;
		s.update=function(){
			s.pages=document.querySelectorAll("."+s.params.pageClass);
			for(var i=0,page;page=s.pages[i++];){
				if(!page.getAttribute("data-animation")){
	                page.setAttribute("data-animation",s.params.defaultAnimation);
	            }
	            var isActive=page.classList.contains(s.params.pageActiveClass);
	            var animation=page.getAttribute("data-animation");
	            if(animation=="slideDown"){
	            	page.showAnimation={webkitTransform:"translate3d(0,0,0)"};
	                page.hideAnimation={webkitTransform:"translate3d(0,-100%,0)"};
	                if(!isActive)page.style.webkitTransform="translate3d(0,-100%,0)";
	            }else if(animation=="slideUp"){
	            	page.showAnimation={webkitTransform:"translate3d(0,0,0)"};
	                page.hideAnimation={webkitTransform:"translate3d(0,100%,0)"};
	                if(!isActive)page.style.webkitTransform="translate3d(0,100%,0)";
	            }
	            else if(animation=="fade"){
	            	page.showAnimation={opacity:1};
	                page.hideAnimation={opacity:0};
	                if(!isActive)page.style.opacity=0;
	            }
	            else if(animation=="none"){
	            	page.showAnimation={visibility:"visible",noAnimation:true};
	                page.hideAnimation={visibility:"hidden"};
	                if(!isActive)page.style.visibility="hidden";
	            }
	            else if(animation=="zoom"){
	            	page.showAnimation={webkitTransform:"scale(1,1)"};
	                page.hideAnimation={webkitTransform:"scale(0,0)"};
	                if(!isActive)page.style.webkitTransform="scale(0,0)";
	            }
	            else if(animation=="slideRight"){
	            	page.showAnimation={webkitTransform:"translate3d(0,0,0)"};
	                page.hideAnimation={webkitTransform:"translate3d(-100%,0,0)"};
	                if(!isActive)page.style.webkitTransform="translate3d(-100%,0,0)";
	            }else{
	            	page.showAnimation={webkitTransform:"translate3d(0,0,0)"};
	                page.hideAnimation={webkitTransform:"translate3d(100%,0,0)"};
	                if(!isActive)page.style.webkitTransform="translate3d(100%,0,0)";
	            }
	            page.style.webkitTransitionProperty="transform,opacity";
	            s.durationPage(page);
			}
        }
        s.durationPage=function(page){
        	setTimeout(function(){
        		page.style.webkitTransitionDuration=s.params.duration+"ms";
        	},100);
        }
        s.update();
		//History
		s.history=[];
		/*=========================
          Method
          ===========================*/
        s.historyHasPage=function(pageId){
        	s.history.some(function(n,i,a){
				return pageId==n;
			})
        }
        s.addHistory=function(pageId){
        	s.history.push(pageId);
        	if(s.params.isTakeHistory==false)return;
			try{
		        window.history.pushState({href:pageId},document.title, pageId);
		    }catch(err){
		    	console.log("请检查您当前运行的环境是否为服务器端");
		    }
        }
        s.replaceHistory=function(pageId){
        	//移除最新一条，关闭上一页
        	var prePageId=s.history.pop();
        	var prePage=document.querySelector(prePageId);
        	s.durationHidePage(prePage);
        	//添加新记录
        	s.history.push(pageId);
        	if(s.params.isTakeHistory==false)return;
			try{
		        window.history.replaceState({href:pageId},document.title, pageId);
		    }catch(err){
		    	console.log("请检查您当前运行的环境是否为服务器端");
		    }
        }
        s.removeHistory=function(pageId){
        	s.history=s.history.filter(function(n,i,a){
				return n!=pageId;
			})
        }
        s.isHid=true;
        s.showPage=function(page){
        	s.isHid=false;
        	page.classList.add(s.params.pageActiveClass);
        	page.style.visibility="visible";
            for(var ani in page.showAnimation){
                page.style[ani]=page.showAnimation[ani];
            }
            //如果窗口选择为无动画
            /*if(page.showAnimation["noAnimation"]){
            	var e={};
            	e.target=page;
            	s.onTransitionEnd(e);
            }*/
        }
        s.durationHidePage=function(page){
        	setTimeout(function(){
        		s.hidePage(page);
        	},500);
        }
        s.hidePage=function(page){
        	s.isHid=true;
        	page.classList.remove(s.params.pageActiveClass);
            for(var ani in page.hideAnimation){
                page.style[ani]=page.hideAnimation[ani];
            }
            //如果窗口选择为无动画
            /*if(page.showAnimation["noAnimation"]){
            	var e={};
            	e.target=page;
            	s.onTransitionEnd(e);
            }*/
        }
        s.hideAllPage=function(exceptPageId){
        	for(var i=0,page;page=s.pages[i++];){
        		if(exceptPageId && "#"+page.id==exceptPageId){
        			continue;
        		}
        		s.hidePage(page);
        	}
        }
		//关窗函数
		s.close=function(pageId,animation){
			var page=document.querySelector(pageId);
			if(animation){
				page.setAttribute("data-animation",animation);
				s.update();
			}
			//删除对应的历史记录
			s.removeHistory(pageId);
			//隐藏Page
			s.hidePage(page);
			//Callback
			s.targetPage=page;
			if(s.params.onCloseStart)s.params.onCloseStart(s);
		}
		//开窗函数
		s.open=function(pageId,target,animation){
			var page=document.querySelector(pageId);
			if(animation){
				page.setAttribute("data-animation",animation);
				s.update();
			}
			//添加历史记录，并修改浏览器地址
			if(target=="_self"){
				s.replaceHistory(pageId);
			}else{
				s.addHistory(pageId);
			}
			//显示Page
			s.showPage(page);
			//Callback
			s.targetPage=page;
			if(s.params.onOpenStart)s.params.onOpenStart(s);
		}
		//回退函数
		s.back=function(){
			var pageId,page;
			//如果本地历史记录为空，而浏览器历史记录不为空，则证明刷新过页面了(防刷新)
			if(s.history.length==0 && window.history.state && window.history.state.href){
				console.log("无本地记录，但浏览器有历史记录");
				pageId=window.history.state.href;
				page=document.getElementById(pageId.substring(1));
				s.hideAllPage(pageId);
				s.showPage(page);
				return;
			}
			//如果本地历史为空，浏览器历史也为空，却可以按返回按键，证明目前处于第二层(防刷新后第二层回不到第一层)
			if(s.history.length==0){
				s.hideAllPage();
				return;
			}
			//清除顶层历史记录
			pageId=s.history[s.history.length-1];
			//关闭清除的那层
			s.close(pageId);
		}
		/*=========================
          Control
          ===========================*/
        s.events=function(detach){
            var action=detach?"removeEventListener":"addEventListener";
            //动画监听
            document[action]("webkitTransitionEnd",s.onTransitionEnd,false);
            //hash值监听
            window[action]("popstate",s.onPopstate,false);
            //页面初始化
            window[action]("load",s.onLoad,false);
            //window[action]("hashchange",s.onPopstate,false);
            //按钮监听
            var pageBtns=document.querySelectorAll(s.params.pageBtn);
            for(var i=0,btn;btn=pageBtns[i++];){
        		btn.addEventListener("click",s.onClickBtn,false);
            }
        }
        s.attach=function(event){
            s.events();
        }
        s.detach=function(event){
            s.events(true);
        }
        s.onLoad=function(e){
        	if(window.history.state && window.history.state.href){
        		var pageId=window.history.state.href;
        		var page=document.querySelector(pageId);
        		//关闭所有页面
        		s.hideAllPage(pageId);
        		//显示hash页面
        		s.showPage(page);
        	}
        }
        s.onClickBtn=function(e){
    		s.target=e.target;
			var pageId=s.target.getAttribute("href");
			var openType=s.target.getAttribute("target");
			s.open(pageId,openType);
			e.preventDefault();
		}
        s.onPopstate=function(e) {
			//后退
			s.back();
			//console.log("location: " + document.location + ", state: " + JSON.stringify(event.state));
		};
		s.onTransitionEnd=function(e){
			if(!e.target.classList.contains("page"))return;
			s.targetPage=e.target;
			//隐藏完成
			if(s.isHid){
				s.targetPage.style.visibility="hidden";
				//CallBack
				if(s.params.onCloseEnd)s.params.onCloseEnd(s);
				return;
			}
			//显示完成
			//CallBack
			if(s.params.onOpenEnd)s.params.onOpenEnd(s);
		};
		s.init=function(){
			s.attach();
		}
		s.init();
	}
})(window,document,undefined);

//Aside
(function(window,document,undefined){
    window.Aside=function(container,params){
        /*=========================
          Model
          ===========================*/
        var defaults={
            "wrapperClass":"aside-wrapper",
            "leftSide":null,
            "rightSide":null,
            "asideContainerClass":"aside",
            "sides":{"left":null,"right":null},
            "threshold":{"left":60,"right":60},

            "duration":300,
            "isClickMaskHide":true,
            "isDrag":false,
            /*callbacks
            onInit:function(Aside)
            onSlideChangeStart:function(Aside)
            onSlideChange:function(Aside)
            onSlideChangeEnd:function(Aside)
            onClickMask:function(Aside)
            */
        }
        params=params||{};
        for(var def in defaults){
            if(params[def]===undefined){
                params[def]=defaults[def];
            }
        }
        //AsideContainer
        var s=this;
        //Params
        s.params=params;
        //Container
        s.container=typeof container=="string"?document.querySelector(container):container;
        //Wrapper
        s.wrapper=s.container.querySelector("."+s.params.wrapperClass);
        //Section
        s.section=s.container.querySelector("section");
        //Article
        s.article=s.section.querySelector("article");
        //Mask
        s.createMask=function(){
            var mask=document.createElement("div");
            mask.setAttribute("class","mask");
            return mask;
        }
        s.mask=s.createMask();
        s.section.appendChild(s.mask);
        //Aside
        s.sides={"left":null,"right":null},s.position=null;
        s.update=function(){
            if(s.params.sides["left"])s.updateAside("left");
            if(s.params.sides["right"])s.updateAside("right");
        }
        s.updateAside=function(pos){
            //属性设置
            s.sides[pos]=typeof s.params.sides[pos]=="string"?s.wrapper.querySelector(s.params.sides[pos]):s.params.sides[pos];
            if(!s.sides[pos])return;
            var aside=s.sides[pos];
            //data-position
            aside.setAttribute("data-position",pos);
            //data-transition
            aside.transition=aside.getAttribute("data-transition")||"";
            //width
            aside.width=aside.clientWidth;
            if(pos=="right")aside.width=-aside.width;
            //动画设置
            switch(aside.transition){
                case "overlay":
                aside.showTransform='translate3d(0,0,0)',
                aside.hideTransform='translate3d('+-aside.width+'px,0,0)',
                aside.elTransform=aside;
                break;

                case "push":
                aside.showTransform='translate3d('+aside.width+'px,0,0)',
                aside.hideTransform='translate3d(0,0,0)',
                aside.elTransform=s.wrapper;
                break;

                case "reveal":
                aside.showTransform='translate3d('+aside.width+'px,0,0)',
                aside.hideTransform='translate3d(0,0,0)',
                aside.elTransform=s.section;
                break;
            }
        }
        s.update();
        s.updateActiveEl=function(aside){
            if(aside.transition=="overlay"){
                s.activeEl=aside;
            }else if(aside.transition=="push"){
                s.activeEl=s.wrapper;
            }else{
                s.activeEl=s.section;
            }
        }
        /*=========================
          Method
          ===========================*/
        s.showMask=function(){
            s.mask.style.visibility="visible";
            s.mask.style.opacity="1";
        }
        s.hideMask=function(){
            s.mask.style.visibility="hidden";
            s.mask.style.opacity="0";
        }
        s.transformTarget=function(target,transform,duration){
            if(!duration)duration=0;
            target.style.webkitTransitionDuration=duration+"ms";
            target.style.webkitTransform=transform;
        }
        s.isHid=true;
        s.showCallback=null;//显示动画结束后回调
        s.show=function(pos,fn){
            //设置显示回调
            if(fn)s.showCallback=fn;
            //设置显示侧边
            if(pos)s.position=pos;
            if(!s.sides[s.position]){
                s.position=null;
                return;
            }
            //记录显示状态
            s.isHid=false;
            //显示侧边栏
            s.sides[s.position].style.visibility="visible";
            s.showMask();
            s.transformTarget(s.sides[s.position].elTransform,s.sides[s.position].showTransform,s.params.duration);

            //记录触摸值
            s.touches.posX=s.sides[s.position].width;
            //隐藏滚动条
            s.article.style.overflow="hidden";
        }
        s.hideCallback=null;//隐藏动画结束后回调
        s.hide=function(fn){
            if(fn)s.hideCallback=fn;
            if(!s.sides[s.position]){
                s.position=null;
                return;
            }
            //记录显示状态
            s.isHid=true;
            //隐藏侧边栏
            s.hideMask();
            s.transformTarget(s.sides[s.position].elTransform,s.sides[s.position].hideTransform,s.params.duration);

            //记录触摸值
            s.touches.posX=0;
            //显示滚动条
            s.article.style.overflow="auto";
        }
        s.setLeftSide=function(argAside){
            s.params.sides["left"]=argAside;
            s.update();
        }
        s.setRightSide=function(argAside){
            s.params.sides["right"]=argAside;
            s.update();
        }
        s.clearChange=function(){
            //初始化transform
            if(s.sides[s.position].style.removeProperty){
                s.sides[s.position].style.removeProperty("transform");
                s.sides[s.position].style.removeProperty("-webkit-transform");
            }else{
                s.sides[s.position].style.removeAttribute("transform");
                s.sides[s.position].style.removeAttribute("-webkit-transform");
            }
            //初始化侧边栏
            s.sides[s.position].style.visibility="hidden";
            //初始化侧边栏
            s.position=null;
        }
        s.addTransitionDuration=function(){
            s.sides[s.position].style.webkitTransitionDuration=s.params.duration+"ms";
        }
        s.removeTransitionDuration=function(){
            s.sides[s.position].style.webkitTransitionDuration="0ms";
        }
        /*=========================
          Control
          ===========================*/
        s.preventDefault=function(e){
            e.preventDefault();
        }
        s.events=function(detach){
            var touchTarget=s.container;
            var action=detach?"removeEventListener":"addEventListener";
            if(s.params.isDrag){
                touchTarget[action]("touchstart",s.onTouchStart,false);
                touchTarget[action]("touchmove",s.onTouchMove,false);
                touchTarget[action]("touchend",s.onTouchEnd,false);
                touchTarget[action]("touchcancel",s.onTouchEnd,false);
            }
            //clickMask
            s.mask[action]("click",s.onClickMask,false);
            //transitionEnd
            s.wrapper[action]("webkitTransitionEnd",s.onTransitionEnd,false);
        }
        //attach、dettach事件
        s.attach=function(event){
            s.events();
        }
        s.detach=function(event){
            s.events(true);
        }
        //Events Handler
        //Touch信息
        s.touches={
            startX:0,
            startY:0,
            currentX:0,
            currentY:0,
            endX:0,
            endY:0,
            diffX:0,
            diffY:0,
            posX:0,
            direction:null,
            position:null
        };
        s.preventDefault=function(e){
            e.preventDefault();
        }
        s.stopPropagation=function(e){
            e.stopPropagation();
        }
        s.onTouchStart=function(e){
            s.container.addEventListener("touchmove",s.preventDefault,false);
            s.touches.startX=e.touches[0].clientX;
            s.touches.startY=e.touches[0].clientY;
            //Callback
            if(e.target==s.wrapper || e.target==s.section || e.target.getAttribute("data-transition")){
                s.target=e.target;
                if(s.params.onSlideChangeStart)s.params.onSlideChangeStart(s);
            }
        }
        s.showSide;
        s.onTouchMove=function(e){
            s.touches.currentX=e.touches[0].clientX;
            s.touches.currentY=e.touches[0].clientY;
            s.touches.diffX=s.touches.startX-s.touches.currentX;
            s.touches.diffY=s.touches.startY-s.touches.currentY;
            //设置滑动方向
            if(s.touches.direction==null){
                s.touches.direction=Math.abs(s.touches.diffY)-Math.abs(s.touches.diffX)>0?"vertical":"horizontal";
            }
            if(s.touches.direction=="vertical"){
                s.container.removeEventListener("touchmove",s.preventDefault,false);
                return;
            }
            e.stopPropagation();
            //x轴距离左边的像素，向左为负数，向右为正数
            var moveX=s.touches.posX-s.touches.diffX;
            //侧边显示方向
            if(!s.position){
                if(moveX<0)s.position="right";
                else s.position="left";
            }
            //拖动方向
            if(s.touches.diffX<0)s.touches.position="right";
            else s.touches.position="left";
            
            //是否存在此侧边
            if(!s.sides[s.position]){
                return;
            }

            //设置激活侧边栏
            if(!s.showSide){
                s.showSide=s.sides[s.position];
            }
            //判断是否是边缘
            if(Math.abs(moveX)>Math.abs(s.showSide.width)){
                //moveX=s.showSide.width;
                return;
            }
            if(s.position=="left" && moveX<0){
                //moveX=0;
                return;
            }
            if(s.position=="right" && moveX>0){
                //moveX=0;
                return;
            }
            
            //移动位置
            s.showSide.style.visibility="visible";
            /*if(s.showSide.transition=="overlay"){
                var translateX=-(s.showSide.width-moveX);
                s.transformTarget(s.showSide.elTransform,'translate3d('+translateX+'px,0,0)');
            }else if(s.showSide.transition=="push" || !s.showSide.transition || s.showSide.transition=="reveal"){
                s.transformTarget(s.showSide.elTransform,'translate3d('+moveX+'px,0,0)');
            }*/
            var translateX=moveX;
            if(s.showSide.transition=="overlay")translateX=-(s.showSide.width-moveX);
            s.transformTarget(s.showSide.elTransform,'translate3d('+translateX+'px,0,0)');

            if(s.params.onSlideChange)s.params.onSlideChange(s);
        }
        s.onTouchEnd=function(e){
            var sidePos=s.position;
            var touchPos=s.touches.position;
            /*console.log("侧边栏："+sidePos);
            console.log("您拖动的方向："+touchPos);
            console.log("是否是隐藏状态："+s.isHid);*/

            //展开和收缩
            if(s.touches.direction=="horizontal"){
                var threshold=s.params.threshold[sidePos];//拖动阈值
                if(s.isHid){//隐藏状态
                    if(Math.abs(s.touches.diffX)>threshold){
                        s.show(sidePos);
                    }else{
                        s.hide();
                    }
                }else{//已显示状态
                    if(Math.abs(s.touches.diffX)>threshold){
                        if(sidePos==touchPos){//拖动方向相同时才隐藏
                            s.hide();
                        }
                    }else{
                        s.show();
                    }
                }
            }

            //清空滑动方向
            s.touches.direction=null;
            s.touches.position=null;
            s.showSide=null;
        }
        s.onClickMask=function(e){
            s.target=e.target;
            if(s.params.onClickMask)s.params.onClickMask(s);
            if(s.params.isClickMaskHide){
                s.hide();
            }
            s.preventDefault(e);
        }
        s.setOnClickMask=function(fn){
            s.params.onClickMask=fn;
        }
        s.onTransitionEnd=function(e){
            if(s.mask==e.target)return;

            //移除动画
            s.removeTransitionDuration();
            //如果是隐藏状态，清除修改项
            if(s.isHid==true){
                s.clearChange();
                if(s.hideCallback)s.hideCallback(s);
            }else{
                if(s.showCallback)s.showCallback(s);
            }
            //Callback
            if(e.target==s.wrapper || e.target==s.section || e.target.getAttribute("data-transition")){
                s.target=e.target;
                if(s.params.onSlideChangeEnd)s.params.onSlideChangeEnd(s);
            }
        }
        function init(){
            s.attach();
            if(s.params.onInit)s.params.onInit(s);
        }
        init();
    }
})(window,document,undefined);

//Counter
(function(window,document,undefined){
	window.Counter=function(counter,params){
		/*=========================
        Model
        ===========================*/
        var defaults={
			"fromAttr":"data-from",
			"toAttr":"data-to",
			"durationAttr":"data-duration",
			"defaultDuration":500,
			"defaultFrom":0,
			"defaultTo":0,
			"minMilli":10
		}
		params=params||{};
		for(var def in defaults){
			if(params[def]===undefined){
				params[def]=defaults[def];
			}
		}
		//Counter
		var s=this;

		//Params
		s.params=params;

		//Counter
		s.counter=typeof counter === "string"?document.querySelector(counter):counter;
		s.timers=document.querySelectorAll("."+s.params.timerClass);

		//From(开始数字) | To(结束数字) | Duration(执行时长) | Current(当前数字)
		s.from=s.counter.getAttribute(s.params.fromAttr)||s.params.defaultFrom;
		s.to=s.counter.getAttribute(s.params.toAttr)||s.params.defaultTo;
		s.duration=s.counter.getAttribute(s.params.durationAttr)||s.params.defaultDuration;
		s.current=s.from;

		//Diff(差值)
		s.diff=s.to-s.from;

		if(s.diff<0 || isNaN(s.from) || isNaN(s.to)){
			console.log("请确定开始时间与结束时间是否输入正确！");
			return;
		}

		//NumFps(递增值)
		s.numFps=1;

		//Milli(毫秒/帧)
		s.milli=s.duration/s.diff;
		if(s.milli<s.minMilli){
			s.milli=s.minMilli;
			//总值/执行次数=递增值
			s.numFps=s.diff/(s.duration/s.milli)
		}

		//console.log("差值:"+s.diff+" ;递增:"+s.numFps+" ;毫秒/帧:"+s.milli);

		//Interval
		s.interval;
		/*=========================
          Method
          ===========================*/
		s.play=function(){
			s.interval=window.setInterval(function(){
				s.current=eval(s.current+s.numFps);
				s.counter.innerHTML=s.current;
				if (s.current >= s.to) {
					s.counter.innerHTML=s.to;
					clearInterval(s.interval);
				}
			},s.milli);
		}
		/*=========================
          Control
          ===========================*/
        s.play();
	}
	window.Counters=function(params){
		var s=this;
        //获得所有元素
        s.counters=document.querySelectorAll(".counter");
        s.counters.counters=[];
        var jsonParams={};
        if(params)jsonParams=params;
        //实例化所有元素
        for(var i=0,counter;counter=s.counters[i++];){
            s.counters.counters[i]=new Counter(counter,jsonParams);
        }
	}
})(window,document,undefined);

//Animate
window.Animate={
	raf:window.requestAnimationFrame||
		window.webkitRequestAnimationFrame||
		window.mozRequestAnimationFrame||
		window.oRequestAnimationFrame||
		window.msRequestAnimationFrame||
		function (callback) { window.setTimeout(callback, 1000 / 60); },

	caf:window.cancelAnimationFrame||
		window.webkitCancelAnimationFrame||
		window.mozCancelAnimationFrame||
		window.oCancelAnimationFrame||
		window.msCancelAnimationFrame||
		function (handler) { window.clearTimeout(handler); },
	//动画执行一次后销毁
	one:function(el,aniname){
		var animExpr=new RegExp("\\s{0,}"+aniname,"g");
		if(el.className.match(animExpr)){
			el.className=el.className.replace(animExpr,"");
		}
		el.className+=" "+aniname;
		if(!el.hasEndEvent){
			el.addEventListener("webkitAnimationEnd",function(e){
				el.className=el.className.replace(animExpr,"");
			},false);
			el.hasEndEvent=true;
		}
	},
	//setInterval帧率测试
	testSiFps:function(callback){
    	var fps=0;
    	var si=setInterval(function(){
    		fps++;
    	},1);
    	setTimeout(function(){
    		//alert("setInterval帧率："+fps);
    		if(callback){
    			callback(fps);
    		}
			clearInterval(si);
		},1000);
	},
	//requestAnimationFrame帧率测试
	testRafFps:function(callback){
    	var fps=0;
    	function fpstest(timestamp){
    		fps++;
    		var raf=requestAnimationFrame(fpstest);
    		if(timestamp>=1000){
    			if(callback){
	    			callback(fps);
	    		}
    			cancelAnimationFrame(raf);
    		}
    	}
    	requestAnimationFrame(fpstest);
	}
};

//BaiduMap
(function(window,document,undefined){
	
	window.BaiduMap=function(container,params){
		/*=========================
          Params
          ===========================*/
        var defaults={
        	//定义弹出框样式
			"infoWindowStyle":{
				width:250,
				height:120,
				title:"<h4 style='margin:0 0 5px 0;padding:0.2em 0'>最新签到</h4>",
				enableMessage:true,
				offset:new BMap.Size(0, -20)
			},
			//自定义标记图标
			"markerIcon":null,
			//自定义标记label样式
			"labelStyle":{
				display:"block",
				position:"relative",
				width:"30px",
				height:"30px",
				borderRadius:"50% 50% 50% 0",
				webkitTransform:"rotate(-45deg)",
				webkitTransformOrigin:"center",
				border:"none",
				margin:"-12px 0 0 -7px"
			},
		}
		params=params||{};
		for(var def in defaults){
			if(params[def]===undefined){
				params[def]=defaults[def];
			}
		}
		//Map
		var s=this;
		//Params
		s.params = params;
		//初始化地图控件
		s.map = new BMap.Map(container);
		s.container=document.querySelector("#"+container);
		
		/*=========================
          Method
          ===========================*/
        //标记点击，打开infowWindow
        function addClickHandler(content,marker){
			marker.addEventListener("click",function(e){
				openInfo(content,e)}
			);
		}
		//打开infowWindow
		function openInfo(content,e){
			var p = e.target;
			var point = new BMap.Point(p.getPosition().lng, p.getPosition().lat);
			var infoWindow = new BMap.InfoWindow(content,s.params.infoWindowStyle);  // 创建信息窗口对象 
			s.map.openInfoWindow(infoWindow,point); //开启信息窗口
		}
		//显示地图标记
		s.show=function(markerData){
			s.map.clearOverlays();
			if(!markerData){
				s.map.centerAndZoom("南京", 15);
				return;
			}
			if(arguments.length===2){
				s.map.centerAndZoom(new BMap.Point(arguments[0],arguments[1]), 15);
				return;
			}
			//显示区域
			s.map.centerAndZoom(new BMap.Point(markerData[0][0],markerData[0][1]), 15);
			for(var i=0;i<markerData.length;i++){
				//添加label对象
				if(s.params.labelStyle){
					var myLabel=new BMap.Label(markerData[i][3]);
					s.params.labelStyle.backgroundColor=markerData[i][4];
					myLabel.setStyle(s.params.labelStyle);
				}
				//添加描点
				var marker = new BMap.Marker(new BMap.Point(markerData[i][0],markerData[i][1]));
				if(s.params.markerIcon)marker.setIcon(s.params.markerIcon);
				marker.setLabel(myLabel);
				var content = markerData[i][2];
				s.map.addOverlay(marker);
				//添加点击
				addClickHandler(content,marker);
			}
		}
		//获得gps位置信息
		s.gps=function(featureHandler,feature){
			var geolocation = new BMap.Geolocation();
			geolocation.getCurrentPosition(function(pos){
				if(this.getStatus() == BMAP_STATUS_SUCCESS){
					var point=pos.point,y=point.lng,x=point.lat;
					//这里是坐标point
					if(feature && feature==="point"){
						featureHandler(point);
						return;
					}
					//根据point得到地址
					var gpsPlace = new BMap.Geocoder();
					gpsPlace.getLocation(point, function(result){      
						if (result){
							//执行传入的回调函数
							featureHandler(point,result.address);
						}else{
							alert("获取地址失败"+this.getStatus());
						}
					});
				}else {
					alert("获取坐标失败"+this.getStatus());
				}
			},{enableHighAccuracy: true});
		}
		//根据坐标获得地址
		s.place=function(point,featureHandler){
			alert(point);
			//根据point得到地址
			var gpsPlace = new BMap.Geocoder();
			gpsPlace.getLocation(point, function(result){      
				if (result){
					//执行传入的回调函数
					if(feature && feature==="place"){
						featureHandler(result.address);
					}
				}
			});
		}
		//一键导航
		s.mapGuide=function(guideopts){
			var lng=guideopts.point.lng;
			var lat=guideopts.point.lat;
			var title=guideopts.title;
			var content=guideopts.content;
			window.location.href='http://api.map.baidu.com/marker?location='+lat+','+lng+'&title='+title+'&content='+content+'&output=html';
		}

		//返回地址截图
		s.mapImg=function(mapImgOpt){
			var lng=mapImgOpt.point.lng;
			var lat=mapImgOpt.point.lat;
			var title=mapImgOpt.title;
			var content=mapImgOpt.content;
			var width=mapImgOpt.width;
			var height=mapImgOpt.height;
			
			var imgSrc="http://api.map.baidu.com/staticimage?width="+width+"&height="+height+"&center="+lng+","+lat+"&markers="+lng+","+lat+"&scale=1&zoom=15&markerStyles=-1,http://api.map.baidu.com/images/marker_red.png";
			return imgSrc;
		}
	};
})(window,document,undefined);

//DateUtil
Date.prototype.year=function(){
	return this.getFullYear();
}
Date.prototype.month=function(){
	return this.getMonth()+1;
}
Date.prototype.day=function(){
	return this.getDate();
}
Date.prototype.hour=function(){
	return this.getHours();
}
Date.prototype.minute=function(){
	return this.getMinutes();
}
Date.prototype.seconds=function(){
	return this.getSeconds();
}
Date.prototype.quarter=function(){//第几季
	return Math.floor((this.getMonth()+3)/3);
}
Date.prototype.milliseconds=function(){//获得时间的毫秒
	return this.getMilliseconds();
}
Date.prototype.date=function(){//yy-HH-dd
	return this.getFullYear()+"-"+this.month()+"-"+this.day();
}
Date.prototype.time=function(){//hh:mm
	return this.hour()+":"+this.minute();
}
Date.prototype.datetime=function(){//yy-HH-dd hh:mm
	return this.date()+" "+this.time();
}
Date.prototype.fulldatetime=function(){//yy-HH-dd hh:mm:ss
	return this.datetime()+":"+this.getSeconds();
}
Date.prototype.timestamp=function(){//获得现在距1970-1-1的毫秒数
	return this.getTime();
}
Date.prototype.days=function(year,month){//返回当月共多少天
	if(month && year){
		return new Date(year,month,0).getDate();
	}
	return new Date(this.year(),this.month(),0).getDate();
}
Date.prototype.diff=function(date1,date2){
	var dateStart=new Date(date1);//开始时间
	var dateEnd=new Date(date2);//结束时间
	var dateDiffTime=dateStart.getTime()-dateEnd.getTime(); //时间差秒
	//计算出相差天数
	var daysDiff=Math.floor(dateDiffTime/(24*3600*1000));

	//计算出小时数
	var leave1=dateDiffTime%(24*3600*1000); //计算天数后剩余的毫秒数
	var hoursDiff=Math.floor(leave1/(3600*1000));

	//计算相差分钟数
	var leave2=leave1%(3600*1000); //计算小时数后剩余的毫秒数
	var minutesDiff=Math.floor(leave2/(60*1000));

	//计算相差秒数
	var leave3=leave2%(60*1000); //计算分钟数后剩余的毫秒数
	var secondsDiff=Math.round(leave3/1000);

	return daysDiff+" "+hoursDiff+" "+minutesDiff+" "+secondsDiff;
}
Date.prototype.minusday=function(num){
	var numTimestamp=num*1000*60*60*24;
	var newdate=new Date();
	newdate.setTime(newdate.getTime()-numTimestamp);
	return newdate.year()+"-"+newdate.month()+"-"+newdate.day();
}
Date.prototype.plusday=function(num){
	var numTimestamp=num*1000*60*60*24;
	var newdate=new Date();
	newdate.setTime(newdate.getTime()+numTimestamp);
	return newdate.year()+"-"+newdate.month()+"-"+newdate.day();
}
Date.prototype.expires=function(cacheTime){//时效性
	if(!cacheTime)return;
	//如果参数是小时
	if(!isNaN(cacheTime)){
		var numTimestamp=cacheTime*1000*60*60;
		var newDate=new Date(this.getTime()+numTimestamp);
		return newDate;
	}

	//如果参数是今天
	if(cacheTime==="today"){
		return new Date(this.plusday(1)+" 00:00:00");
	}

	//如果参数是日期yyyy-MM-dd
	return new Date(cacheTime);
}
Date.prototype.format=function(fmtDate,fmtType){//格式化日期yyyy-MM-dd hh:mm:ss
	var fmt="yyyy-MM-dd hh:mm:ss";
	if(fmtType){
		fmt=fmtType;
	}
	var y,M,d,h,m,s;
	
	if(fmtDate instanceof Date == true){
		y=fmtDate.getFullYear();
		M=fmtDate.getMonth() + 1;
		d=fmtDate.getDate();
		h=fmtDate.getHours();
		m=fmtDate.getMinutes();
		s=fmtDate.getSeconds();
	}
	//如果不是Date对象,就用另一种方法处理
	else{
		//匹配年月日yyyy-MM-dd或者yyyy.mm.dd或者yyyy/mm/dd
		var dateExpr=/([1-2][0-9][0-9][0-9])[\.\/-](0?[[1-9]|1[0-2])[\.\/-]([1-3][0-9]|0?[0-9])/
		var dateMatch=dateExpr.exec(fmtDate);
		if(!dateMatch || isNaN(dateMatch[1])  && isNaN(dateMatch[2]) && isNaN(dateMatch[3])){
			alert("您所要格式化的时期格式不正确");
			return;
		}
		y=dateMatch[1];
		M=dateMatch[2];
		d=dateMatch[3];
		h="00";
		m="00";
		s="00";
		
		//匹配时分hh:mm
		var timeExpr=/(0?[0-9]|[1-2][0-9]):([1-6][0-9]|0?[0-9])/
		var timeMatch=timeExpr.exec(fmtDate);
		if(timeMatch){
			h=timeMatch[1]?timeMatch[1]:"00";
			m=timeMatch[2]?timeMatch[2]:"00";
			s="00";
		}
		
		//匹配时分hh:mm:ss
		var tExpr=/(\d{2}|\d{1}):(\d{2}|\d{1}):(\d{2}|\d{1})/
		var tMatch=tExpr.exec(fmtDate);
		if(tMatch){
			h=tMatch[1]?tMatch[1]:"00";
			m=tMatch[2]?tMatch[2]:"00";
			s=tMatch[3]?tMatch[3]:"00";
		}
	}
	
	var dateExprs={
		"M+" :M,   
		"d+" :d,  
		"h+" :h,   
		"m+" :m,  
		"s+" :s
	};
	if(/(y+)/.test(fmt)){
		fmt=fmt.replace(RegExp.$1, (y+"").substr(4 - RegExp.$1.length));
	}
	for(var k in dateExprs){
		//"("+ k +")"=(M+)、(d+)、(h+)...
		if(new RegExp("("+ k +")").test(fmt)){
			fmt = fmt.replace(RegExp.$1, (RegExp.$1.length==1) ? (dateExprs[k]) : (("00"+ dateExprs[k]).substr((""+ dateExprs[k]).length)));   
		}
	}
	return fmt;
}

//DB 本地数据库
var DB=(function(){
    function checkManifest() {
        window.addEventListener("updateready", function(e) {
            console.log("离线缓存状态：" + window.applicationCache.status);
            if (window.applicationCache.status == window.applicationCache.UPDATEREADY) {
                window.applicationCache.swapCache();
                if (confirm('发现此manifest文件有更新，是否更新？')) {
                    window.location.reload();
                }
            } else {
                console.log('manifest文件没有变化');
            }
        }, false);
    }

    function setCookie(key, value) {
        var Days = 30;
        var exp = new Date();
        exp.setTime(exp.getTime() + Days * 24 * 60 * 60 * 1000);
        document.cookie = key + "=" + escape(value) + ";expires=" + exp.toGMTString();
    }

    function getCookie(key) {
        var valExpr = new RegExp("(^| )" + key + "=([^;]*)(;|$)");
        var match = valExpr.exec(document.cookie);
        if (match && match[2]) {
            return unescape(match[2]);
        }
        return null;
    }

    function delCookie(key) {
        var exp = new Date();
        exp.setTime(exp.getTime() - 1);
        var val = getCookie(key);
        if (val != null) {
            document.cookie = key + "=" + val + ";expires=" + exp.toGMTString();
        }
    }

    var store = window.localStorage;
    var session = window.sessionStorage;
    if (!store) {
        doc.style.behavior = 'url(#default#userData)'; //保存表单的值
        //console.log("您当前的设备不支持本地数据库localstore");
    }
    return {
        //application cache
        checkManifest: checkManifest,
        /**
         * 保存数据
         * 
         * @method set
         * @param key //键
         * @param val //值
         * @return void
         */
        set: function(key, val) {
            if (store) {
                store.setItem(key, val);
            } else {
                setCookie(key, val);
            }
        },
        /**
         * 保存数据
         * 
         * @method get
         * @param key //键
         * @return string //返回您所存储的值
         */
        get: function(key) {
            if (store) {
                if (typeof key == "number") {
                    return store.key(key);
                }
                return store.getItem(key);
            } else {
                return getCookie(key);
            }
        },
        /**
         * 删除数据
         * 
         * @method del
         * @param key //根据键删除此项
         */
        del: function(key) {
            if (store) {
                store.removeItem(key);
            } else {
                delCookie(key);
            }
        },
        /**
         * 清空数据
         * 
         * @method clear
         * @return void
         */
        clear: function() {
            if (store) {
                return store.clear();
            } else {
                alert("抱歉，cookie不可以全部清空!");
            }
        },

        setSession: function(key, value) {
            session.setItem(key, value);
        },
        getSession: function(key) {
            if (typeof key == "number") {
                return session.key(key);
            }
            return session.getItem(key);
        },
        delSession: function(key) {
            session.removeItem(key);
        },
        clearSession: function() {
            session.clear();
        },
        /**
         * 根据请求名称获取值
         * 
         * @method getParameter
         * @param argName //参数名称
         * @return string
         */
        getParameter: function(argName){
            var param = location.search.match(new RegExp("[\?\&]" + argName + "=([^\&]*)(\&?)","i"));
            return param ? param[1] : param;
        }
    };
})();

//Shake 摇一摇
(function(window,document,undefined){
	window.Shake=function(params){
		/*=========================
          Params
          ===========================*/
		var defaults={
			"shakeThreshold":3000,
			/*callbacks
			onShook:function(Slider)
			*/
		}
		params=params||{};
		for(var def in defaults){
			if(params[def]===undefined){
				params[def]=defaults[def];
			}
		}
		//Shake
		var s=this;
		s.params=params;
		var lastUpdate=0;//设置最后更新时间，用于对比
		var curShakeX=curShakeY=curShakeZ=lastShakeX=lastShakeY=lastShakeZ=0;
		/*=========================
          Handler
          ===========================*/
		function deviceMotionHandler(e) {
			var acceleration =e.accelerationIncludingGravity;//获得重力加速
			var curTime = new Date().getTime();//获得当前时间戳
			if ((curTime - lastUpdate)> 100) {
				var diffTime = curTime -lastUpdate;//时间差
					lastUpdate = curTime;
				curShakeX = acceleration.x;//x轴加速度
				curShakeY = acceleration.y;//y轴加速度
				curShakeZ = acceleration.z;//z轴加速度
				var speed = Math.abs(curShakeX + curShakeY + curShakeZ - lastShakeX - lastShakeY - lastShakeZ) / diffTime * 10000;
				if (speed > s.params.shakeThreshold) {
					if(s.params.onShook)s.params.onShook(s);
				}
				lastShakeX = curShakeX;
				lastShakeY = curShakeY;
				lastShakeZ = curShakeZ;
			}
		}
		if (window.DeviceMotionEvent) {
			window.addEventListener('devicemotion', deviceMotionHandler, false);
		}else{
			console.log('您好，你目前所用的设备好像不支持重力感应哦！');
		}
	}
})(window,document,undefined);

//Dragrefresh 下拉刷新
(function(window,document,undefined){
	window.Dragrefresh=function(container,params){
		/*==================
		  Model
		  ==================*/
		var defaults={
			"minScrollTop":0,
			"refreshThreshold":100,
			"refreshThresholdMax":100,
			"refreshHideTop":0,
			"duration":150,
			"timeout":5000,

			"bottomContainerClass":"loading-more",
			"bottomContainerLoadingClass":"loading",

			/*callbacks
			onRefreshStart:function(Dragrefresh)
			onRefreshEnd:function(Dragrefresh)
			onRefreshTimeout:function(Dragrefresh)
			*/
		}
		params=params||{};
		for(var def in defaults){
			if(params[def]===undefined){
				params[def]=defaults[def];
			}
		}
		var s=this;
		s.params=params;
		//最大拉动值
		s.params.refreshThresholdMax=s.params.refreshThreshold+s.params.refreshThresholdMax;
		//Container
		s.container=typeof container=="string"?document.querySelector(container):container;
		//创建DOM
		s.createRefresh=function(){
			if(s.topContainer)return;
			s.topContainer=document.createElement("div");
			s.topContainer.setAttribute("class","dragrefresh box box-middlecenter");
			var iconSvg='<svg width="1000.6px" height="1000.6px" viewBox="0 0 1000.6 1000.6" xml:space="preserve">'+
						'<path d="M867.4,456.1c-24.1,0-43.8,19.7-43.8,43.8c0,1.5,0.1,3.1,0.3,4.6c-2.2,176.4-147.1,319.6-323.7,319.6 c-178.5,0-323.8-145.3-323.8-323.8s145.3-323.8,323.8-323.8c62.8,0,122.8,17.7,174.4,50.8l-29,52.2c0,0,138.4,2.2,149.2,2.4 c10.8,0.2,14.6-5.6,14.6-5.6s5.1-5.8,2.4-15.5c-2.6-9.7-43.2-162.2-43.2-162.2l-38.5,61.1c-67.3-45.7-146.7-70.1-229.8-70.1 c-226.6,0-411,184.4-411,411s184.4,411,411,411c225.8,0,410.1-183.7,410.9-407.3l0.2-4.2C911.2,475.7,891.6,456.1,867.4,456.1z"/>'+
						'</svg>';
			s.topContainer.innerHTML=iconSvg;
			s.container.appendChild(s.topContainer);
		};
		s.createRefresh();
		s.bottomContainer=null;
		s.createBottomContainer=function(){
			s.bottomContainer=s.container.querySelector("."+s.params.bottomContainerClass);
			if(!s.bottomContainer){
				s.bottomContainer=document.createElement("div");
				s.bottomContainer.setAttribute("class",s.params.bottomContainerClass);
				var spinnerdiv=document.createElement("div");
				spinnerdiv.setAttribute("class",s.params.bottomContainerLoadingClass);
				s.bottomContainer.appendChild(spinnerdiv);
				s.container.appendChild(s.bottomContainer);
			}
		}
		if(s.params.onBottom)s.createBottomContainer();

		/*==================
		  Mothod
		  ==================*/
		//添加动画
		s.addTransition=function(duration){
			if(!duration)duration=s.params.duration;
			s.topContainer.style.webkitTransitionDuration=duration+"ms";
		};
		//移除动画
		s.removeTransition=function(){
			s.topContainer.style.webkitTransitionDuration="0ms";
		};
		//变形
		s.transform=function(y,deg){
			if(!y)y=s.touches.posY;
			if(!deg)deg=s.touches.rotateDeg;
			s.topContainer.style.WebkitTransform='translate3d(0,' + y + 'px,0) rotate(' + deg + 'deg)';
		}
		//旋转,10W毫秒，旋转4万6千度
		s.spinner=function(){
			s.addTransition("100000");
			s.transform(null,"46000");
		};
		s.cancelSpinner=function(){
			s.removeTransition();
			s.transform(null,"0");
		};
		//隐藏
		s.hide=function(){
			//停止旋转
			s.cancelSpinner();
			//收起
			s.addTransition();
			s.touches.posY=s.params.refreshHideTop;
			s.transform(s.touches.posY,s.touches.rotateDeg);

			s.showed=false;
		};
		s.showed=false;
		//显示
		s.show=function(){
			//收到指定位置
			s.addTransition();
			s.touches.posY=s.params.refreshThreshold;
			s.transform(s.touches.posY);

			s.showed=true;
			//开始旋转
			/*setTimeout(function(){
				alert("开始旋转");
				s.spinner();
			}, s.params.duration);*/
		}

		//Callback 刷新中
		s.refresh=function(){
			s.show();
			//callback onRefreshStart
			if(s.params.onRefreshStart){
				s.params.onRefreshStart(s);
			}
			//callback 超时
			if(s.params.onRefreshTimeout){
				s.timeout=setTimeout(function(){
					s.params.onRefreshTimeout(s);
				}, s.params.timeout);
			}
		};
		//Callback 刷新完成
		s.refreshComplete=function(){
			//清除超时
			if(s.timeout)window.clearTimeout(s.timeout);
			//收起
			s.hide();
			//callback 刷新结束
			if(s.params.onRefreshEnd){
				s.params.onRefreshEnd(s);
			}
			//重新绑定事件
			if(s.isAttached==false)s.attach();
		}
		//Callback 刷新超时
		s.refreshTimeout=function(){
			s.hide();
			s.params.onRefreshTimeout(s);
			//重新绑定事件
			if(s.isAttached==false)s.attach();
		};

		/*==================
		  Controller
		  ==================*/
		s.isAttached=true;
		//结束时需要取消绑定的事件
		s.events=function(detach){
			var touchTarget=s.container;
			var action=detach?"removeEventListener":"addEventListener";
			touchTarget[action]("touchstart",s.onTouchStart,false);
			touchTarget[action]("touchmove",s.onTouchMove,false);
			touchTarget[action]("touchend",s.onTouchEnd,false);
			touchTarget[action]("touchcancel",s.onTouchEnd,false);
		}
		//一直监听的事件
		s.finalEvents=function(detach){
			//头部动画事件
			var action=detach?"removeEventListener":"addEventListener";
			s.topContainer[action]("webkitTransitionEnd",s.onTransitionEnd,false);
			//绑定底部事件
			if(s.bottomContainer)s.container[action]("scroll",s.onScroll,false);
		}
		//attach、detach事件
		s.attach=function(){
			s.isAttached=true;
			s.events();
		};
		s.detach=function(){
			s.isAttached=false;
			s.events(true);
		};

		//Touch信息
        s.touches={
        	direction:null,
        	isTop:true,
        	startX:0,
        	startY:0,
        	currentX:0,
        	currentY:0,
        	endX:0,
        	endY:0,
        	diffX:0,
        	diffY:0,
        	posY:0,
        	rotateDeg:0
        };
        s.preventDefault=function(e){
			e.preventDefault();
		}
		s.onTouchStart=function(e){
			s.container.addEventListener("touchmove",s.preventDefault,false);
			//如果不在顶部，则不触发
			if(s.container.scrollTop>s.params.minScrollTop)s.touches.isTop=false;
			else s.touches.isTop=true;
			s.removeTransition();
			s.touches.startX=e.touches[0].clientX;
			s.touches.startY=e.touches[0].clientY;
		};
		
		s.onTouchMove=function(e){
			s.touches.currentX=e.touches[0].clientX;
			s.touches.currentY=e.touches[0].clientY;
			s.touches.diffY=s.touches.currentY-s.touches.startY;
			s.touches.diffX=s.touches.startX-s.touches.currentX;
			//设置滑动方向
			if(s.touches.direction==null){
				s.touches.direction=s.touches.diffY<0?"down":"up";
			}
			//不能下拉刷新
			if(s.touches.direction=="down" || !s.touches.isTop){
				s.container.removeEventListener("touchmove",s.preventDefault,false);	
				return;
			}
			//下拉刷新
			s.touches.posY=s.params.refreshHideTop+s.touches.diffY;
			if(s.touches.posY<s.params.refreshThresholdMax){
				s.touches.rotateDeg=s.touches.posY*2;
				s.transform(s.touches.posY,s.touches.rotateDeg);
			}
		};
		s.onTouchEnd=function(e){
			s.container.removeEventListener("touchmove",s.preventDefault,false);

			s.touches.direction=null;
			//如果小于hold值，则收起刷新
			if(s.touches.posY<s.params.refreshThreshold){
				s.hide();
				return;
			}
			//刷新
			s.refresh();
			//移动事件绑定，否则会在刷新过程中重新触发下拉刷新
			s.detach();
		};
		s.onTransitionEnd=function(e){
			if(s.showed==true){
				s.spinner();
			}
		}
		s.onScroll=function(e){
			if (this.scrollTop + this.clientHeight >= this.scrollHeight){
                s.params.onBottom(s);
            }
		}
		//主函数
		s.init=function(){
			s.attach();
			s.finalEvents();
		};

		s.init();
	};
})(window,document,undefined);

//Emoji 表情管理
(function(window,document,undefined){
	window.Emoji={
		icons:{
			"[微笑]":"[weixiao]",
			"[难过]":"[nanguo]",
			"[色]":"[se]",
			"[发呆]":"[fadai]",
			"[酷]":"[cool]",
			"[大哭]":"[daku]",
			"[害羞]":"[haixiu]",

			"[闭嘴]":"[bizui]",
			"[睡觉]":"[shuijiao]",
			"[哭]":"[ku]",
			"[流汗]":"[liuhan]",
			"[发怒]":"[fanu]",
			"[眨眼]":"[zhayan]",
			"[龇牙]":"[ziya]",

			"[惊讶]":"[jingya]",
			"[傲慢]":"[aoman]",
			"[得意]":"[deyi]",
			"[可怜]":"[kelian]",
			"[拜拜]":"[baibai]",
			"[开心]":"[kaixin]",
			"[呕吐]":"[outu]",
			"[奋斗]":"[fendou]",
			"[坏笑]":"[huaixiao]",
			"[尴尬]":"[ganga]",
			"[惊吓]":"[jingxia]",
			"[打哈欠]":"[dahaqian]",
			"[白眼]":"[baiyan]",
			"[鄙视]":"[bishi]",

			"[抽烟]":"[chouyan]",
			"[敲头]":"[qiaotou]",
			"[亲亲]":"[qingqing]",
			"[恭喜]":"[gongxi]",
			"[奸笑]":"[jianxiao]",
			"[骂人]":"[maren]",
			"[糗]":"[qiu]",

			"[伤心]":"[shangxin]",
			"[受委屈]":"[shouweiqu]",
			"[偷笑]":"[touxiao]",
			"[挖鼻孔]":"[wabikong]",
			"[委屈]":"[weiqu]",
			"[问]":"[wen]",
			"[擦汗]":"[cahan]",
			"[左哼哼]":"[zuohengheng]",
			"[右哼哼]":"[youhengheng]",
			"[晕]":"[yun]",
			"[大笑]":"[daxiao]",
			"[吓]":"[xia]",
			"[困]":"[kun]",
			"[嘘]":"[xu]",

			"[加油]":"[jiayou]",
			"[强]":"[qiang]",
			"[我爱你]":"[iloveyou]",
			"[差劲]":"[chajin]",
			"[No]":"[no]",
			"[Ok]":"[ok]",
			"[弱]":"[ruo]",

			"[抱拳]":"[baoquan]",
			"[握手]":"[woshou]",
			"[Yeah]":"[yeah]",
			"[来]":"[lai]",
			"[猪头]":"[zhutou]",
			"[心]":"[xin]",
			"[心碎]":"[xinsui]",
			"[抱抱]":"[baobao]",
			"[红唇]":"[hongchun]",
			"[菜刀]":"[caidao]",
			"[太阳]":"[taiyang]",
			"[夜晚]":"[yewan]",
			"[骷髅]":"[kulou]",
			"[花谢了]":"[huaxiele]",

			"[蛋糕]":"[dangao]",
			"[咖啡]":"[kafei]",
			"[足球]":"[zuqiu]",
			"[骷髅]":"[kulou]",
			"[西瓜]":"[xigua]",
			"[炸弹]":"[zhadan]",
			"[篮球]":"[lanqiu]",

			"[礼物]":"[liwu]",
			"[大便]":"[dabian]",
			"[玫瑰]":"[meigui]",
			"[米饭]":"[mifan]",
			"[瓢虫]":"[piaochong]",
			"[啤酒]":"[pijiu]",
			"[闪电]":"[shandian]",
		},
		parse:function(str){
			var emojiExpr=/(\[[\u4E00-\u9FA5]*\])/gm;
			var result,parseStr=str;
			while (emojiExpr.exec(str))  {
				if(this.icons[RegExp.$1]){
					parseStr=parseStr.replace(RegExp.$1,"<span data-emoji=\""+this.icons[RegExp.$1]+"\"></span>");
				}
			}
			return parseStr;
		}
	}
})(window,document,undefined);

//Form
(function(window,document,undefined){
	window.Form=function(container){
		/*================
		Model
		================*/
		var s=this;
		s.container=typeof container=="string"?document.querySelector(container):container;
		//s.container=document.querySelector(container);
		s.formElements=[];//表单元素
		s.getFormElements=function(){
			//获取有效的表单元素
			for(var i=0;i<s.container.elements.length;i++){
				var field=s.container.elements[i];
				//过滤没有name的表单元素
				if(!field.type || !field.name){
					continue;
				}
				//过滤button、reset、submit
				if(field.type=="button" || field.type=="reset" || field.type=="submit"){
					continue;
				}
				//过滤未选中的checkbox和radio
				if(field.type=="radio" || field.type=="checkbox"){
					if(!field.checked){
						continue;
					}
				}
				//push到数组里
				s.formElements.push(field);
			}
		};
		s.getFormElements();
		//添加formElements对象
		s.pushElement=function(el){
			s.formElements.push(el);
		};
		/*================
		Method
		================*/
		//表单Json化
		s.serializeArray=function(){
			var parts=[],field=null;
			for(var i=0;i<s.formElements.length;i++){
				field=s.formElements[i];
				//如果是多选框，则每个值单独一个条目
				if(field.type=="select-one" || field.type=="select-multiple"){
					for(var j=0;j<field.options.length;j++){
						var option=field.options[j];
						if(option.selected){
							parts.push(field.name+"="+field.value);
						}
					}
				}else{
					//push到数组里
					parts.push(field.name+"="+field.value);
				}
			}
			return parts;
		};
		//表单序列化
		s.serialize=function(){
			//序列化
			var parts=s.serializeArray();
			//获得字符串
			return parts.join("&");
		};
		//单个元素验证
		s.safelvl=0;//密码安全等级
		var ruleExpr={
			"required":/.+/,//不能为空
			"username":/^[\w]*$/,//只能包括字母、数字和下划线
			"password":/^[0-9_a-zA-Z-~!@#$]*$/,//密码格式不正确
			"mail":/^(\w+@\w+\.[\.\w]+)?$/,//邮箱格式不正确
			"phone":/^([1][34578][0-9]{9})?$/,//手机号码输入不正确
			"chinese":/^[\u4E00-\u9FA5]*$/,//只能填写中文
			"specialchar":/^([\u4e00-\u9fa5]*|[a-zA-Z0-9]*)$///不能为特殊字符
		}
		s.rule=function(field){
			var ruleField=field.getAttribute("data-rule-field")||"";
			var rule=field.getAttribute("data-rule").split(" ");
			var value=field.value||"";
			var errorMsg=null;
			for(var i=0,rulename;rulename=rule[i++];){
				if(ruleExpr[rulename]){//正则验证
					if(!ruleExpr[rulename].test(value)){
						errorMsg=ruleField+lang.rule[rulename];
						break;
					}
				}
				if(value.length<=0){//如果为空
					break;
				}
				if(rulename.indexOf("minlength")>=0){
					var minlength=rulename.split(":")[1];
					if(value.length<minlength){
						errorMsg=ruleField+lang.rule.minlength+ minlength +lang.rule.unit;
						break;
					}
				}else if(rulename.indexOf("maxlength")>=0){
					var maxlength=rulename.split(":")[1];
					if(value.length>maxlength){
						errorMsg=ruleField+lang.rule.maxlength+ maxlength +lang.rule.unit+"，超出"+eval(value.length-maxlength)+lang.rule.unit;
						break;
					}
				}else if(rulename.indexOf("number")>=0){
					if(!Number(value)){
						errorMsg=ruleField+lang.rule.number;
						break;
					}
				}else if(rulename.indexOf("minnumber")>=0){
					var minnumber=rulename.split(":")[1];
					if(Number(value)<Number(minnumber)){
						errorMsg=ruleField+lang.rule.minnumber+minnumber;
						break;
					}
				}else if(rulename.indexOf("maxnumber")>=0){
					var maxnumber=rulename.split(":")[1];
					if(Number(value)>Number(maxnumber)){
						errorMsg=ruleField+lang.rule.maxnumber+maxnumber;
						break;
					}
				}else if(rulename.indexOf("compare")>=0){
					var compareElem=document.getElementsByName(rulename.split(":")[1])[0];
					
					if(compareElem && compareElem.value && compareElem.value!=value){
						errorMsg=lang.rule.twice+ruleField+lang.rule.compare;
						break;
					}
				}else if(rulename=="safelvl"){
					if(s.safelvl<2){
						errorMsg=ruleField+lang.rule[rulename];
						break;
					}
				}
			}
			return errorMsg;
		};
		//表单验证
		var t=new Toast("格式不正确");
		s.validate=function(fn){
			for(var i=0,field;field=s.formElements[i++];){
				if(!field.getAttribute("data-rule")){
					continue;
				}
				var errormsg=s.rule(field);
				if(errormsg){
					if(fn){
						s.field=field;
						s.errormsg=errormsg;
						fn(s);
					}else{
						t.setText(errormsg);
						t.show();
					}
					//field.focus();
					return false;
				}
			}
			return true;
		};
		//字符类型
	    s.charMode=function(iN){
	        if (iN>=48 && iN <=57) //数字    
	            return 1;
	        if (iN>=65 && iN <=90) //大写    
	            return 2;
	        if (iN>=97 && iN <=122) //小写    
	            return 4;
	        else
	            return 8;
	    }
	    //计算密码模式
	    s.pwdLvl=function(num){
	        var lvl=0;
	        for (var i=0;i<4;i++){
	            if (num & 1) lvl++;
	            num>>>=1;
	        }
	        return lvl;
	    }
		//密码强度检测
		s.checkSafe=function(pwdField,lvlField){
	    	var val=pwdField.value;
	    	if(val.length<=0){
        		lvlField.className=lvlField.className.replace(/lvl[0-3]/,"lvl0");
        		return;
        	}
	        var mode=0;
	        for (var i=0;i<val.length;i++){
	            mode|=s.charMode(val.charCodeAt(i));
	        }
	        s.safelvl=s.pwdLvl(mode);
	        if(lvlField){
	        	lvlField.className=lvlField.className.replace(/lvl[0-3]/,"lvl"+s.safelvl);
	        }
	    };
	    /*================
		Controller
		================*/
		s.events=function(detach){
			var action=detach?"removeEventListener":"addEventListener";
			//开关控件
			var switches=document.querySelectorAll(".switch");
			
			for(var i=0,swi;swi=switches[i++];){
				swi[action]("click",s.onSwitch,false);
			}
			//密码小眼睛
			var reveals=document.querySelectorAll("[data-input=reveal] [type=password] + i");
			for(var j=0,reveal;reveal=reveals[j++];){
				reveal[action]("click",s.onReveal,false);
			}
			//清除按钮框
			var clears=document.querySelectorAll("[data-input=clear] input");
			var clearIcons=document.querySelectorAll("[data-input=clear] input+i");
			for(var k=0;k<clears.length;k++){
				clears[k][action]("input",s.onClear,false);
				clearIcons[k][action]("click",s.onClearIcon,false);
			}
			//安全检测框
			var safes=document.querySelectorAll(".safelvl");
			for(var l=0,safe;safe=safes[l++];){
				var safeInput=safe.parentNode.querySelector("input[type]");
				safeInput[action]("input",s.onSafeLvl,false);
			}
			//拖动条
			var ranges=document.querySelectorAll(".tooltip+input[type=range]");
			for(var m=0,range;range=ranges[m++];){
				range[action]("touchstart",s.onRangeStart,false);
				range[action]("touchmove",s.onRangeMove,false);
				range[action]("input",s.onRangeMove,false);
				range[action]("touchend",s.onRangeEnd,false);
			}
			//数字框
			var numboxs=document.querySelectorAll(".numbox input[type=number]");
			for(var n=0,numbox;numbox=numboxs[n++];){
				numbox.nextElementSibling[action]("click",s.onNumboxPlus,false);
				numbox.previousElementSibling[action]("click",s.onNumboxMinus,false);
			}
		}
		s.hasEvents=false;
		s.attach=function(event){
			if(!s.hasEvents)s.events();
		}
		s.detach=function(event){
			s.events(true);
		}
		//开关控件
		s.createHiddenInput=function(name){
			var hiddenInput=document.createElement("input");
			hiddenInput.setAttribute("type","hidden");
			if(name)hiddenInput.setAttribute("name",name);
			return hiddenInput;
		}
		s.onSwitch=function(e){
			var parentNode=this.parentNode;
			var name=this.getAttribute("data-name");
			var onVal=this.getAttribute("data-on-value");
			var offVal=this.getAttribute("data-off-value");
			var hiddenInput=this.nextElementSibling;
			if(hiddenInput && (!hiddenInput.type || hiddenInput.type!="hidden"))hiddenInput=null;
			if(name && !hiddenInput){
				hiddenInput=s.createHiddenInput(name);
				parentNode.insertBefore(hiddenInput,this.nextSibling);
			}
			if(this.classList.contains("active")){
				this.classList.remove("active");
				if(hiddenInput)hiddenInput.value=offVal;
			}else{
				this.classList.add("active");
				if(hiddenInput)hiddenInput.value=onVal;
			}
		}
		//密码小眼睛
		s.onReveal=function(e){
			var pwdInput=this.parentNode.querySelector("input[type]");
			if(this.classList.contains("active")){
				this.classList.remove("active");
				pwdInput.type="password";
			}else{
				this.classList.add("active");
				pwdInput.type="text";
			}
			pwdInput.focus();
		}
		//清除按钮框
		s.onClear=function(e){
			var clearIcon=this.nextElementSibling;
			if(!clearIcon || clearIcon.tagName!="I")return;
			if(this.value.length>0){
				clearIcon.style.display="block";
			}else{
				clearIcon.style.display="none";
			}
		}
		s.onClearIcon=function(e){
			var txtInput=this.parentNode.querySelector("input[type]");
			this.style.display="none";
			txtInput.value="";
			txtInput.focus();
		}
		//安全检测框
		s.onSafeLvl=function(e){
			var lvlField=this.parentNode.querySelector(".safelvl");
			s.checkSafe(this,lvlField);
		}
		//拖动条
		s.showToolTip=function(tooltip,rangeInput){
			//当前值所占百分比
			var percent=((rangeInput.value-rangeInput.min)/(rangeInput.max-rangeInput.min)).toFixed(2);
			
			//距左的位置
			var dragRange=rangeInput.clientWidth*percent;
			var offsetLeft=rangeInput.offsetLeft+dragRange-10;
			//var currentOffsetLeft=offsetLeft-rangeInput.parentNode.offsetLeft;

			//滑块内部的实际位置
			var currentBallLeft=28*percent;

			//当前值的位置-滑块的位置=小球正中间的位置
			var left=offsetLeft-currentBallLeft;
			tooltip.innerHTML=rangeInput.value;
			tooltip.setAttribute("style","display:block;left:"+left+"px");
		}
		s.rangeTooltip,s.rangeInput;
		s.onRangeStart=function(e){
			s.rangeTooltip=this.previousElementSibling;
			s.rangeInput=this;
			s.showToolTip(s.rangeTooltip,s.rangeInput);
		}
		s.onRangeMove=function(e){
			s.showToolTip(s.rangeTooltip,s.rangeInput);
		}
		s.onRangeEnd=function(e){
			setTimeout(function(){
				s.rangeTooltip.style.display="none";
	        },1000);
		}
		//数字框
		s.numboxSum=function(inputNumber,btnPlus,btnMinus,operate){
			var min=inputNumber.getAttribute("min")||0;
			var max=inputNumber.getAttribute("max")||9999;
			var step=inputNumber.getAttribute("step")||1;

			var result;

			if(operate){//加运算
				btnMinus.disabled=false;
				result=parseInt(inputNumber.value)+parseInt(step);
				if(result>=max){
					result=max;
					btnPlus.disabled=true;
				}
			}else{//减运算
				btnPlus.disabled=false;
				result=inputNumber.value-step;
				if(result<=min){
					result=min;
					btnMinus.disabled=true;
				}
			}
			inputNumber.value=result;
		}
		s.onNumboxPlus=function(e){
			var inputNumber=this.previousElementSibling;
			var btnPlus=this;
			var btnMinus=inputNumber.previousElementSibling;
			s.numboxSum(inputNumber,btnPlus,btnMinus,true);
		}
		s.onNumboxMinus=function(e){
			var inputNumber=this.nextElementSibling;
			var btnPlus=inputNumber.nextElementSibling;
			var btnMinus=this;
			s.numboxSum(inputNumber,btnPlus,btnMinus,false);
		}
		//初始化
		s.init=function(){
			s.attach();
		};
		s.init();
	}
})(window,document,undefined);

//CountVal 文字计数器
(function(window,document,undefined){
	window.CountVal=function(field,params){
		/*================
		Model
		================*/
		var defaults={
			fieldAttr:"data-countval",
			forFieldAttr:"data-countval-for",
			ruleAttr:"data-rule"
			/*
            Callbacks:
            onInput:function(CountVal)
			onInputOut:function(CountVal)//文字超过限制
			onInputIn:function(CountVal)//文字未超过限制
			*/
		}
		params=params||{};
		for(var def in defaults){
			if(params[def]===undefined){
				params[def]=defaults[def];
			}
		}
		var s=this;
		s.params=params;
		//Field
		s.field=typeof field === "string"?document.querySelector(field):field;
		//console.log(s.field);return;
		var forFieldId=s.field.getAttribute(s.params.fieldAttr);
		s.field.forField=document.querySelector("["+s.params.forFieldAttr+"="+forFieldId+"]");

		/*================
		Controller
		================*/
		s.events=function(detach){
			var action=detach?"removeEventListener":"addEventListener";
        	s.field.maxlength=0;
        	var fieldRules=s.field.getAttribute(s.params.ruleAttr);
        	var rules=fieldRules.split(" ");
			for(var i=0,rule;rule=rules[i++];){
				if(rule.indexOf("maxlength")>=0){
					s.field.maxlength=rule.split(":")[1];
				}
			}
			if(!s.hasInputEvent){
				s.field[action]("input",s.onInput,false);
				s.hasInputEvent=true;
			}
		}
		s.attach=function(event){
            s.events();
        }
        s.detach=function(event){
            s.events(true);
        }
        s.onInput=function(e){
        	s.target=e.target;
        	//Callback
			if(s.params.onInput)s.params.onInput(s);
			if(s.target.maxlength<s.target.value.length && s.params.onInputOut){
				s.params.onInputOut(s);
			}else{
				s.params.onInputIn(s);
			}
        }
        //Init
        s.init=function(){
        	s.attach();
        }
        s.init();
	}
	window.CountVals=function(params){
		var s=this;
        //获得所有元素
        s.fields=document.querySelectorAll("[data-countval]");
        s.fields.fields=[];
        var jsonParams={};
        if(params)jsonParams=params;
        //实例化所有元素
        for(var i=0,field;field=s.fields[i++];){
            s.fields.fields[i]=new CountVal(field,jsonParams);
        }
	}
})(window,document,undefined);

//Gauge 仪表盘
(function(window,document,undefined){
	
	window.Gauge=function(container,params){
		/*============
		  Model
		  ==============*/
		var defaults={
			minValue:0,
            maxValue:360,
            currentValue:0,

            //dom
            pointClass:".gauge-pointer",
            waveClass:".gauge-wave",
            valueClass:".gauge-text",

            //animate
            durationall:2000

            /*callbacks
			onInit:function(Gauge)
			onPointChangeStart:function(Gauge)
			onPointChangeEnd:function(Gauge)
			*/
		}
		for(var def in defaults){
			if(params[def]==undefined){
				params[def]=defaults[def];
			}
		}
		var s=this;
		s.params=params;
		s.container=document.querySelector(container);//容器
		s.point=s.container.querySelector(s.params.pointClass);//指针
		s.wave=s.container.querySelector(s.params.waveClass)||null;//波浪
		s.value=s.container.querySelector(s.params.valueClass);//指针值

		s.percent=(s.params.currentValue-s.params.minValue)/(s.params.maxValue-s.params.minValue);//当前值所占比例
		s.duration=Math.round(s.percent*s.params.durationall);//执行时间长度
		s.bgLvl=Math.round(s.percent*10)+1;//背景等级
		if(s.bgLvl<1){
			s.bgLvl=1;
		}
		if(s.bgLvl>10){
			s.bgLvl=10;
		}
		s.pointRotate=eval(270*s.percent);//指针旋转角度
		if(s.pointRotate>270){
			s.pointRotate=270;
			s.burst=s.params.currentValue-s.params.maxValue;//爆表值
			console.log("已爆表");
		}
		/*============
		  Method
		  ==============*/
		//旋转指针
		s.updatePoint=function(){
			if(s.params.onPointChangeStart)s.params.onPointChangeStart(s);
			s.point.setAttribute("style","-webkit-transform:rotate("+s.pointRotate+"deg);-webkit-transition:all "+s.duration+"ms");
			if(!s.params.onPointChangeEnd)return;
			setTimeout(function(){
				s.params.onPointChangeEnd(s);
			},s.duration);
		}
		//设置数字
		s.updateValue=function(){
			s.value.innerHTML=s.params.currentValue;
		}
		//更改背景色
		s.updateBg=function(){
			var bgExpr=/bg[1-9]0?$/g;
			if(bgExpr.test(s.container.className)){
				s.container.className=s.container.className.replace(bgExpr,"bg"+s.bgLvl);
			}else{
				s.container.className+=" bg"+s.bgLvl;
			}
			s.container.style.WebkitAnimationDuration=s.duration+"ms";
		}
		//设置波浪
		s.updateWave=function(){
			if(!s.wave)return;
			var waveTop=100-Math.round(s.percent.toFixed(1)*100);
			if(waveTop<0){
				waveTop=0;
			}
			s.wave.style.top=waveTop+"%";
			s.wave.style.WebkitTransition="all "+s.duration+"ms";
		}
		s.update=function(){
			s.updateBg();
			s.updatePoint();
			s.updateValue();
			s.updateWave();
			if(s.params.onInit)s.params.onInit(s);
		}
		s.update();
	}
})(window,document,undefined);

//多媒体控件
(function(window,document,undefined){
	
	window.Media=function(media){
		/*===========================
	    Model
	    ===========================*/
		var s=this;
		s.media=document.querySelector(media)||new Audio(media);
		/*===========================
	    Method
	    ===========================*/
	    s.playAudio=function(loop){
			s.media.autoplay = true;
			s.media.loop = loop || false;
			s.media.play();
			return s;
		};
	    //判断视频加载状态
	    s.isReady=function(){
	    	if(s.media.readyState!=4){
				console.log("视频尚未加载完成，状态："+s.media.readyState);
				return false;
			}
			return true;
	    };
		//暂停与播放
		s.resume=function(){
			if(s.media.paused){
				s.media.play();
				return false;
			}else{
				s.media.pause();
				return true;
			}
		};
		//全屏与非全屏，w3c推荐标准，但尚未兼容
		s.fullScreen=function(){
			if(s.media.requestFullscreen){
				s.media.exitFullscreen();
				return false;
			}else{
				s.media.requestFullscreen();
				return true;
			}
		};
		//播放时间
		s.durationTime=function(){
			if(!s.isReady)return;
			if(arguments.length>0){
				s.media.duration=arguments[0];
			}
			return s.media.duration;
		};
		//当前时间
		s.currentTime=function(){
			if(!s.isReady)return;
			if(arguments.length>0){
				s.media.currentTime=arguments[0];
			}
			return s.media.currentTime;
		};
		//音量，值为0.0到1.0
		s.volume=function(){
			if(arguments.length>0){
				s.media.volume=arguments[0];
			}
			return s.media.volume;
		};
		//音量值大小
		s.volumeLvl=function(){
			var volnumber=s.media.volume;
			if(volnumber==0){
				return 0;
			}else if(volnumber>0 && volnumber<0.3){
				return 1;
			}else if(volnumber>0.3 && volnumber<0.6){
				return 2;
			}else if(volnumber>0.6 && volnumber<0.9){
				return 3;
			}else{
				return 4;
			}
		};
		//设置播放速度，默认为1.0秒
		s.rate=function(){
			if(arguments){
				s.media.defaultPlaybackRate=arguments[0];
			}
			return s.media.defaultPlaybackRate;
		};
		
		//是否支持此视频
		s.isSupport=function(mediaPostfix){
			var maybeMedia="";
			var probablyMedia="";
			switch(mediaPostfix){
				//音频
				case "aac":maybeMedia="audio/mp4",probablyMedia="audio/mp4; codecs=\"mp4a.40.2\"";break;
				case "mp3":maybeMedia="audio/mpeg",probablyMedia="audio/mpeg";break;
				case "vorbis":maybeMedia="audio/ogg",probablyMedia="audio/ogg; codecs=\"vorbis\"";break;//后缀通常为ogg
				case "wav":maybeMedia="audio/wav",probablyMedia="audio/wav; codecs=\"1\"";break;
				//视频
				case "h.264":maybeMedia="video/mp4",probablyMedia="video/mp4; codecs=\"avc1.42E01E, mp4a.40.2\"";break;//后缀通常为mpg4、mp4、mov
				case "theora":maybeMedia="video/ogg",probablyMedia="video/ogg; codecs=\"theora\"";break;//后缀通常为ogg
				case "webm":maybeMedia="video/webm",probablyMedia="video/webm; codecs=\"vp8, vorbis\"";break;//后缀通常为webm
			}
			if(maybeMedia!="" && probablyMedia!="" && (player.canPlayType(maybeMedia) || player.canPlayType(probablyMedia))){
				return true;
			}
			return false;
		};
		/*===========================
	    Events
	    ===========================*/
	    var event=function(eventname,fn,detach){
			var action=detach?"removeEventListener":"addEventListener";
			s.media[action](eventname,fn,false);
		}
		//因为没有数据不能播放，readyState值为0
		s.onDataunavailable=function(callback,detach){
			event("dataunavailable",callback,detach);
		};
		//当前帧已下载完成，readyState值为1
		s.onCanshowcurrentframe=function(callback,detach){
			event("canshowcurrentframe",callback,detach);
		};
		//可以播放时，readyState值为2
		s.onCanplay=function(callback,detach){
			event("canplay",callback,detach);
		};
		//播放可继续，而且应该不会中断，readyState值为3
		s.onCanplaythrough=function(callback,detach){
			event("canplaythrough",callback,detach);
		};
		//所有媒体已加载完成，load有可能会被废弃，建议使用canplaythrough
		s.onLoad=function(callback,detach){
			event("load",callback,detach);
		};
		//媒体的第一帧已加载完成
		s.onLoadeddata=function(callback,detach){
			event("loadeddata",callback,detach);
		};
		//媒体的元数据已加载完成
		s.onLoadedmetadata=function(callback,detach){
			event("loadedmetadata",callback,detach);
		};
		//下载已开始
		s.onLoadstart=function(callback,detach){
			event("loadstart",callback,detach);
		};
		//正在下载
		s.onProgress=function(callback,detach){
			event("progress",callback,detach);
		};
		//下载中断
		s.onAbort=function(callback,detach){
			event("abort",callback,detach);
		};
		//浏览器尝试下载，但未接收到数据
		s.onStalled=function(callback,detach){
			event("stalled",callback,detach);
		};
		//下载发生网络错误
		s.onError=function(callback,detach){
			event("error",callback,detach);
		};
		//网络连接关闭
		s.onEmptied=function(callback,detach){
			event("emptied",callback,detach);
		};
		//发生错误阻止了媒体下载
		s.onEmpty=function(callback,detach){
			event("empty",callback,detach);
		};
		//准备播放
		s.onPlay=function(callback,detach){
			event("play",callback,detach);
		};
		//正在播放
		s.onPlaying=function(callback,detach){
			event("playing",callback,detach);
		};
		//当前时间被不合理或意外的方式更新
		s.onTimeupdate=function(callback,detach){
			event("timeupdate",callback,detach);
		};
		//暂停
		s.onPause=function(callback,detach){
			event("pause",callback,detach);
		};
		//播放暂停，等待下载更多数据
		s.onWaiting=function(callback,detach){
			event("pause",callback,detach);
		};
		//媒体已播放至末尾，播放停止
		s.onEnded=function(callback,detach){
			event("ended",callback,detach);
		};
		//更改音量事件
		s.onVolumechange=function(callback,detach){
			event("volumechange",callback,detach);
		};
		//更改播放速度事件
		s.onRatechange=function(callback,detach){
			event("ratechange",callback,detach);
		};
		//搜索结束
		s.onSeeked=function(callback,detach){
			event("seeked",callback,detach);
		};
		//正在移动到新位置
		s.onSeeking=function(callback,detach){
			event("seeking",callback,detach);
		};
	};
})(window,document,undefined);

//Clock
(function(window,document,undefined){
    window.Clock=function(clock,params){
        /*================
        Model
        =================*/
        var defaults={
            "hourClass":"clock-hour",
            "minuteClass":"clock-minute",
            "clockAttr":"data-clock"
            /*
            "duration":"500",
            "delay":"0"
            */
        }
        params=params||{};
        for(var def in defaults){
            if(params[def]===undefined){
                params[def]=defaults[def];
            }
        }
        var s=this;
        //Params
        s.params = params;
        //Container
        s.clock=typeof clock === "string"?document.querySelector(clock):clock;
        s.hour,s.minute,s.time,s.hourDeg,s.minuteDeg;
        /*================
        Method
        =================*/
        s.getHourDeg=function(hour){
            return hour*30;
        }
        s.getMinuteDeg=function(minute){
            return minute*6;
        }
        s.update=function(){
            s.hour=s.clock.querySelector("."+s.params.hourClass);
            s.minute=s.clock.querySelector("."+s.params.minuteClass);
            s.time=s.clock.getAttribute(s.params.clockAttr);
            if(!s.time || !/\d{1,2}:\d{1,2}/.test(s.time)){
                console.log("时间格式应为xx:xx");
                return;
            }
            var hourMinute=s.time.split(":");
            s.hourDeg=s.getHourDeg(hourMinute[0]);
            s.minuteDeg=s.getMinuteDeg(hourMinute[1]);
        }
        s.update();
        s.play=function(){
            if(!isNaN(s.params.duration))s.clock.style.WebkitTransitionDuration=s.params.duration+"ms";
            if(!isNaN(s.params.delay))s.clock.style.WebkitTransitionDelay=s.params.delay+"ms";
            s.hour.style.webkitTransform="rotate("+s.hourDeg+"deg)";
            s.minute.style.webkitTransform="rotate("+s.minuteDeg+"deg)";
        }
        s.play();
    }
    window.Clocks=function(params){
        var s=this;
        //获得所有元素
        s.clocks=document.querySelectorAll("[data-clock]");
        s.clocks.clocks=[];
        var jsonParams={};
        if(params)jsonParams=params;
        //实例化所有元素
        for(var i=0,clock;clock=s.clocks[i++];){
            s.clocks.clocks[i]=new Clock(clock,jsonParams);
        }
    }
})(window,document,undefined);

//富文本编辑框
var Richeditor={
	//获取选区
	selection:function(){
		return document.getSelection();
	},
	//获取文本框光标位置
	getTxtCusorPos:function(txt){
		var cusorPos=-1;
		//非ie
		if(txt.selectionStart){//非IE浏览器
			cusorPos= txt.selectionStart;
			return cusorPos;
		}
		//讨厌的ie
		if(document.selection && document.selection.createRange){
			var range = document.selection.createRange();
			range.moveStart("character",-txt.value.length);
			cusorPos=range.text.length;
			return cusorPos;
		}
	},
	//获取光标位置
	getDivCusorPos:function(){
		var cusorPos = 0;// 光标位置
		//非ie
		if(window.getSelection){
			var selection=window.getSelection();
			//选中区域的“起点”
			/*console.log(selection.anchorNode);
			//选中区域的“结束点”
			console.log(selection.focusNode);
			//“结束点”的偏移量
			console.log(selection.focusOffset);
			//判断是否有选中区域
			console.log(selection.isCollapsed);
			//一般一个页面只有一个range，也有可能是多个range(使用Ctrl健进行多选)
			console.log(selection.rangeCount);*/
			
			//“起点”的偏移量
			cusorPos=selection.anchorOffset;
			return cusorPos;
		}
		//讨厌的ie
		if(document.selection && document.selection.createRange){
			var range = document.selection.createRange();
			var srcele = range.parentElement();
			var copy = document.body.createTextRange();
			copy.moveToElementText(srcele);
			for (cusorPos = 0; copy.compareEndPoints("StartToStart", range) < 0; cusorPos++) {
				copy.moveStart("character", 1);
			}
			return cusorPos;
		}
	},
	//只支持高级浏览器
	selectionPos:function(classname){
		var selection=window.getSelection();
		var cursorOffset=0;
		document.onselectionchange=function(e){
			if(e.target.activeElement.className==classname){
				cursorOffset=selection.anchorOffset;
			}
		}
		return cursorOffset;
	},
	/**
	 * 确定命令是否已经激活
	 * 
	 * @method isenable
	 * @param commandName (命令名称，如：backcolor)
	 * @return boolean
	 */
	isenable:function(commandName){
		return document.queryCommandEnabled(commandName);
	},
	backgroundcolor:function(color){
		document.execCommand("backcolor",false,color);
	},
	bold:function(){
		document.execCommand("bold",false,null);
	},
	italic:function(){
		document.execCommand("italic",false,null);
	},
	underline:function(){
		document.execCommand("underline",false,null);
	},
	copy:function(){
		document.execCommand("copy",false,null);
	},
	selectall:function(){
		document.execCommand("selectall",false,null);
	},
	cut:function(){
		document.execCommand("cut",false,null);
	},
	paste:function(){
		document.execCommand("paste",false,null);
	},
	del:function(){
		document.execCommand("delete",false,null);
	},
	link:function(url){
		document.execCommand("createlink",false,url);
	},
	unlink:function(){
		document.execCommand("unlink",false,null);
	},
	fontname:function(fontName){
		document.execCommand("fontname",false,fontName);
	},
	fontsize:function(fontSize){
		if(fontSize){
			document.execCommand("fontsize",false,fontSize);
			return;
		}
		return document.queryCommandValue("fontsize");
	},
	fontcolor:function(fontColor){
		document.execCommand("forecolor",false,fontColor);
	},
	format:function(tag){
		document.execCommand("formatblock",false,tag);
	},
	unformat:function(){
		document.execCommand("removeformat",false,null);
	},
	indent:function(){
		document.execCommand("indent",false,null);
	},
	outdent:function(){
		document.execCommand("outdent",false,null);
	},
	hr:function(){
		document.execCommand("inserthorzizontalrule",false,null);
	},
	img:function(url){
		document.execCommand("insertimage",false,url);
	},
	ol:function(){
		document.execCommand("insertorderedlist",false,null);
	},
	ul:function(){
		document.execCommand("insertunorderedlist",false,null);
	},
	p:function(){
		document.execCommand("insertparagraph",false,null);
	},
	center:function(){
		document.execCommand("justifycenter",false,null);
	},
	left:function(){
		document.execCommand("justifyleft",false,null);
	},
	right:function(){
		document.execCommand("justifyright",false,null);
	},
	//设置光标位置
	setCaretPosition:function(elem, caretPos) {
	    if(elem != null) {
	        if(elem.createTextRange) {
	            var range = elem.createTextRange();
	            range.move('character', caretPos);
	            range.select();
	        }
	        else {
	            if(elem.selectionStart) {
	                elem.focus();
	                elem.setSelectionRange(caretPos, caretPos);
	            }
	            else
	                elem.focus();
	        }
	    }
	},
	isEnter:function(){
		//监听键盘输入
		EventUtil.addHandler(window,"keydown",function(e){
			keynum = e.which || e.keyCode;
			if(keynum=="13"){
				return true;
			}
			return false;
		})
	},
	queryInput:function(queryExtend,queryCollapse){
		var winHeight=window.innerHeight,currentWinHeight=window.innerHeight;
		var listenerInput;//监听输入框
		listenerInput=setInterval(function(e){
			currentWinHeight=window.innerHeight;
			//获得输入法高度
			if(DB.get("queryInputHeight") && DB.get("queryInputHeight")>0){
				console.log("读取数据库queryInputHeight:"+DB.get("inputHeight"));
				this.inputHeight=DB.get("queryInputHeight");
				clearInterval(listenerInput);
			}else{
				this.inputHeight=winHeight-currentWinHeight;
				console.log("注入数据库queryInputHeight:"+inputHeight);
				DB.set("queryInputHeight",inputHeight);
			}
			//判断输入法是否收缩
			if(winHeight==currentWinHeight){
				if(queryCollapse){
					queryCollapse.call(this,e);
				}
				clearInterval(listenerInput);
			}else{
				if(queryExtend){
					queryExtend.call(this,e);
				}
			}
		},500);
	},
};

//带表情输入框
(function(window,document,undefined){
	window.Richinput=function(container,params){
		/*=========================
          Params
          ===========================*/
        var defaults={
        	"maskClass":"mask",
			"emojiBoxClass":"emoji",
			"sliderParam":{
				"pagination":".slider-pagination"
			}
		}
		params=params||{};
		for(var def in defaults){
			if(params[def]===undefined){
				params[def]=defaults[def];
			}
		}
		//Richinput
		var s=this;

		//Params
		s.params = params;

		//Container
		s.container=typeof container=="string"?document.querySelector(container):container;
		if(!s.container)return;

		//Slider
		s.slider;

		//Mask Div
		s.mask=document.querySelector(container+"+."+s.params.maskClass);

		//表情容器
		s.emojiBox=s.container.querySelector("."+s.params.emojiBoxClass);

		//Textarea Form
		s.textarea=s.container.querySelector("textarea");

		//辅助计算textarea高度的pre和preSpan
		var pre=s.container.querySelector("pre");
		var preSpan=pre.querySelector("span");

		//pre.style.width=s.textarea.clientWidth+"px";
		s.textarea.style.height=pre.clientHeight+"px";

		/*=========================
          Method
          ===========================*/
		//插入表情
		function insertFace(objFace){
			var emojiName=objFace.getAttribute("alt");
			//var emojiSrc=objFace.getAttribute("data-emoji-src");
			var editText=s.textarea.value;
			var editTextBefore=editText.substr(0,cursorOffset);
			var editTextAfter=editText.substr(cursorOffset,editText.length);
			var editTextInsert=emojiName;
			cursorOffset=cursorOffset+emojiName.length;
			s.textarea.value=editTextBefore+editTextInsert+editTextAfter;
		}

		/*=========================
          Events Listener
          ===========================*/
		//遮罩层添加点击事件
		s.mask.addEventListener("click",function(e){
			s.container.classList.remove("active");
			//s.container.className=s.container.className.replace(/\s{1,}active/,"");
			s.textarea.blur();
		},false);

		//获得光标位置
		var cursorOffset=0;
		document.onselectionchange=function(e){
			if(Object.prototype.toString.call(e.target.activeElement)=="[object HTMLTextAreaElement]"){
				//计算textarea高度
				preSpan.innerText=s.textarea.value;
				s.textarea.style.height=pre.clientHeight+"px";
				//获得光标位置
				cursorOffset=s.textarea.selectionStart;
			}
		}
		s.textarea.addEventListener("input",function(e){
			//计算textarea高度
			preSpan.innerText=s.textarea.value;
			s.textarea.style.height=pre.clientHeight+"px";
			//获得光标位置
			cursorOffset=s.textarea.selectionStart;
		},false);
		//点击input框
		s.textarea.addEventListener("click",function(e){
			s.container.classList.add("active");
			if(!s.slider){
				s.slider=new Slider(container+" ."+s.params.emojiBoxClass,s.params.sliderParam);
			}
		},false);

		//点击表情
		s.emojiBox.addEventListener("click",function(e){
			if(e.target.getAttribute("data-emoji")){
				insertFace(e.target);
			}
			s.textarea.focus();
			Richeditor.setCaretPosition(s.textarea,cursorOffset);
		},false);
	}
})(window,document,undefined);


//Share 社会化分享
(function(window,document,undefined){
	
	window.Share=function(params){
		/*===============
		Model
		================*/
		var s=this;
		var defaults={
			"href":window.location.href,
			"title":document.title || '',
			"desc":"",
			"imgUrl":"",
			"imgTitle":document.title || '',
			"from":window.location.host || "",
			"cusTxt":"请输入此时此刻想要分享的内容"
		};
		params=params||{};
		for(var def in defaults){
			if(params[def]==undefined){
				params[def]=defaults[def];
			}
		}
		s.params=params;

		/*===============
		Method
		================*/
		//uc分享
		var ucAppList = {
		        "tsina": ["kSinaWeibo", "SinaWeibo", "11", "新浪微博"],
		        "weixin": ["kWeixin", "WechatFriends", "1", "微信好友"],
		        "fweixin": ["kWeixinFriend", "WechatTimeline", "8", "微信朋友圈"],
		        "qq": ["kQQ", "QQ", "4", "QQ好友"],
		        /*"tqq": ["kQQWeibo", "QQWeibo", "11", "腾讯微博"],
		         * "qzone": ['kQZone', 'QZone', '3', 'QQ空间']*/
		};
		s.UCshare=function(toApp) {
			var to_app;
			if(Device.isIos){
				to_app=ucAppList[toApp][0];
				ucbrowser.web_share(s.params.title, s.params.title, s.params.href, to_app, "","@"+s.params.from, ''); 
			}else{
				to_app=ucAppList[toApp][1];
				ucweb.startRequest("shell.page_share", [s.params.title, s.params.title, s.params.href, to_app, "", "@"+s.params.from, ""]);  
			}
		};

		//html分享
		function popIFrame(openUrl){
			var tempDiv = document.createElement("div");
			tempDiv.style.visibility = "hidden";
			tempDiv.innerHTML = '<iframe src="' + openUrl + '" scrolling="no" width="1" height="1"></iframe>';
			document.body.appendChild(tempDiv);
			setTimeout(function () {
				tempDiv && tempDiv.parentNode && tempDiv.parentNode.removeChild(tempDiv);
			}, 5000);
		};
		s.HTMLShare=function(toApp){
			var openUrl=""
			if (toApp == "qzone") {
				if(Device.isMobile){
					openUrl= "mqqapi://share/to_qzone?src_type=web&version=1&file_type=news&req_type=1&image_url="+s.params.imgUrl+"&title="+s.params.title+"&description="+s.params.desc+"&url="+s.params.href+"&app_name="+s.params.from;
					popIFrame(openUrl);
					return;
				}
				openUrl="http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url="+s.params.href+"&amp;title="+s.params.title+"&amp;showcount=0&amp;summary="+s.params.desc+"&amp;pics="+s.params.imgUrl+"";
				window.open(openUrl);
				return;
			}
			if(toApp=="tsina"){
				openUrl="http://service.weibo.com/share/share.php?url="+s.params.href+"&language=zh_cn&title="+s.params.title+"&pic="+s.params.imgUrl+"&searchPic=true";
				window.open(openUrl);
				return;
			}
			if(toApp=="tqq"){
				openUrl=encodeURI("http://share.v.t.qq.com/index.php?c=share&a=index&title="+s.params.title+"&url="+s.params.href+"&appkey=ce15e084124446b9a612a5c29f82f080&site="+s.params.from+"&pic="+s.params.imgUrl);
				window.open(openUrl,"转播到腾讯微博");
				return;
			}
			if(toApp="qq"){
				openUrl="http://connect.qq.com/widget/shareqq/index.html?url="+s.params.href+"#0-sqq-1-85270-9737f6f9e09dfaf5d3fd14d775bfee85&title="+s.params.title+"&desc="+s.params.desc+"&summary=&site="+s.params.from+"&pics="+s.params.imgUrl;
				window.open(openUrl);
				return;
			}
		}

		/*===============
		Controller
		================*/
		s.toQzone=function(){
			s.HTMLShare("qzone");
		};
		s.toTsina=function(){
			if(Device.isUC){
				s.UCshare("tsina");
			}else{
				s.HTMLShare("tsina");
			}
		};
		s.toTqq=function(){
			s.HTMLShare("tqq");
		};
		s.toWeixin=function(){
			if(Device.isUC){
				s.UCshare("weixin");
			}else{
				alert("您当前的浏览器不支持分享到微信");
			}
		};
		s.toFWeixin=function(){
			if(Device.isUC){
				s.UCshare("fweixin");
			}else{
				alert("您当前的浏览器不支持分享到微信朋友圈");
			}
		};
		s.toQQ=function(){
			if(Device.isUC){
				s.UCshare("qq");
			}else{
				s.HTMLShare("qq");
			}
		};
	}
})(window,document,undefined);

//Slider 滑动控件
(function(window,document,undefined){
	
	window.Slider=function(container,params){
		/*=========================
          Model
          ===========================*/
		var defaults={
			"pagination":null,
			"autoplay":false,
			"slidesPerView":1,
			"threshold":"50",
			"duration":"300",

			//loop
			"loop":false,
			"slideDuplicateClass":'slider-slide-duplicate',

			//dom class
			"wrapperClass":"slider-wrapper",
			"slideClass":"slider-slide",
			"slideActiveClass":"active",
			"bulletClass":"bullet",
			"bulletActiveClass":"active"

			/*callbacks
			onInit:function(Slider)
			onSlideChangeStart:function(Slider)
			onSlideChange:function(Slider)
			onSlideChangeEnd:function(Slider)
			*/
		}
		params=params||{};
		for(var def in defaults){
			if(params[def]===undefined){
				params[def]=defaults[def];
			}
		}
		//Slider
		var s=this;

		//Params
		s.params = params;

		//Container
		s.container=typeof container=="string"?document.querySelector(container):container;
		s.container.width=s.container.clientWidth;
		//Wrapper
		s.wrapper=document.querySelector(container+" > ."+s.params.wrapperClass);
		// s.wrapper=s.container.querySelector(":scope > ."+s.params.wrapperClass);
		//Slides
		s.slides=document.querySelectorAll(container+" > ."+s.params.wrapperClass+" > ."+s.params.slideClass+"");
		// s.slides=s.wrapper.querySelectorAll(":scope > ."+s.params.slideClass);
		if(s.slides.length<=0){
			return;
		}
		//Method
		/*=========================
          Pagination
          ===========================*/
        s.createPagination=function(){
        	if (!s.params.pagination) return;
        	s.paginationContainer=document.querySelector(container+" > "+s.params.pagination);
        	//s.paginationContainer = s.container.querySelector(":scope > "+s.params.pagination);

        	s.bullets=[];
        	s.paginationContainer.innerHTML="";
            s.numberOfBullets = s.params.loop ? s.slides.length - s.params.slidesPerView * 2 : s.slides.length;
            for (var i = 0; i < s.numberOfBullets; i++) {
            	var bullet=document.createElement("span");
				bullet.setAttribute("class",s.params.bulletClass);
				s.paginationContainer.appendChild(bullet);
				s.bullets.push(bullet);
            }
            //s.bullets = s.paginationContainer.querySelectorAll(":scope > "+s.params.bulletClass);
        };
        /*=========================
          Classes
          ===========================*/
        s.updateClasses = function () {
        	//Slide
        	for(var i=0;i<s.slides.length;i++){
				s.slides[i].className=s.slides[i].className.replace(/\s{1,}active/,"");
			}
			s.slides[s.index].className+=" "+s.params.slideActiveClass;

			// Pagination
			var index=s.index;
			if(s.params.loop){
				if(s.index>=s.params.slidesPerView && s.index<=s.slides.length-1-s.params.slidesPerView){
					//console.log("原稿处");
					index=Math.abs(s.index-s.params.slidesPerView);
				}else{
					//console.log("左右复稿处");
					index=Math.abs(s.numberOfBullets-Math.abs(s.index-s.params.slidesPerView));
				}
			}
			if (!s.paginationContainer) return;
			for(var i=0;i<s.bullets.length;i++){
				s.bullets[i].className=s.bullets[i].className.replace(/\s{1,}active/,"");
			}
			s.bullets[index].className+=" "+s.params.bulletActiveClass;
        };
        /*=========================
          Slides
          ===========================*/
		s.updateSlides=function(){
			s.slides=document.querySelectorAll(container+" > ."+s.params.wrapperClass+" > ."+s.params.slideClass+"");
			//s.slides=s.wrapper.querySelectorAll(":scope > ."+s.params.slideClass);
		};
		/*=========================
          Container Size
          ===========================*/
        s.updateContainerSize=function(){
			//Slide width
			s.width=Math.floor(s.container.width/s.params.slidesPerView);
			//设置wrapper宽度
			s.wrapper.width=s.width*s.slides.length;
			s.wrapper.style.width=s.wrapper.width+"px";
			//设置单个slide宽度
			[].slice.call(s.slides).forEach(function(n,i,a){
				n.style.width=s.width+"px";
			});

			//Slide height
			s.height=s.container.clientHeight?s.container.clientHeight:s.wrapper.clientHeight;
			[].slice.call(s.slides).forEach(function(n,i,a){
				n.style.height=s.height+"px";
			});
			s.container.style.height=s.height+"px";			

			//更新active index
			s.updateClasses();
			//如果有循环的话
			if(s.params.loop){
				s.params.duration=0;
				moveToIndex();
				s.params.duration=defaults.duration;
			}
		};
        
        /*=========================
          Loop
          ===========================*/
        s.createLoop = function () {
        	if(!s.params.loop)return;
        	if(s.params.slidesPerView>s.slides.length)return;
        	var prependSlides = [], appendSlides = [],i;
        	[].slice.call(s.slides).forEach(function(n,i,a){
        		if (i < s.params.slidesPerView)appendSlides.push(n);
        		if (i < s.slides.length && i >= s.slides.length - s.params.slidesPerView)prependSlides.push(n);
        	});
        	for (i = 0; i < appendSlides.length; i++) {
                s.wrapper.appendChild(appendSlides[i].cloneNode(true)).classList.add(s.params.slideDuplicateClass);
            }
            for (i = prependSlides.length - 1; i >= 0; i--) {
                s.wrapper.insertBefore(prependSlides[i].cloneNode(true),s.wrapper.firstElementChild).classList.add(s.params.slideDuplicateClass);
            }
            s.index=s.params.slidesPerView;
        };
        s.destroyLoop = function () {
        	s.params.loop=null;
        	var slideDuplicate=s.wrapper.querySelectorAll('.' + s.params.slideDuplicateClass);
        	for(var i=0,slideDu;slideDu=slideDuplicate[i++];){
        		s.wrapper.removeChild(slideDu);
        	}
        };
        //Controller
		/*=========================
          Touch Events
          ===========================*/
		//绑定事件
		s.events=function(detach){
			var touchTarget=s.container;
			var action=detach?"removeEventListener":"addEventListener";
			touchTarget[action]("touchstart",s.onTouchStart,false);
			touchTarget[action]("touchmove",s.onTouchMove,false);
			touchTarget[action]("touchend",s.onTouchEnd,false);
			touchTarget[action]("touchcancel",s.onTouchEnd,false);
		}
		//attach、dettach事件
		s.attach=function(event){
			s.events();
		}
		s.detach=function(event){
			s.events(true);
		}
		/*=========================
          Touch Handler
          ===========================*/
        //Touch信息
        s.touches={
        	startX:0,
        	startY:0,
        	currentX:0,
        	currentY:0,
        	endX:0,
        	endY:0,
        	diffX:0,
        	diffY:0,
        	posX:0,
        	direction:null
        };
        //索引
        s.index=0;
        function preventDefault(e){
			e.preventDefault();
		}
		s.onTouchStart=function(e){
			s.container.addEventListener("touchmove",preventDefault,false);
			s.touches.startX=e.touches[0].clientX;
			s.touches.startY=e.touches[0].clientY;
			//关闭自动播放
			s.stopAutoplay();
			//runCallBack
			s.target=s.slides[s.index];
			if(s.params.onSlideChangeStart)s.params.onSlideChangeStart(s);
		};
		s.onTouchMove=function(e){
			s.touches.currentX=e.touches[0].clientX;
			s.touches.currentY=e.touches[0].clientY;
			s.touches.diffX=s.touches.startX-s.touches.currentX;
			s.touches.diffY=s.touches.startY-s.touches.currentY;
			//runCallBack
			if(s.params.onSlideChange)s.params.onSlideChange(s);
			//设置滑动方向
			if(s.touches.direction==null){
				s.touches.direction=Math.abs(s.touches.diffY)-Math.abs(s.touches.diffX)>0?"vertical":"horizontal";
			}
			if(s.touches.direction=="vertical"){
				s.container.removeEventListener("touchmove",preventDefault,false);
				return;
			}
			e.stopPropagation();
			//x轴距离左边的像素，向左为负数，向右为正数
			var moveX=s.touches.posX-s.touches.diffX;
			//判断是否是边缘
			if(moveX>0 || -moveX + s.container.width >= s.wrapper.width){
				return;
			}
			//s.wrapper.style.left=moveX+"px";
			s.wrapper.style.webkitTransform='translate3d(' + moveX + 'px,0px,0px)';
		};
		s.onTouchEnd=function(e){
			//s.container.removeEventListener("touchmove",preventDefault,false);
			//左右拉动
			if(s.touches.direction=="horizontal"){
				//左右拉动
				if(s.touches.diffX>s.params.threshold){
					//下一页
					s.index++;
				}else if(s.touches.diffX<-s.params.threshold){
					//上一页
					s.index--;
				}
				s.slideTo();
			}
			//清空滑动方向
			s.touches.direction=null;
			//开启自动播放
			s.startAutoplay();
		};
		/*=========================
          Autoplay
          ===========================*/
        s.startAutoplay = function () {
        	if(!s.params.autoplay)return;
			s.autoplayer=window.setInterval(function(){
				s.index++;
				if(s.index>=s.slides.length){
					s.index=0;
				}
				s.slideTo(s.index);
			},s.params["autoplay"]);
        };

        s.stopAutoplay = function (internal) {
        	if(s.autoplayer){
        		window.clearInterval(s.autoplayer);
        	}
        };

		/*=========================
          Method
          ===========================*/
        function moveToIndex(){
        	s.wrapper.style.webkitTransitionDuration=s.params.duration+"ms";
        	s.touches.posX=-s.index*s.width;
        	//s.wrapper.style.left=s.touches.posX+"px";
        	s.wrapper.style.webkitTransform='translate3d(' + s.touches.posX + 'px,0px,0px)';
        }
        s.slideTo=function(slideIndex){
        	if(slideIndex>=0){
				s.index=slideIndex;
			}
			//索引不能小于0
			if(s.index<0){
				s.index=0;
			}
			//索引不能大于slide总数
			if(s.index>s.slides.length-1){
				s.index=s.slides.length-1;
			}
			//一页多屏，索引不能露出空白区域
			if(s.params.slidesPerView>1 && s.index>s.slides.length-params.slidesPerView){
				s.index=s.slides.length-s.params.slidesPerView;
			}
			
			//更新class
			s.updateClasses();
			//移动至index
			moveToIndex();
			setTimeout(function(){
				s.wrapper.style.webkitTransitionDuration="0ms";
				//runCallBack
				s.target=s.slides[s.index];
				if(s.params.onSlideChangeEnd)s.params.onSlideChangeEnd(s);
				//循环的情况
				if(s.params.loop){
					if(s.touches.posX==0){
						s.index=s.slides.length-s.params.slidesPerView*2;
						//console.log("最左侧，应跳转到："+s.index);
						s.params.duration=0;
						moveToIndex();
						s.params.duration=defaults.duration;
						return;
					}
					if(-s.touches.posX + s.container.width >= s.wrapper.width){
						s.index=s.params.slidesPerView;
						//console.log("最右侧，应跳转到："+s.index);
						s.params.duration=0;
						moveToIndex();
						s.params.duration=defaults.duration;
						return;
					}
				}
			},s.params.duration);
        };

		//主函数
		s.init=function(){
			if(s.params.loop)s.createLoop();
			s.updateSlides();
			if(s.params.pagination)s.createPagination();
            s.updateContainerSize();
			s.attach();
			if(s.params.autoplay) s.startAutoplay();
			//runCallBack
			s.target=s.slides[s.index];
			if(s.params.onInit)s.params.onInit(s);
		}
		//执行主函数
		s.init();
		// Return slider instance
		return s;
	}
	Slider.prototype={
		support:{
			touch:(function(){return 'ontouchstart' in window})(),
			animationend:(function(){return 'onanimationend' in window})(),
			transitionend:(function(){return 'ontransitionend' in window})(),
		}
	}
})(window,document,undefined);

//Type 类型判断
(function(window,document,undefined){
	
	window.Type={};
	var t=Type;
	/*====================
	动态添加方法Method:isString | isBoolean | isNumber | isArray | isObject | isHTMLElement
	=====================*/
	for(var i=0,type;type=["String","Boolean","Number","Array","Object","HTMLElement","Function"][i++];){
		(function(type){
			t["is"+type]=function(obj){
				if(type=="HTMLElement" && Object.prototype.toString.call(obj).indexOf("HTML")){
					return true;
				}
				return Object.prototype.toString.call(obj)==="[object "+type+"]";
			}
		})(type);
	}
	/*====================
	Other Method
	=====================*/
	t.isJson=function(obj){
		if(!obj){
			return false;
		}
		if(this.isObject(obj)){
			try{
				JSON.stringify(obj);
				return true;
			}catch(e){
				return false;
			}
		}else if(this.isString(obj)){
			try{
				JSON.parse(obj);
				return true;
			}catch(e){
				return false;
			}
		}else{
			return false;
		}
	},
	t.isQueryId=function(id){
		var idExpr=/^#([\w-]*)$/;
		var match=idExpr.exec(id);
		if(match && match.length>0){
			return match[1];
		}
		return false;
	},
	t.isQueryClass=function(classname){
		var classExpr=/^\.([\w-]*)$/;
		var match=classExpr.exec(classname);
		if(match && match.length>0){
			return match[1];
		}
		return false;
	},
	t.isId=function(id){
		if(typeof id === "string" && document.getElementById(id)){
			return true;
		}
		return false;
	},
	t.isClass=function(classname){
		if(typeof classname === "string" && document.getElementsByClassName(classname)){
			return true;
		}
		return false;
	},
	t.isTag=function(str){
		var tagExpr=/^<(\w+)\s*.*\/\w*>$/im;
		var match=tagExpr.exec(str);
		if(match && match.length>0){
			return true;
		}
		return false;
	},
	t.hasEvent=function(element,strEvent){
		return (document.all(element)[strEvent] == null) ? false : true 
	}
})(window,document,undefined);

//Weather 天气控件
(function(window,document,undefined){
	window.Weather=function(container,params){
		//Model
	    var defaults={
	    	"city":"南京",
	    	"expires":"today"
	    };
	    params=params||{};
	    for(var def in defaults){
	    	if(params[def]==undefined){
	    		params[def]=defaults[def];
	    	}
	    };
	    var s=this;
	    s.params=params;
	    //Expires
	    s.expires;
	    //Date
	    var date=new Date();
		if((!s.params.expires=="today" || s.params.expires==0) && typeof s.params.expires=="number"){
			return;
		}
		s.getExpires=function(){
			s.expires=date.expires(s.params.expires);
		}
		s.getExpires();
		//URL
	    s.weatherURL='http://api.map.baidu.com/telematics/v3/weather?location='+s.params.city+'&output=json&ak=W79uNeeyw7QXp6FGUzR6r8lY';
	    //s.weatherURL='http://api.map.baidu.com/telematics/v3/weather?location=南京';
		//Icon
		s.icon={
			"qing" : "icon-weaqing",
			"duoyun" : "icon-weaduoyun",
			"zhenyu" : "icon-weazhenyu",
			"leizhenyu" : "icon-wealeizhenyu",
			"leizhenyubanyoubingbao" : "icon-wealeizhenyubanyoubingbao",
			"yujiaxue" : "icon-weayujiaxue",
			"xiaoyu" : "icon-weaxiaoyu",
			"zhongyu" : "icon-weazhongyu",
			"dayu" : "icon-weadayu",
			"baoyu" : "icon-weabaoyu",
			"dabaoyu" : "icon-weadabaoyu",
			"tedabaoyu" : "icon-weatedabaoyu",
			"zhenxue" : "icon-weazhenxue",
			"xiaoxue" : "icon-weaxiaoxue",
			"zhongxue" : "icon-weazhongxue",
			"daxue" : "icon-weadaxue",
			"baoxue" : "icon-weabaoxue",
			"wu" : "icon-weawu",
			"dongyu" : "icon-weadongyu",
			"shachenbao" : "icon-weashachenbao",
			"xiaoyuzhuanzhongyu" : "icon-weaxiaoyuzhuanzhongyu",
			"zhongyuzhuandayu" : "icon-weazhongyuzhuandayu",
			"dayuzhuanbaoyu" : "icon-weadayuzhuanbaoyu",
			"baoyuzhuandabaoyu" : "icon-weabaoyuzhuandabaoyu",
			"dabaoyuzhuantedabaoyu" : "icon-weadabaoyuzhuantedabaoyu",
			"xiaoxuezhuanzhongxue" : "icon-weaxiaoxuezhuanzhongxue",
			"zhongxuezhuandaxue" : "icon-weazhongxuezhuandaxue",
			"daxuezhuanbaoxue" : "icon-weadaxuezhuanbaoxue",
			"fuchen" : "icon-weafuchen",
			"yangsha" : "icon-weayangsha",
			"qiangshachenbao" : "icon-weaqiangshachenbao",
			"mai" : "icon-weamai",
			"yin" : "icon-weayin"
		};
		//Container
	    s.container=document.querySelector(container);
	    //Citys
	    s.citysEl=[].slice.call(s.container.querySelectorAll(".weather-current-city"));
	    //Date
	    s.dateEl=s.container.querySelector("#weather-current-date");
	    //Temprature当前温度
	    s.tempratureEl=s.container.querySelector("#weather-current-temperature");
	    //NowTemprature今天温度
	    s.todayTempratureEl=s.container.querySelector("#weather-today-temperature");
	    //Pm2.5
	    s.pm25sEl=[].slice.call(s.container.querySelectorAll(".weather-current-pm25"));
	    //Quality
	    s.qualitysEl=[].slice.call(s.container.querySelectorAll(".weather-air-quality"));
	    //NowIcon当前天气图标
	    s.iconEl=s.container.querySelector("#weather-current-icon");
	    //NowName当前天气名称
	    s.weathersEl=[].slice.call(s.container.querySelectorAll(".weather-name"));
	    //Wind当前天气风级
	    s.windEl=s.container.querySelector("#weather-current-wind");
	    //OtherDays其它天气
	    s.otherDaysEl=s.container.querySelectorAll(".weather-otherday li");
	    //数据
	    s.todayData={
	    	/*"iconClass":"",
	    	"city":"",
	    	"date":"",
	    	"week":"",
	    	"weather":"",
	    	"temprature":"",
	    	"nowTemprature":"",
	    	"quality":"",
	    	"wind":""*/
	    }
	    s.otherDaysData=[
	    	/*{"iconClass":"","temprature":"","week":""},
	    	{"iconClass":"","temprature":"","week":""},
	    	{"iconClass":"","temprature":"","week":""},
	    	{"iconClass":"","temprature":"","week":""}*/
	    ]
		/*===========================
	    Method
	    ===========================*/
	    //Ajax
	    Weather.jsonpFn={};
	    Weather.jsonpCallback=function(data){
	        Weather.jsonpFn(data);
	    }
	    s.script;
	    s.jsonp=function(url,fn){
	    	var head=document.getElementsByTagName('head')[0];
	    	if(s.script)head.removeChild(s.script);
            Weather.jsonpFn=fn;
            var url=encodeURI(url+'&callback=Weather.jsonpCallback');
            s.script=document.createElement('script');
            s.script.type="text/javascript";
            s.script.src=url;
            s.script.onerror=function(){
                s.onError("s.jsonp方法136行");
            };
            head.appendChild(s.script);
        }
	    s.parseIcon=function(weatherImg){
	    	var weatherImgName = weatherImg.substring(weatherImg.lastIndexOf('/')+1, weatherImg.lastIndexOf('.'));
			return this.icon[weatherImgName];
	    }
	    s.getStainLvl=function(pm25){
	    	var airquality="";
			if(pm25<=50){
				airquality="优";
			}else if(pm25>50 && pm25<=100){
				airquality="良";
			}else if(pm25>100 && pm25<=150){
				airquality="轻度污染";
			}else if(pm25>150 && pm25<=200){
				airquality="中度污染";
			}else if(pm25>200 && pm25<=300){
				airquality="重度污染";
			}else{
				airquality="严重污染";
			}
			return airquality;
	    }
	    
		s.initData=function(){
			var cache=JSON.parse(DB.get("weatherJson"));
			var cacheExpires=DB.get("weatherJson_expires");
			//var now=date.format(date.datetime());
			console.log(date);
			console.log(cacheExpires);
			if(!cache || cache.status!="success" || cacheExpires<=date){
				console.log("不读缓存");
				s.loadData();
				return;
			}
			s.render(cache);
		};
		s.loadData=function(){
			s.jsonp(s.weatherURL,s.onSuccess);
		};
		//适配数据
	    s.adapterData=function(data){
	    	var temperatureExpr=/(-)?\d*℃/;
			var weekExpr=/(周|星期|礼拜)[1-7一二三四五六七天日]/;
			var todayData=data.results[0].weather_data[0].date;

			var iconClass=s.parseIcon(data.results[0].weather_data[0].dayPictureUrl);
			var city=data.results[0].currentCity;
			var date=data.date;
			var week=weekExpr.exec(todayData)[0];
			var weather=data.results[0].weather_data[0].weather;
			var temprature=temperatureExpr.exec(todayData)[0];
			var nowTemprature=temperatureExpr.exec(todayData)[0];
			var pm25=data.results[0].pm25;
			var quality=s.getStainLvl(pm25);
			var wind=data.results[0].weather_data[0].wind;

	    	s.todayData={
		    	"iconClass":iconClass,
		    	"city":city,
		    	"date":date,
		    	"week":week,
		    	"weather":weather,
		    	"temprature":temprature,
		    	"nowTemprature":nowTemprature,
		    	"pm25":pm25,
		    	"quality":quality,
		    	"wind":wind
		    }
		    
		    for(var i=0;i<4;i++){
		    	var otherIconClass=s.parseIcon(data.results[0].weather_data[i].dayPictureUrl);
		    	var otherTemprature=data.results[0].weather_data[i].temperature;
		    	var otherWeek=data.results[0].weather_data[i].date;
		    	if(i==0)otherWeek=week;
		    	s.otherDaysData[i]={
		    		"iconClass":otherIconClass,
		    		"temprature":otherTemprature,
		    		"week":otherWeek
		    	}
				/*if (6 < date.hour() < 18) {
					s.otherDaysEl[i].querySelector("i").setAttribute("class",s.parseIcon(json.results[0].weather_data[i].dayPictureUrl));
				}else{
					s.otherDaysEl[i].querySelector("i").setAttribute("class",s.parseIcon(json.results[0].weather_data[i].dayPictureUrl));
				}*/
			}
	    }
	    s.render=function(data){
	    	s.adapterData(data);
	    	//获得当前城市
			s.citysEl.forEach(function(n,i,a){
				n.innerHTML=s.todayData.city;
			})
			//获得当前日期
			s.dateEl.innerHTML=s.todayData.date;
			//获得今天周
			s.todayWeek=s.todayData.week;
			//获得当前温度
			s.tempratureEl.innerHTML=s.todayData.nowTemprature;
			//获得当天温度
			s.todayTempratureEl.innerHTML=s.todayData.temprature;
			//获得当前空气pm2.5
			s.pm25sEl.forEach(function(n,i,a){
				n.innerHTML=s.todayData.pm25;
			})
			//获得当前空气质量
			s.qualitysEl.forEach(function(n,i,a){
				n.innerHTML=s.todayData.quality;
			})
			//获得当前天气图标
			s.iconEl.setAttribute("class",s.todayData.iconClass);
			//获得当天天气名称
			s.weathersEl.forEach(function(n,i,a){
				n.innerHTML=s.todayData.weather;
			})
			//获得当天风向与级数
			s.windEl.innerHTML=s.todayData.wind;
			//剩余4天
			for(var i=0;i<4;i++){
				s.otherDaysEl[i].querySelector("i").setAttribute("class",s.otherDaysData[i].iconClass);
				s.otherDaysEl[i].querySelector("p").innerHTML=s.otherDaysData[i].temprature;
				s.otherDaysEl[i].querySelector("small").innerHTML=s.otherDaysData[i].week;
			}
	    }

		//Controller
		s.onSuccess=function(data){
			if (!data) {
				alert("你填写的现居地有误 ");
				return;
			}
			console.log("正在读取服务器天气..");
			
			console.log("正在定义缓存时效，时效截止于"+s.expires);
			DB.set("weatherJson",JSON.stringify(data));
			DB.set("weatherJson_expires",s.expires);
			
			s.render(data);
		},
		s.onError=function(msg){
			console.log("天气获取失败,请刷新后重试："+msg);
		}
		s.initData();
	};
})(window,document,undefined);

//Calendar
(function() {
	function DateSelect(opt) {
		this.temp_date_array = [];
		this.temp_prev_date_array = [];
		this.temp_next_date_array = [];
		this.temp_month_calender_date_array = [];
		this.temp_prev_month_calender_date_array = [];
		this.temp_next_month_calender_date_array = [];

		var i = 0,
			weekMilliSecound = 7 * 24 * 60 * 60 * 1000,
			dayMilliSecound = 24 * 60 * 60 * 1000;

		if (opt.activeDate) {
			this.active_date = opt.activeDate;
		} else {
			this.active_date = new Date();
		}

		for (i = 0; i < 7; ++i) {
			this.temp_date_array.push(new Date());
			this.temp_prev_date_array.push(new Date());
			this.temp_next_date_array.push(new Date());
		}

		for (i = 0; i < 42; ++i) {
			this.temp_month_calender_date_array.push(new Date());
			this.temp_prev_month_calender_date_array.push(new Date());
			this.temp_next_month_calender_date_array.push(new Date());
		}

		function _prevWeek() {
			this.active_date.setTime(this.active_date.getTime() - weekMilliSecound);
		}

		function _nextWeek() {
			this.active_date.setTime(this.active_date.getTime() + weekMilliSecound);
		}

		function _prevMonth() {
			this.active_date.setMonth(this.active_date.getMonth() - 1);
		}

		function _nextMonth() {
			this.active_date.setMonth(this.active_date.getMonth() + 1);
		}

		function _getSelected() {
			return this.active_date;
		}

		function _setSelected(activeDate) {
			this.active_date.setTime(activeDate);
		}

		function _setSelectedDay(day) {
			this.active_date.setTime(this.active_date.getTime() + dayMilliSecound * (parseInt(day, 10) - this.active_date.getDay()));
		}

		function _getWeekArrayByTimeAndArray(date_array, time) {
			var j = 1;

			date_array[0].setTime(time);

			for (j = 1; j < 7; ++j) {
				date_array[j].setTime(date_array[j - 1].getTime() + dayMilliSecound);
			}

			return date_array;
		}

		function _getWeekDate() {
			var day = this.active_date.getDay();

			var first_date_time = this.active_date.getTime() - dayMilliSecound * day;

			return _getWeekArrayByTimeAndArray(this.temp_date_array, first_date_time);
		}

		function _getPrevWeekDate() {
			var day = this.active_date.getDay();

			var first_date_time = this.active_date.getTime() - dayMilliSecound * day - weekMilliSecound;

			return _getWeekArrayByTimeAndArray(this.temp_prev_date_array, first_date_time);
		}

		function _getNextWeekDate() {
			var day = this.active_date.getDay();

			var first_date_time = this.active_date.getTime() - dayMilliSecound * day + weekMilliSecound;

			return _getWeekArrayByTimeAndArray(this.temp_next_date_array, first_date_time);
		}

		function _getMonthCalenderArrayByTimeAndArray(date_array, time) {
			var j = 1;

			date_array[0].setTime(time);

			for (j = 1; j < 42; ++j) {
				date_array[j].setTime(date_array[j - 1].getTime() + dayMilliSecound);
			}

			return date_array;
		}

		var tempMonthCalenderDate = new Date();

		function _getMonthCalenderDate() {
			tempMonthCalenderDate.setTime(this.active_date.getTime() - dayMilliSecound * (this.active_date.getDate() - 1));

			var day = tempMonthCalenderDate.getDay();

			var first_date_time = tempMonthCalenderDate.getTime() - dayMilliSecound * day;

			return _getMonthCalenderArrayByTimeAndArray(this.temp_month_calender_date_array, first_date_time);
		}

		function _getPrevMonthCalenderDate() {
			tempMonthCalenderDate.setTime(this.active_date.getTime() - dayMilliSecound * (this.active_date.getDate() - 1));

			tempMonthCalenderDate.setMonth(tempMonthCalenderDate.getMonth() - 1);

			var day = tempMonthCalenderDate.getDay();

			var first_date_time = tempMonthCalenderDate.getTime() - dayMilliSecound * day;

			return _getMonthCalenderArrayByTimeAndArray(this.temp_prev_month_calender_date_array, first_date_time);
		}

		function _getNextMonthCalenderDate() {
			tempMonthCalenderDate.setTime(this.active_date.getTime() - dayMilliSecound * (this.active_date.getDate() - 1));

			tempMonthCalenderDate.setMonth(tempMonthCalenderDate.getMonth() + 1);

			var day = tempMonthCalenderDate.getDay();

			var first_date_time = tempMonthCalenderDate.getTime() - dayMilliSecound * day;

			return _getMonthCalenderArrayByTimeAndArray(this.temp_next_month_calender_date_array, first_date_time);
		}

		function _getWeekNumInCalender() {
			tempMonthCalenderDate.setTime(this.active_date.getTime() - dayMilliSecound * (this.active_date.getDate() - 1));

			return Math.floor((tempMonthCalenderDate.getDay() + this.active_date.getDate() - 1) / 7);
		}

		function _getMonthCalenderDateTimeByIndex(index) {
			tempMonthCalenderDate.setTime(this.active_date.getTime() - dayMilliSecound * (this.active_date.getDate() - 1));

			tempMonthCalenderDate.setTime(tempMonthCalenderDate.getTime() + dayMilliSecound * (index - tempMonthCalenderDate.getDay()));

			return tempMonthCalenderDate.getTime();
		}


		this.prevWeek = _prevWeek;
		this.nextWeek = _nextWeek;
		this.prevMonth = _prevMonth;
		this.nextMonth = _nextMonth;
		this.getSelected = _getSelected;
		this.setSelected = _setSelected;
		this.setSelectedDay = _setSelectedDay;
		this.getWeekDate = _getWeekDate;
		this.getPrevWeekDate = _getPrevWeekDate;
		this.getNextWeekDate = _getNextWeekDate;
		this.getMonthCalenderDate = _getMonthCalenderDate;
		this.getPrevMonthCalenderDate = _getPrevMonthCalenderDate;
		this.getNextMonthCalenderDate = _getNextMonthCalenderDate;
		this.getWeekNumInCalender = _getWeekNumInCalender;
		this.getMonthCalenderDateTimeByIndex = _getMonthCalenderDateTimeByIndex;
	}


	function Calender(opt) {
		var day_num_array = ["日", "一", "二", "三", "四", "五", "六"];

		this.container_element = document.getElementById(opt.containerDivId);
		this.mode = opt.mode ? opt.mode : 'week';
		this.dateSelectObject = opt.dateSelectObject;
		this.onChange = opt.onChange;

		this.keyElement = {
			calender_container: this.container_element.getElementsByClassName('calender_container')[0],
			date_container: this.container_element.getElementsByClassName('date_container')[0],
			month_container: this.container_element.getElementsByClassName('month_container')[0]
		};

		if (!this.container_element) {
			return false;
		}

		function _initCalenderDom(_this, containerElement) {
			var month_container = _this.keyElement.month_container,
				html = '',
				i, j, k;

			for (i = 0; i < 3; ++i) {
				html += '<div class="month-block">';
				for (j = 0; j < 6; ++j) {
					html += '<div class="week-line">';
					for (k = 0; k < 7; ++k) {
						html += '<div class="day-date"><span class="datenum_' + i + '_' + j + '_' + k + ' show-date">' + j + i + '</span></div>';
					}
					html += '</div>';
				}
				html += '</div>';
			}

			//console.log(html);

			month_container.innerHTML = html;
		}

		_initCalenderDom(this, this.container_element);

		this.keyData = {
			calenderWidth: this.container_element.clientWidth,
			calenderHeight: this.keyElement.date_container.getElementsByClassName('day-date')[0].clientHeight
		};

		function _getFirstNumByString(string) {
			return parseInt(string.match(/-?\d+/)[0], 10);
		}

		function _getPositionInfo(_this) {
			var tempXPostion = _getFirstNumByString(_this.keyElement.calender_container.style.WebkitTransform),
				tempYPostion = _getFirstNumByString(_this.keyElement.month_container.style.WebkitTransform),
				tempHeight = _this.keyElement.date_container.style.height;

			tempHeight = parseInt(tempHeight.substring(0, tempHeight.length - 2), 10);

			return {
				positonX: tempXPostion,
				positonY: tempYPostion,
				height: tempHeight
			};
		}

		function _drawCalenderDate(_this) {
			_setPostionAndHeight(_this);

			var month_container = _this.keyElement.month_container,
				selectedDate = _this.dateSelectObject.getSelected(),
				tempThisMonthCalenderDate = _this.dateSelectObject.getMonthCalenderDate(),
				tempSpanElement,
				i, j, k, today = new Date();

			_this.container_element.getElementsByClassName('calendar-title')[0].innerHTML = selectedDate.getFullYear() + '-' + (selectedDate.getMonth() + 1) + '-' + selectedDate.getDate() + ' ' + '周' + day_num_array[selectedDate.getDay()];

			for (i = 0; i < 6; ++i) {
				for (j = 0; j < 7; ++j) {
					k = i * 7 + j;
					tempSpanElement = month_container.getElementsByClassName('datenum_1_' + i + '_' + j)[0];
					tempSpanElement.innerHTML = tempThisMonthCalenderDate[k].getDate();
					tempSpanElement.className = tempSpanElement.className.replace(/ not-this-month/g, '');
					if (tempThisMonthCalenderDate[k].getMonth() != selectedDate.getMonth()) {
						tempSpanElement.className += " not-this-month";
					}

					tempSpanElement.className = tempSpanElement.className.replace(/ active/g, '');
					if (tempThisMonthCalenderDate[k].getDate() === selectedDate.getDate() && tempThisMonthCalenderDate[k].getMonth() === selectedDate.getMonth()) {
						tempSpanElement.className += " active";
					}

					tempSpanElement.className = tempSpanElement.className.replace(/ today/g, '');
					if (tempThisMonthCalenderDate[k].getDate() === today.getDate() && tempThisMonthCalenderDate[k].getMonth() === today.getMonth()) {
						tempSpanElement.className += " today";
					}
				}
			}

			if (_this.mode === 'week') {
				var lineNum = _this.dateSelectObject.getWeekNumInCalender(),
					tempPrevWeekDate = _this.dateSelectObject.getPrevWeekDate(),
					tempNextWeekDate = _this.dateSelectObject.getNextWeekDate();

				for (i = 0; i < 7; ++i) {
					tempSpanElement = month_container.getElementsByClassName('datenum_0_' + lineNum + '_' + i)[0];
					tempSpanElement.innerHTML = tempPrevWeekDate[i].getDate();
					tempSpanElement.className = tempSpanElement.className.replace(/ not-this-month/g, '');
					if (tempPrevWeekDate[i].getMonth() != selectedDate.getMonth()) {
						tempSpanElement.className += " not-this-month";
					}

					tempSpanElement.className = tempSpanElement.className.replace(/ today/g, '');
					if (tempPrevWeekDate[i].getDate() === today.getDate() && tempPrevWeekDate[i].getMonth() === today.getMonth()) {
						tempSpanElement.className += " today";
					}

					tempSpanElement = month_container.getElementsByClassName('datenum_2_' + lineNum + '_' + i)[0];
					tempSpanElement.innerHTML = tempNextWeekDate[i].getDate();
					tempSpanElement.className = tempSpanElement.className.replace(/ not-this-month/g, '');
					if (tempNextWeekDate[i].getMonth() != selectedDate.getMonth()) {
						tempSpanElement.className += " not-this-month";
					}

					tempSpanElement.className = tempSpanElement.className.replace(/ today/g, '');
					if (tempNextWeekDate[i].getDate() === today.getDate() && tempNextWeekDate[i].getMonth() === today.getMonth()) {
						tempSpanElement.className += " today";
					}
				}
			} else if (_this.mode === 'month') {
				var tempPrevMonthCalenderDate = _this.dateSelectObject.getPrevMonthCalenderDate(),
					tempNextMonthCalenderDate = _this.dateSelectObject.getNextMonthCalenderDate();

				for (i = 0; i < 6; ++i) {
					for (j = 0; j < 7; ++j) {
						k = i * 7 + j;
						tempSpanElement = month_container.getElementsByClassName('datenum_0_' + i + '_' + j)[0];
						tempSpanElement.innerHTML = tempPrevMonthCalenderDate[k].getDate();
						tempSpanElement.className = tempSpanElement.className.replace(/ not-this-month/g, '');
						tempSpanElement.className += " not-this-month";

						tempSpanElement.className = tempSpanElement.className.replace(/ today/g, '');
						if (tempPrevMonthCalenderDate[k].getDate() === today.getDate() && tempPrevMonthCalenderDate[k].getMonth() === today.getMonth()) {
							tempSpanElement.className += " today";
						}

						tempSpanElement = month_container.getElementsByClassName('datenum_2_' + i + '_' + j)[0];
						tempSpanElement.innerHTML = tempNextMonthCalenderDate[k].getDate();
						tempSpanElement.className = tempSpanElement.className.replace(/ not-this-month/g, '');
						tempSpanElement.className += " not-this-month";

						tempSpanElement.className = tempSpanElement.className.replace(/ today/g, '');
						if (tempNextMonthCalenderDate[k].getDate() === today.getDate() && tempNextMonthCalenderDate[k].getMonth() === today.getMonth()) {
							tempSpanElement.className += " today";
						}
					}
				}
			}
		}

		function _setPostionAndHeight(_this, positionInfo) {
			if (positionInfo) {
				_this.keyElement.calender_container.style.WebkitTransform = 'translateX(' + positionInfo.positonX + 'px)';

				_this.keyElement.calender_container.style.transform = 'translateX(' + positionInfo.positonX + 'px)';

				_this.keyElement.date_container.style.height = positionInfo.height + 'px';

				_this.keyElement.month_container.style.WebkitTransform = 'translateY(' + positionInfo.positonY + 'px)';

				_this.keyElement.month_container.style.transform = 'translateY(' + positionInfo.positonY + 'px)';

				return true;
			}

			_this.keyElement.calender_container.style.WebkitTransform = 'translateX(-' + _this.keyData.calenderWidth + 'px)';

			_this.keyElement.calender_container.style.transform = 'translateX(-' + _this.keyData.calenderWidth + 'px)';

			_this.keyElement.date_container.style.height = _this.mode == 'week' ? _this.keyData.calenderHeight + 'px' : _this.keyData.calenderHeight * 6 + 'px';

			_this.keyElement.month_container.style.WebkitTransform = _this.mode == 'week' ? 'translateY(' + (-1 * _this.dateSelectObject.getWeekNumInCalender() * _this.keyData.calenderHeight) + 'px)' : 'translateY(0px)';

			_this.keyElement.month_container.style.transform = _this.mode == 'week' ? 'translateY(' + (-1 * _this.dateSelectObject.getWeekNumInCalender() * _this.keyData.calenderHeight) + 'px)' : 'translateY(0px)';
		}

		function _animationTo(_this, direct, positon, finishCB) {
			var speed = 30,
				step = 25,
				_animationFunction;

			(function(_this, direct, positon, finishCB) {
				var targetPostion = {
					'x': {
						'0': {
							positonX: (-1 * _this.keyData.calenderWidth)
						},
						'1': {
							positonX: (-2 * _this.keyData.calenderWidth)
						},
						'-1': {
							positonX: 0
						}
					},
					'y': {
						'0': {
							positonY: 0,
							height: _this.keyData.calenderHeight * 6
						},
						'1': {
							positonY: (-1 * _this.dateSelectObject.getWeekNumInCalender() * _this.keyData.calenderHeight),
							height: _this.keyData.calenderHeight
						}
					}
				};

				_animationFunction = function() {
					var tempPositionInfo = _getPositionInfo(_this);

					var tempTargetPostion = targetPostion[direct][positon];

					var key, animationSign = false;

					for (key in tempTargetPostion) {
						if (tempTargetPostion[key] != tempPositionInfo[key]) {
							if ((tempTargetPostion[key] > tempPositionInfo[key]) && (tempTargetPostion[key] > tempPositionInfo[key] + step)) {
								tempPositionInfo[key] = tempPositionInfo[key] + step;
							} else if ((tempTargetPostion[key] < tempPositionInfo[key]) && (tempTargetPostion[key] < tempPositionInfo[key] - step)) {
								tempPositionInfo[key] = tempPositionInfo[key] - step;
							} else {
								tempPositionInfo[key] = tempTargetPostion[key];
							}
							animationSign = true;
						}
					}

					if (animationSign) {
						_setPostionAndHeight(_this, tempPositionInfo);
						return true;
					}

					return false;
				};
			})(_this, direct, positon, finishCB);

			(function(_animationFunction) {
				clearTimeout(_this.keyData.timeout);

				function _animationLoopFunction() {
					if (_animationFunction()) {
						_this.keyData.timeout = setTimeout(_animationLoopFunction, speed);
					} else if (typeof finishCB === 'function') {
						finishCB();
					}
				}

				_animationLoopFunction();
			})(_animationFunction);
		}

		function _initDateTouchAndAnimation(_this) {
			_drawCalenderDate(_this);

			_this.keyElement.date_container.addEventListener('touchstart', function(e) {
				var firstFinger = e.touches[0];
				_this.keyData.tempX = firstFinger.clientX;
				_this.keyData.tempY = firstFinger.clientY;
				_this.keyData.direct = 0;
			}, false);

			_this.keyElement.date_container.addEventListener('touchmove', function(e) {
				e.preventDefault();
				var firstFinger = e.touches[0],
					diffX = firstFinger.clientX - _this.keyData.tempX,
					diffY = firstFinger.clientY - _this.keyData.tempY;

				var tempPositionInfo = _getPositionInfo(_this);

				var tempNumX = tempPositionInfo.positonX + (diffX),
					tempNumY = tempPositionInfo.positonY + diffY,
					tempHeightNum = tempPositionInfo.height + diffY;

				if (_this.keyData.direct === 0) {
					_this.keyData.direct = Math.abs(diffX) > Math.abs(diffY) ? 1 : -1;
				}

				if (_this.keyData.direct === 1) {
					if (tempNumX < 0 && tempNumX > -2 * _this.keyData.calenderWidth) {
						_this.keyElement.calender_container.style.WebkitTransform = 'translateX(' + tempNumX + 'px)';

						_this.keyElement.calender_container.style.transform = 'translateX(' + tempNumX + 'px)';
					}
				} else if (_this.keyData.direct === -1) {
					if (tempNumY < 0 && tempNumY > -6 * _this.keyData.calenderHeight && tempHeightNum > _this.keyData.calenderHeight) {
						_this.keyElement.month_container.style.WebkitTransform = 'translateY(' + tempNumY + 'px)';

						_this.keyElement.month_container.style.transform = 'translateY(' + tempNumY + 'px)';
					}

					if (tempHeightNum > _this.keyData.calenderHeight && tempHeightNum < 6 * _this.keyData.calenderHeight) {
						_this.keyElement.date_container.style.height = tempHeightNum + 'px';
					}
				}

				_this.keyData.tempX = firstFinger.clientX;
				_this.keyData.tempY = firstFinger.clientY;
			}, false);

			function _redrawCalenderDate() {
				_drawCalenderDate(_this);
			}

			function removeFinger() {
				var tempPositionInfo = _getPositionInfo(_this);

				if (_this.keyData.direct === 1) {
					if (tempPositionInfo.positonX < -1.2 * _this.keyData.calenderWidth) {
						if (_this.mode === 'week') {
							_this.dateSelectObject.nextWeek();
						} else {
							_this.dateSelectObject.nextMonth();
						}
						if (typeof _this.onChange === "function") {
							_this.onChange(_this.dateSelectObject.getSelected());
						}
						_animationTo(_this, 'x', 1, _redrawCalenderDate);
					} else if (tempPositionInfo.positonX > -0.8 * _this.keyData.calenderWidth) {
						if (_this.mode === 'week') {
							_this.dateSelectObject.prevWeek();
						} else {
							_this.dateSelectObject.prevMonth();
						}
						if (typeof _this.onChange === "function") {
							_this.onChange(_this.dateSelectObject.getSelected());
						}
						_animationTo(_this, 'x', -1, _redrawCalenderDate);
					} else {
						_animationTo(_this, 'x', 0, _redrawCalenderDate);
					}
				} else if (_this.keyData.direct === -1) {
					var turnTo = _this.mode;

					if (turnTo === 'week' && (tempPositionInfo.height > _this.keyData.calenderHeight * 2)) {
						turnTo = 'month';
					} else if (turnTo === 'month' && (tempPositionInfo.height < _this.keyData.calenderHeight * 4)) {
						turnTo = 'week';
					}

					if (turnTo === 'week') {
						_this.mode = 'week';
						_animationTo(_this, 'y', 1, _redrawCalenderDate);
					} else {
						_this.mode = 'month';
						_animationTo(_this, 'y', 0, _redrawCalenderDate);
					}
				}
			}

			_this.switchMode = function() {
				if (_this.mode === 'month') {
					_this.mode = 'week';
					_animationTo(_this, 'y', 1, _redrawCalenderDate);
				} else {
					_this.mode = 'month';
					_animationTo(_this, 'y', 0, _redrawCalenderDate);
				}
			};

			_this.switchToWeek = function() {
				_this.mode = 'week';
				_animationTo(_this, 'y', 1, _redrawCalenderDate);
			};

			_this.switchToMonth = function() {
				_this.mode = 'month';
				_animationTo(_this, 'y', 0, _redrawCalenderDate);
			};

			_this.jumpToDate = function(date) {
				if (date && date.getTime) {
					_this.dateSelectObject.setSelected(date.getTime());
					_drawCalenderDate(_this);
				}
			};

			_this.getActiveDate = function(date) {
				return _this.dateSelectObject.getSelected();
			};

			_this.keyElement.date_container.addEventListener('touchend', removeFinger, false);

			_this.keyElement.date_container.addEventListener('touchcancel', removeFinger, false);

			var day_date_element_array = _this.container_element.getElementsByClassName("show-date"),
				day_date_length = day_date_element_array.length,
				i, tempHandleDateClickDate = new Date();

			function handleDateClick(e) {
				var className, indexArray, dateIndex;

				className = e.target.className;

				indexArray = className.substr(className.indexOf('date_num_') + 9, 5).split('_');

				dateIndex = parseInt(indexArray[1], 10) * 7 + parseInt(indexArray[2], 10);

				tempHandleDateClickDate.setTime(_this.dateSelectObject.getMonthCalenderDateTimeByIndex(dateIndex));


				if (tempHandleDateClickDate.getMonth() == _this.dateSelectObject.getSelected().getMonth() && tempHandleDateClickDate.getDate() == _this.dateSelectObject.getSelected().getDate()) {
					return;
				}

				_this.dateSelectObject.setSelected(tempHandleDateClickDate.getTime());

				if (typeof _this.onChange === "function") {
					_this.onChange(_this.dateSelectObject.getSelected());
				}
				_drawCalenderDate(_this);
			}

			for (i = 0; i < day_date_length; ++i) {
				day_date_element_array[i].onclick = handleDateClick;
			}

			_this.container_element.getElementsByClassName("arrowleft")[0].onclick = function(e) {
				if (_this.mode == 'week') {
					_this.dateSelectObject.prevWeek();
				} else {
					_this.dateSelectObject.prevMonth();
				}
				_animationTo(_this, 'x', -1, _redrawCalenderDate);
			};

			_this.container_element.getElementsByClassName("arrowright")[0].onclick = function(e) {
				if (_this.mode == 'week') {
					_this.dateSelectObject.nextWeek();
				} else {
					_this.dateSelectObject.nextMonth();
				}
				_animationTo(_this, 'x', 1, _redrawCalenderDate);
			};
		}

		var __this = this;

		//setTimeout(function(){
		_initDateTouchAndAnimation(__this);
		//},1200);
	}

	window.DateSelect = DateSelect;
	window.Calender = Calender;
})();

//Alert
(function(window,document,undefined){
	
	window.Alert=function(msg,params){
		/*================
		Model
		================*/
		var defaults={
			"maskClass":"mask",
			"alertClass":"alert",
			"handlerClass":"alert-handler",
			"title":"提示",
			"buttonOk":"确定",
			"buttonCancel":"取消",
			"isClickMaskHide":false
			/*
            Callbacks:
            onClick:function(Alert)
			onClickOk:function(Alert)
			onClickCancel:function(Alert)
			onClickMask:function(Alert)
			*/
		}
		params=params||{};
		for(var def in defaults){
			if(params[def]==undefined){
				params[def]=defaults[def];
			}
		}
		var s=this;
		s.params=params;
		s.container=document.body,s.alert,s.mask;
		//Mask
		s.createMask=function(){
            var mask=document.createElement("div");
            mask.setAttribute("class",s.params.maskClass);
            return mask;
        }
        //Alert
        s.createButtonCancel=function(){
        	var buttonCancel=document.createElement("a");
			buttonCancel.innerHTML=s.params.buttonCancel;
			return buttonCancel;
        }
		s.createAlert=function(){
			var alert=document.createElement("div");
			alert.setAttribute("class",s.params.alertClass);

			alert.content=document.createElement("label");
			alert.content.innerHTML=msg;

			alert.handler=document.createElement("div");
			alert.handler.setAttribute("class",s.params.handlerClass);

			//如果有取消按钮
			if(s.params.onClickCancel){
				alert.buttonCancel=s.createButtonCancel();
				alert.handler.appendChild(alert.buttonCancel);
			}
			alert.buttonOk=document.createElement("a");
			alert.buttonOk.innerHTML=s.params.buttonOk;

			alert.handler.appendChild(alert.buttonOk);
			
			if(s.params.title){
				alert.caption=document.createElement("h1");
				alert.caption.innerHTML=s.params.title;
				alert.appendChild(alert.caption);
			}

			alert.appendChild(alert.content);
			alert.appendChild(alert.handler);

			return alert;
		}
		s.create=function(){
			s.mask=s.createMask();
			s.alert=s.createAlert();
			s.container.appendChild(s.mask);
			s.container.appendChild(s.alert);
		}
		s.create();
		/*================
		Method
		================*/
		s.showMask=function(){
            s.mask.style.visibility="visible";
            s.mask.style.opacity="1";
        }
        s.hideMask=function(){
        	s.mask.style.opacity="0";
        }
        s.destoryMask=function(){
        	s.container.removeChild(s.mask);
        }
        s.showAlert=function(){
        	s.alert.style.visibility="visible";
            s.alert.style.opacity="1";
        }
        s.hideAlert=function(){
        	s.alert.style.opacity="0";
        }
        s.destoryAlert=function(){
        	s.container.removeChild(s.alert);
        }
		s.isHid=true;
		s.hide=function(){
			s.isHid=true;
			//显示遮罩
			s.hideMask();
			//显示弹出框
			s.hideAlert();
			//显示滚动条
            document.body.style.overflow="auto";
		};
		s.show=function(){
			s.isHid=false;
			//显示遮罩
			s.showMask();
			//显示弹出框
			s.showAlert();
			//禁用滚动条
            document.body.style.overflow="hidden";
		};
		s.destory=function(){
			//移动事件监听
			s.detach();
			//移除遮罩
			s.destoryMask();
			//移除弹出框
			s.destoryAlert();
			s=null;
		};
		//动态设置
		s.setText=function(msg){
			s.alert.content.innerHTML=msg;
		};
		s.setOnClick=function(fn){
        	s.params.onClick=fn;
        }
		s.setOnClickOk=function(fn){
        	s.params.onClickOk=fn;
        }
        s.setOnClickCancel=function(fn){
        	//如果没有取消按钮，创建一个
        	if(!s.params.onClickCancel){
				s.alert.buttonCancel=s.createButtonCancel();
				s.alert.handler.insertBefore(s.alert.buttonCancel,s.alert.buttonOk);
			}
        	s.params.onClickCancel=fn;
        }
		/*================
		Control
		================*/
        s.events=function(detach){
            var touchTarget=s.alert;
            var action=detach?"removeEventListener":"addEventListener";
            touchTarget[action]("click",s.onClick,false);
            touchTarget[action]("webkitTransitionEnd",s.onTransitionEnd,false);
            //遮罩
            s.mask[action]("click",s.onClickMask,false);
        }
        //attach、dettach事件
        s.attach=function(event){
            s.events();
        }
        s.detach=function(event){
            s.events(true);
        }
		s.onClick=function(e){
			s.target=e.target;
			
			if(s.params.onClick)s.params.onClick(s);
			
			if(e.target==s.alert.buttonOk){
				if(s.params.onClickOk)s.params.onClickOk(s);
				else s.hide();
			}else if(s.alert.buttonCancel && e.target==s.alert.buttonCancel){
				if(s.params.onClickCancel)s.params.onClickCancel(s);
				else s.hide();
			}
		}
		s.setOnClick=function(fn){
            s.params.onClick=fn;
        }
		s.onClickMask=function(e){
			s.target=e.target;
			if(s.params.onClickMask)s.params.onClickMask(s);
			if(s.params.isClickMaskHide)s.hide();
		}
		s.setOnClickMask=function(fn){
            s.params.onClickMask=fn;
        }
		s.onTransitionEnd=function(e){
			if(s.isHid){
				s.alert.style.visibility="hidden";
				s.mask.style.visibility="hidden";
			}
		}
		/*================
		Init
		================*/
		s.init=function(){
			s.attach();
		}
		s.init();
	}
})(window,document,undefined);

//Actionsheet
(function(window,document,undefined){
	
	window.Actionsheet=function(params){
		/*================
		Model
		================*/
		var defaults={
			maskClass:"mask",
			actionsheetClass:"actionsheet",
			groupClass:"actionsheet-group",
			buttonCancelClass:"actionsheet-cancel",
			buttonCancel:"取消",
			isClickMaskHide:true,
			data:[]
			/*
            Callbacks:
            option.onClick:function(Actionsheet)
			onClickCancel:function(Actionsheet)
			onClickMask:function(Actionsheet)
			*/
		}
		params=params||{};
		for(var def in defaults){
			if(params[def]==undefined){
				params[def]=defaults[def];
			}
		}
		var s=this;
		s.params=params;
		s.container=document.body,s.actionsheet,s.mask;
		//Mask
		s.createMask=function(){
            var mask=document.createElement("div");
            mask.setAttribute("class",s.params.maskClass);
            return mask;
        }
        //Actionsheet
        s.createActionsheet=function(){
        	var actionsheet=document.createElement("div");
        	actionsheet.setAttribute("class",s.params.actionsheetClass);

        	actionsheet.group=document.createElement("div");
        	actionsheet.group.setAttribute("class",s.params.groupClass);
        	
        	s.updateData(actionsheet);

			actionsheet.appendChild(actionsheet.group);
			//创建取消按钮
			if(s.params.buttonCancel){
				actionsheet.buttonCancel=document.createElement("a");
				actionsheet.buttonCancel.setAttribute("class",s.params.buttonCancelClass);
				actionsheet.buttonCancel.innerHTML=s.params.buttonCancel;
				
				actionsheet.appendChild(actionsheet.buttonCancel);
			}
			return actionsheet;
        }
        s.updateData=function(actionsheet){
        	actionsheet.group.innerHTML="";
        	actionsheet.options=[];
        	for(var i=0,dat;dat=s.params.data[i++];){
				var option=document.createElement("a");
				option.innerHTML=dat.text;
				option.onClick=dat.handler;
				actionsheet.options.push(option);
				actionsheet.group.appendChild(option);
			}
        }
        s.create=function(){
        	s.mask=s.createMask();
        	s.actionsheet=s.createActionsheet();
        	s.container.appendChild(s.mask);
        	s.container.appendChild(s.actionsheet);
        }
        s.create();
        //设置数据
        s.setData=function(data){
        	s.params.data=data;
        	if(s.actionsheet)s.updateData(s.actionsheet);
        	else s.createActionsheet();
        }

		/*================
		Method
		================*/
		s.showMask=function(){
            s.mask.style.visibility="visible";
            s.mask.style.opacity="1";
        }
        s.hideMask=function(){
        	s.mask.style.opacity="0";
        }
        s.destoryMask=function(){
        	s.container.removeChild(s.mask);
        }
        s.showActionsheet=function(){
        	s.actionsheet.style.webkitTransform="translate3d(0,0,0)";
        }
        s.hideActionsheet=function(){
        	s.actionsheet.style.webkitTransform="translate3d(0,100%,0)";
        }
        s.destoryActionsheet=function(){
        	s.container.removeChild(s.actionsheet);
        }

		s.isHid=true;
		s.hide=function(){
			s.isHid=true;
			//显示遮罩
			s.hideMask();
			//显示弹出框
			s.hideActionsheet();
			//显示滚动条
            document.body.style.overflow="auto";
		};
		s.show=function(){
			s.isHid=false;
			//显示遮罩
			s.showMask();
			//显示弹出框
			s.showActionsheet();
			//禁用滚动条
            document.body.style.overflow="hidden";
		};
		s.destory=function(){
			//移动事件监听
			s.detach();
			//移除遮罩
			s.destoryMask();
			//移除弹出框
			s.destoryActionsheet();
			s=null;
		};
		/*================
		Control
		================*/
        s.events=function(detach){
            var touchTarget=s.actionsheet;
            var action=detach?"removeEventListener":"addEventListener";
            touchTarget[action]("click",s.onClick,false);
            touchTarget[action]("webkitTransitionEnd",s.onTransitionEnd,false);
            //遮罩
            s.mask[action]("click",s.onClickMask,false);
        }
        //attach、dettach事件
        s.attach=function(event){
            s.events();
        }
        s.detach=function(event){
            s.events(true);
        }
        s.onClick=function(e){
        	s.target=e.target;
        	//点击容器
        	if(s.params.onClick)s.params.onClick(s);
        	//点击项
        	var options=s.actionsheet.options;
        	for(var i=0,opt;opt=options[i++];){
        		if(opt==s.target){
        			//Callback
        			opt.onClick(s);
        			return;
        		}
        	}
        	//点击取消按钮
        	if(s.params.onClickCancel && s.actionsheet.buttonCancel==s.target){
        		s.params.onClickCancel(s);
        		return;
        	}
        	s.hide();
		};
		s.setOnClick=function(fn){
            s.params.onClick=fn;
        }
		s.onClickMask=function(e){
			s.target=e.target;
			if(s.params.onClickMask)s.params.onClickMask(s);
			if(s.params.isClickMaskHide)s.hide();
		}
		s.setOnClickMask=function(fn){
            s.params.onClickMask=fn;
        }
		s.onTransitionEnd=function(e){
			if(s.isHid){
				s.mask.style.visibility="hidden";
			}
		}
		/*================
		Init
		================*/
		s.init=function(){
			s.attach();
		}
		s.init();
	}
})(window,document,undefined);

//Toast弹出框
(function(window,document,undefined){
	
	window.Toast=function(msg,params){
		/*================
		Model
		================*/
		var defaults={
			"toastBoxClass":"toast-box",
			"toastClass":"toast",
			"delay":1000
		}
		params=params||{};
		for(var def in defaults){
			if(params[def]==undefined){
				params[def]=defaults[def];
			}
		}
		var msg=msg||"";
		var s=this;
		s.params=params;
		s.container=document.body,s.toastBox,s.toast;
		s.createToastBox=function(){
			var toastBox=document.createElement("div");
			toastBox.setAttribute("class",s.params.toastBoxClass);
			return toastBox;
		}
		s.createToast=function(){
			var toast=document.createElement("div");
			toast.setAttribute("class",s.params.toastClass);
			if(msg)toast.innerHTML=msg;
			return toast;
		}
		s.create=function(){
			s.toastBox=s.createToastBox();
			s.toast=s.createToast();
			s.toastBox.appendChild(s.toast);
			s.container.appendChild(s.toastBox);
		}
		s.create();

		/*================
		Method
		================*/
		s.setText=function(msg){
			s.toast.innerHTML=msg;
		};
		s.isHid=true;
		s.hide=function(){
			s.isHid=true;
			s.toastBox.style.webkitTransform='translate3d(0,150px,0)';
		};
		s.show=function(){
			s.isHid=false;
			s.toastBox.style.webkitTransform='translate3d(0,0,0)';
		};
		s.destory=function(){
			s.detach();
			s.container.removeChild(s.toastBox);
		};
		/*================
		Controller
		================*/
		s.events=function(detach){
			var target=s.toastBox;
			var action=detach?"removeEventListener":"addEventListener";
			target[action]("webkitTransitionEnd",s.onTransitionEnd,false);
		}
		s.attach=function(){
			s.events();
		}
		s.detach=function(){
			s.events(false);
		}
		//Events Handler
		s.onTransitionEnd=function(){
			if(s.isHid){
				if(s.delayer)window.clearTimeout(s.delayer);
			}else{
				//已显示状态
				s.delayer=setTimeout(function(){
					s.hide();
				}, s.params.delay);
			}
		}
		
		/*================
		Init
		================*/
		s.init=function(){
			s.attach();
		}
		s.init();
	}
})(window,document,undefined);

//Prompt提示框
(function(window,document,undefined){
	
	window.Prompt=function(msg,params){
		/*================
		Model
		================*/
		var defaults={
			promptClass:"prompt",
			delay:1000
		}
		params=params||{};
		for(var def in defaults){
			if(params[def]==undefined){
				params[def]=defaults[def];
			}
		}
		var msg=msg||"";
		var s=this;
		s.params=params;
		//创建容器
		s.container=null;
		s.createContainer=function(){
			if(s.container)return;
			s.container=document.createElement("div");
			s.container.setAttribute("class",s.params.promptClass);
			s.container.innerHTML=msg;
			document.body.appendChild(s.container);
		}
		s.createContainer();
		/*================
		Method
		================*/
		s.setText=function(msg){
			s.container.innerHTML=msg;
		};
		s.isHid=true;
		s.hide=function(fn){
			s.isHid=true;
			s.container.style.opacity="0";
		};
		s.show=function(fn){
			s.isHid=false;
			s.container.style.visibility="visible";
			s.container.style.opacity="1";
		};
		
		/*================
		Controller
		================*/
		s.events=function(detach){
			var target=s.container;
			var action=detach?"removeEventListener":"addEventListener";
			target[action]("webkitTransitionEnd",s.onTransitionEnd,false);
		}
		s.attach=function(){
			s.events();
		}
		s.detach=function(){
			s.events(false);
		}
		//Events Handler
		s.onTransitionEnd=function(){
			if(s.isHid){
				s.container.style.visibility="hidden";
				if(s.delayer)window.clearTimeout(s.delayer);
			}else{
				//延迟时间后自动消失
				s.delayer=setTimeout(function(){
					s.hide();
				}, s.params.delay);
			}
		}
		
		/*================
		Init
		================*/
		s.init=function(){
			s.attach();
		}
		s.init();
	}
})(window,document,undefined);

//Dialog
(function(window,document,undefined){
    window.Dialog=function(wrapper,params){
        /*=========================
          Model
          ===========================*/
        var defaults={
            dialogClass:"dialog",
            maskClass:"mask",
            position:null,
            defaultPosition:"middle",
            css:{},
            maskCss:{},
            duration:300,
            isClickMaskHide:true
            /*callbacks
            onClick:function(Dialog)
            onClickMask:function(Dialog)
            onTransitionEnd:function(Dialog)
            onShowed(Dialog)//显示动画结束后回调
            onHid(Dialog)//隐藏动画结束后回调
            */
        }
        params=params||{};
        for(var def in defaults){
            if(params[def]===undefined){
                params[def]=defaults[def];
            }
        }
        //Dialog
        var s=this;

        //Params
        s.params = params;

        //Container
        s.dialog,s.mask,s.wrapper=typeof wrapper=="string"?document.querySelector(wrapper):wrapper;
        s.container=s.wrapper.parentNode;
        if(!s.wrapper)return;
        //Mask
        s.createMask=function(){
            var mask=document.createElement("div");
            mask.setAttribute("class",s.params.maskClass);
            return mask;
        }
        //ContainerBox
        s.createContainerBox=function(){
            var dialog=document.createElement("div");
            dialog.setAttribute("class",s.params.dialogClass);
            return dialog;
        }
        s.create=function(){
            //插入Dialog
            s.dialog=s.createContainerBox();
            s.container.insertBefore(s.dialog,s.wrapper);
            s.dialog.appendChild(s.wrapper);
            //插入遮罩
            s.mask=s.createMask();
            s.container.insertBefore(s.mask,s.dialog);
        }
        s.create();

        s.update=function(){
            s.wrapper.style.display="block";
            s.dialog.setAttribute("style","");
            if(s.params.position){
                s.dialog.setAttribute("data-position",s.params.position);
            }else if(s.dialog.getAttribute("data-position")){
                s.params.position=s.dialog.getAttribute("data-position");
            }else{
                s.params.position=s.params.defaultPosition;
                s.dialog.setAttribute("data-position",s.params.position);
            }
            //Dialog Css
            for(var c in s.params.css){
                s.dialog.style[c]=s.params.css[c];
            }
            //Mask Css
            for(var maskc in s.params.maskCss){
                s.mask.style[maskc]=s.params.maskCss[maskc];
            }
            switch(s.params.position){
                case "top":case "top-right":
                s.dialog.showAnimation={webkitTransform:"translate3d(0,0,0)"},
                s.dialog.hideAnimation={webkitTransform:"translate3d(0,-100%,0)"},
                s.dialog.style.webkitTransform="translate3d(0,-100%,0)";
                break;
                case "top-center":
                s.dialog.showAnimation={webkitTransform:"translate3d(-50%,0,0)"},
                s.dialog.hideAnimation={webkitTransform:"translate3d(-50%,-100%,0)"},
                s.dialog.style.webkitTransform="translate3d(-50%,-100%,0)";
                break;

                case "bottom":case "bottom-right":
                s.dialog.showAnimation={webkitTransform:"translate3d(0,0,0)"},
                s.dialog.hideAnimation={webkitTransform:"translate3d(0,100%,0)"},
                s.dialog.style.webkitTransform="translate3d(0,100%,0)";
                break;
                case "bottom-center":
                s.dialog.showAnimation={webkitTransform:"translate3d(-50%,0,0)"},
                s.dialog.hideAnimation={webkitTransform:"translate3d(-50%,100%,0)"},
                s.dialog.style.webkitTransform="translate3d(-50%,100%,0)";
                break;

                case "left":case "left-bottom":
                s.dialog.showAnimation={webkitTransform:"translate3d(0,0,0)"},
                s.dialog.hideAnimation={webkitTransform:"translate3d(-100%,0,0)"},
                s.dialog.style.webkitTransform="translate3d(-100%,0,0)";
                break;
                case "left-middle":
                s.dialog.showAnimation={webkitTransform:"translate3d(0,-50%,0)"},
                s.dialog.hideAnimation={webkitTransform:"translate3d(-100%,-50%,0)"},
                s.dialog.style.webkitTransform="translate3d(-100%,-50%,0)";
                break;

                case "right":case "right-bottom":
                s.dialog.showAnimation={webkitTransform:"translate3d(0,0,0)"},
                s.dialog.hideAnimation={webkitTransform:"translate3d(100%,0,0)"},
                s.dialog.style.webkitTransform="translate3d(100%,0,0)";
                break;

                case "right-middle":
                s.dialog.showAnimation={webkitTransform:"translate3d(0,-50%,0)"},
                s.dialog.hideAnimation={webkitTransform:"translate3d(100%,-50%,0)"},
                s.dialog.style.webkitTransform="translate3d(100%,-50%,0)";
                break;

                default:
                s.dialog.showAnimation={opacity:1},
                s.dialog.hideAnimation={opacity:0},
                s.dialog.style.opacity=0;
                break;
            }
            //设置动画毫秒数
            s.dialog.style.webkitTransitionDuration=s.params.duration+"ms";
        }
        s.update();
        /*=========================
          Method
          ===========================*/
        s.showMask=function(){
            s.mask.style.visibility="visible";
            s.mask.style.opacity="1";
        }
        s.hideMask=function(){
            s.mask.style.opacity="0";
        }
        s.destoryMask=function(){
            s.container.removeChild(s.mask);
        }
        s.showDialog=function(){
            s.dialog.style.visibility="visible";
            for(var ani in s.dialog.showAnimation){
                s.dialog.style[ani]=s.dialog.showAnimation[ani];
            }
        }
        s.hideDialog=function(){
            for(var ani in s.dialog.hideAnimation){
                s.dialog.style[ani]=s.dialog.hideAnimation[ani];
            }
        }
        s.destoryDialog=function(){
            s.container.removeChild(s.dialog);
        }
        s.isHid=true;
        s.show=function(fn){
            s.isHid=false;
            s.showMask();
            s.showDialog();
            if(fn)s.params.onShowed=fn;
            //禁用滚动条
            document.body.style.overflow="hidden";
        }
        s.hide=function(fn){
            s.isHid=true;
            s.hideMask();
            s.hideDialog();
            if(fn)s.params.onHid=fn;
            //显示滚动条
            document.body.style.overflow="auto";
        }
        s.destory=function(){
            s.destoryMask();
            s.destoryDialog();
        }
        //设置位置
        s.setPosition=function(pos){
            s.params.position=pos;
            s.update();
        }
        /*================
        Control
        ================*/
        s.events=function(detach){
            var touchTarget=s.dialog;
            var action=detach?"removeEventListener":"addEventListener";
            touchTarget[action]("click",s.onClick,false);
            touchTarget[action]("webkitTransitionEnd",s.onTransitionEnd,false);
            //遮罩
            s.mask[action]("click",s.onClickMask,false);
        }
        //attach、dettach事件
        s.attach=function(event){
            s.events();
        }
        s.detach=function(event){
            s.events(true);
        }
        s.onClick=function(e){
            s.target=e.target;
            if(s.params.onClick)s.params.onClick(s);
        }
        s.setOnClick=function(fn){
            s.params.onClick=fn;
        }
        s.onClickMask=function(e){
            s.target=e.target;
            if(s.params.onClickMask)s.params.onClickMask(s);
            if(s.params.isClickMaskHide)s.hide();
        }
        s.setOnClickMask=function(fn){
            s.params.onClickMask=fn;
        }
        s.onTransitionEnd=function(e){
            s.target=e.target;
            if(s.params.onTransitionEnd)s.params.onTransitionEnd(s);
            if(s.isHid){
                s.dialog.style.visibility="hidden";
                s.mask.style.visibility="hidden";
                if(s.params.onHid)s.params.onHid(s);
            }else{
                if(s.params.onShowed)s.params.onShowed(s);
            }
        }

        s.init=function(){
            s.attach();
        }
        s.init();
    }
})(window,document,undefined);

//Scrollpicker 滚动选择器
(function(window,document,undefined){
    window.Scrollpicker=function(params){
        /*=========================
          Model
          ===========================*/
        var defaults={
            container:null,
            headerClass:"scrollpicker-header",
            headerDoneClass:"scrollpicker-done",
            headerDoneText:"完成",
            headerCancelClass:"scrollpicker-cancel",
            headerCancelText:"取消",
            wrapperClass:"scrollpicker-wrapper",
            layerClass:"scrollpicker-layer",
            layerFrameClass:"scrollpicker-layer-frame",
            slotsClass:"scrollpicker-slots",
            slotClass:"scrollpicker-slot",
            lockClass:"lock",
            slotActiveClass:"active",
            slotListActiveClass:"active",
            cellHeight:44,
            friction:0.002,//摩擦力
            bounceRange:44,//弹性值
            isClickMaskHide:true,
            isCascade:false,//是否清除后面的值
            defaultValues:[{'key':null,'value':'----'}]

            /*callbacks
            onClickCancel:function(Scrollpicker)
            onClickDone:function(Scrollpicker)
            onScrollStart:function(Scrollpicker)
            onScroll:function(Scrollpicker)
            onScrollEnd:function(Scrollpicker)
            */
        }
        params=params||{};
        for(var def in defaults){
            if(params[def]===undefined){
                params[def]=defaults[def];
            }
        }
        //Scrollpicker
        var s=this;

        //Params
        s.params = params;

        //Dom元素
        s.container,s.mask,s.header,s.wrapper,s.slotbox,s.layer,s.headerDone,s.headerCancel;
        //槽元素与其值
        s.slots=[],s.slots.col=0,s.activeOptions=[],s.activeOption={};
        //是否渲染
        s.isRendered=false;
        /*=========================
          View
          ===========================*/
        //新建Container
        s.createContainer=function(){
            var container=document.createElement("div")
            container.setAttribute("class","scrollpicker");
            return container;
        }
        //新建Header
        s.createHeader=function(){
            var header=document.createElement("div");
            header.setAttribute("class",s.params.headerClass);
            return header;
        }
        //新建Header按钮
        s.createHeaderDone=function(){
            var headerDone=document.createElement("a");
            headerDone.setAttribute("class",s.params.headerDoneClass);
            headerDone.innerHTML=s.params.headerDoneText;
            return headerDone;
        }
        s.createHeaderCancel=function(){
            var headerCancel=document.createElement("a");
            headerCancel.setAttribute("class",s.params.headerCancelClass);
            headerCancel.innerHTML=s.params.headerCancelText;
            return headerCancel;
        }
        //新建Wrapper
        s.createWrapper=function(){
            var wrapper=document.createElement("div");
            wrapper.setAttribute("class",s.params.wrapperClass);
            return wrapper;
        }
        //新建Slotbox
        s.createSlotbox=function(){
            var slotbox=document.createElement("div");
            slotbox.setAttribute("class",s.params.slotsClass);
            return slotbox;
        }
        //新建Layer
        s.createLayer=function(){
            var layer=document.createElement("div");
            layer.setAttribute("class",s.params.layerClass);
            var layerFrame=document.createElement("div");
            layerFrame.setAttribute("class",s.params.layerFrameClass);
            layer.appendChild(layerFrame);
            return layer;
        }
        //新建Mask
        s.createMask=function(){
            var mask=document.createElement("div");
            mask.setAttribute("class","mask");
            return mask;
        }
        //新建一行List
        s.createLi=function(value,classes){
            var li=document.createElement("li");
            li.setAttribute("class",classes);
            li.innerHTML=value;
            return li;
        }
        //创建DOM
        s.create=function(){
            if(s.params.container){
                s.container=typeof container=="string"?document.querySelector(container):container;
                s.mask=s.container.previousElementSibling;
                s.header=s.container.querySelector("."+s.params.headerClass);
                s.headerDone=s.container.querySelector("."+s.params.headerDoneClass);
                s.headerCancel=s.container.querySelector("."+s.params.headerCancelClass);
                s.wrapper=s.container.querySelector("."+s.params.wrapperClass);
                s.slotbox=s.container.querySelector("."+s.params.slotsClass);
                s.layer=s.container.querySelector("."+s.params.layerClass);
            }else{
                s.container=s.createContainer();
                s.mask=s.createMask();
                s.header=s.createHeader();
                s.headerDone=s.createHeaderDone();
                s.headerCancel=s.createHeaderCancel();
                s.wrapper=s.createWrapper();
                s.slotbox=s.createSlotbox();
                s.layer=s.createLayer();

                s.header.appendChild(s.headerCancel);
                s.header.appendChild(s.headerDone);

                s.wrapper.appendChild(s.slotbox);
                s.wrapper.appendChild(s.layer);

                s.container.appendChild(s.header);
                s.container.appendChild(s.wrapper);

                document.body.appendChild(s.mask);
                document.body.appendChild(s.container);
            }
        }
        s.create();
        /*=========================
          Method
          ===========================*/
        //添加一列
        s.addSlot=function(values,classes,defaultValue){
            if (!classes){
                classes='';
            }
            //设置属性
            var slot=document.createElement("ul");
            slot.setAttribute("class",s.params.slotClass+" "+classes);
            slot.values=values;
            slot.defaultValue=defaultValue;
            slot.col=s.slots.col;
            //判断是否有锁定
            if(classes.indexOf(s.params.lockClass)>=0)slot.isLock=true;
            else slot.isLock=false;
            //渲染
            s.slots.col++;
            s.renderSlot(slot);
            s.slotbox.appendChild(slot);
            //添加到集合里
            s.slots.push(slot);
        }
        //替换一列
        s.replaceSlot=function(col,values,classes,defaultValue){
            //设置属性
            var slot=s.slots[col];
            slot.setAttribute("class",s.params.slotClass+" "+classes);
            slot.values=values;
            slot.defaultValue=defaultValue;
            //清空此列
            s.clearSlot(slot);
            //重新渲染
            s.renderSlot(slot);
            if(s.params.isCascade)clearAfterSlot(col);
        }
        //修改一列
        s.mergeSlot=function(col,values){
            //设置属性
            var slot=s.slots[col];
            slot.values=values;
            //更新此列
            s.renderSlot(slot);
        }
        //清空下列
        function clearAfterSlot(col){
            var nextCol=++col;
            var nextSlot=s.slots[nextCol];
            if(nextSlot){
                nextSlot.innerHTML="<li>"+s.params.defaultValues[0].value+"</li>"
                s.updateSlot(nextSlot);
                clearAfterSlot(nextCol);
                //设置选中项
                s.activeOptions[nextCol]=s.params.defaultValues[0];
            }
        }
        //清空一列
        s.clearSlot=function(slot){
            //初始化一列值
            slot.activeIndex=null;
            slot.defaultIndex=null;
        }
        //渲染一列
        s.renderSlot=function(slot){
            slot.innerHTML="";
            slot["list"]=[];
            var col=slot.col;
            var values=slot.values;
            var defaultValue=slot.defaultValue;
            //选中项不能超过总项数
            if(slot.activeIndex && slot.activeIndex>=values.length-1){
                slot.activeIndex=values.length-1;
            }
            //渲染
            for(var i=0,rowData;rowData=values[i];i++){
                //获得activeIndex
                if(defaultValue && defaultValue==rowData["value"]){
                    if(!slot.activeIndex){
                        slot.activeIndex=i;
                    }
                    slot.defaultIndex=i;
                }else{
                    if(!slot.activeIndex){
                        slot.activeIndex=0;
                    }
                    slot.defaultIndex=0;
                }

                //添加到选中项
                var li,liClasses="";
                if(i==slot.activeIndex){
                    liClasses="active";
                    s.activeOptions[col]=rowData;
                }

                li=s.createLi(rowData["value"],liClasses);
                slot.appendChild(li);
                slot["list"].push(li);
            }
            //更新此列
            s.updateSlot(slot);
        }
        //更新DOM数据，获得所有槽和槽内list列表
        s.updateSlot=function(slot){
            //slot["list"]=[].slice.call(slot.querySelectorAll("li"));
            slot["defaultPosY"]=-slot.defaultIndex*s.params.cellHeight;
            slot["activePosY"]=-slot.activeIndex*s.params.cellHeight;
            slot["posY"]=slot["activePosY"];
            slot["minPosY"]=0;
            slot["maxPosY"]=-(slot["list"].length-1)*s.params.cellHeight;
            slot["minBouncePosY"]=s.params.bounceRange;
            slot["maxBouncePosY"]=slot["maxPosY"]-s.params.bounceRange;
            slot.style.WebkitTransform='translate3d(0px,'+slot["activePosY"]+'px,0px)';
            slot["list"].forEach(function(n,i,arr){
                n.className="";
                if(i==slot.activeIndex){
                    n.className="active";
                }
            });
        }
        s.updateSlots=function(){
            s.slots=[].slice.call(s.container.querySelectorAll("."+s.params.slotClass));
            s.slots.forEach(function(n,i,a){
                s.clearSlot(n);
                s.renderSlot(n);
            });
        }
        
        //显示
        s.show=function(){
            if(s.isRendered==false){
                s.attach();
            }
            s.mask.style.visibility="visible";
            s.mask.style.opacity="1";
            s.container.style.WebkitTransform='translate3d(0px,0px,0px)';
        }
        //隐藏
        s.hide=function(){
            s.mask.style.opacity="0";
            s.mask.style.visibility="hidden";
            s.container.style.WebkitTransform='translate3d(0px,100%,0px)';
        }
        //重置
        s.reset=function(){
            //清空指向
            s.slots=[];
            //清空数据
            s.isRendered=false;
            s.slotbox.innerHTML="";
        }
        //清除
        s.destroy=function(){
            s.detach();
            document.body.removeChild(s.mask);
            document.body.removeChild(s.container);
        }
        
        s.slotPosY=function(slot,posY){
            slot.style.WebkitTransform='translate3d(0px,' + posY + 'px,0px)';
        }
        s.updateActiveSlot=function(xPos){
            var xPos=xPos||0;
            var slotPos=0;
            for(var i=0;i<s.slots.length;i++){
                slotPos+=s.slots[i].clientWidth;
                if (xPos<slotPos) {
                    s.activeSlot=s.slots[i];
                    s.activeSlotIndex=i;
                    break;
                }
            }
        }
        //计算惯性时间与坐标，返回距离和时间
        s.getInertance=function(distance,duration,friction){
            //使用公式算出惯性执行时间与距离
            var newDuration=(2*distance/duration)/friction;
            var newDistance=-(friction/2)*(newDuration*newDuration);
            //如果惯性执行时间为负值，则为向上拖动
            if(newDuration<0){
                newDuration=-newDuration;
                newDistance=-newDistance;
            }
            return {distance:newDistance,duration:newDuration}
        }
        var isTransitionEnd=true;//有时候原坐标和目标坐标相同时，不会执行transition事件，用此值来记录是否执行的状态
        //滚动至
        s.scrollTo=function(slot,posY,duration){
            slot.posY=posY;
            if(duration==0 || duration){
                var duration=duration;
            }else{
                duration=100;
            }
            if(posY>slot.minBouncePosY){
                slot.posY=slot.minBouncePosY;
                duration=s.sideDuration(posY,slot.minBouncePosY,duration);//计算新的执行时间
            }else if(posY<slot.maxBouncePosY){
                slot.posY=slot.maxBouncePosY;
                duration=s.sideDuration(posY,slot.maxBouncePosY,duration);//计算新的执行时间
            }
            slot.style.webkitTransitionDuration=duration+"ms";
            slot.style.WebkitTransform='translate3d(0px,' + slot.posY + 'px,0px)';
            //如果不执行onTransitionEnd
            if(isTransitionEnd==false || duration==0){
                s.onTransitionEnd();
                isTransitionEnd=true;
            }
        }
        //计算超出边缘时新的时间
        s.sideDuration=function(posY,bouncePosY,duration){
            return Math.round(duration/(posY/bouncePosY));
        }
        //更新列表激活状态
        s.updateActiveList=function(posY){
            var index=-Math.round((posY-s.params.cellHeight*2)/s.params.cellHeight)-2;
            s.activeSlot.list.forEach(function(n,i,a){
                n.classList.remove("active");
                if(i==index){
                    n.classList.add("active");
                    //s.activeNode=n;
                }
            });
            //添加到激活项
            s.activeOption=s.slots[s.activeSlotIndex].values[index];
            s.activeOptions[s.activeSlotIndex]=s.activeOption;
            //设置选中项
            s.slots[s.activeSlotIndex].activeIndex=index;
        }
        //位置矫正
        s.posCorrect=function(){
            s.activeSlot.style.webkitTransitionDuration='500ms';
            var remainder=s.activeSlot.posY%s.params.cellHeight;
            if(remainder!=0){
                //算出比例
                var divided=Math.round(s.activeSlot.posY/s.params.cellHeight);
                //对准位置
                var top=s.params.cellHeight*divided;
                s.activeSlot.posY=top;
                s.activeSlot.style.WebkitTransform='translate3d(0px,' + top + 'px,0px)';
            }
            s.updateActiveList(s.activeSlot.posY);
            //动画时间回0
            s.activeSlot.style.webkitTransitionDuration='0ms';
            //Callback
            if(s.params.onScrollEnd)s.params.onScrollEnd(s);
        }
        /*=========================
          Control
          ===========================*/
        s.events=function(detach){
            var touchTarget=s.layer;
            var action=detach?"removeEventListener":"addEventListener";
            touchTarget[action]("touchstart",s.onTouchStart,false);
            touchTarget[action]("touchmove",s.onTouchMove,false);
            touchTarget[action]("touchend",s.onTouchEnd,false);
            touchTarget[action]("touchcancel",s.onTouchEnd,false);
            //preventDefault
            s.mask[action]("touchmove",preventDefault,false);
            s.header[action]("touchmove",preventDefault,false);
            touchTarget[action]("touchmove",preventDefault,false);
            //transitionEnd
            s.slots.forEach(function(n,i,a){
                n[action]("webkitTransitionEnd",s.onTransitionEnd,false);
            });
            //mask
            if(s.params.isClickMaskHide==true)s.mask[action]("click",s.hide,false);
            //确定和取消按钮
            if(s.params.onClickDone)s.headerDone[action]("click",s.onClickDone,false);
            if(s.params.onClickCancel)s.headerCancel[action]("click",s.onClickCancel,false);
        }
        //attach、dettach事件
        s.attach=function(event){
            s.events();
        }
        s.detach=function(event){
            s.events(true);
        }
        function preventDefault(e){
            e.preventDefault();
        }
        //取消和确定按钮
        s.onClickDone=function(e){
            s.target=e.target;
            s.params.onClickDone(s);
        }
        s.onClickCancel=function(e){
            s.target=e.target;
            s.params.onClickCancel(s);
        }
        //添加和删除取消和确定按钮点击
        s.setOnClickDone=function(callback){
            s.params.onClickDone=callback;
            s.headerDone.addEventListener("click",onClickDoneCallback,false);
        }
        s.removeOnClickDone=function(){
            s.params.onClickDone=null;
            s.headerDone.removeEventListener("click",onClickDoneCallback,false);
        }
        function onClickDoneCallback(e){
            s.target=e.target;
            s.params.onClickDone(s)
        };
        s.setOnClickCancel=function(callback){
            s.params.onClickCancel=callback;
            s.headerCancel.addEventListener("click",onClickCancelCallback,false);
        }
        s.removeOnClickCancel=function(){
            s.params.onClickCancel=null;
            s.headerCancel.removeEventListener("click",onClickCancelCallback,false);
        }
        function onClickCancelCallback(e){
            s.target=e.target;
            s.params.onClickCancel(s)
        };
        s.touches={
            startX:0,
            startY:0,
            currentX:0,
            currentY:0,
            endX:0,
            endY:0,
            startTimeStamp:0,
            duration:0,
            diffX:0,
            diffY:0,
            direction:null
        };
        //触摸事件
        s.onTouchStart=function(e){
            //s.layer.addEventListener("touchmove",preventDefault,false);
            s.touches.startX=e.touches[0].clientX;
            s.touches.startY=e.touches[0].clientY;
            //寻找当前点击的槽
            s.updateActiveSlot(s.touches.startX);
            //记录点击时间
            s.touches.startTimeStamp=e.timeStamp;
            //Callback
            if(s.params.onScrollStart)s.params.onScrollStart(s);
        }
        s.onTouchMove=function(e){
            if(s.activeSlot.isLock)return;
            s.touches.currentY=e.touches[0].clientY;
            s.touches.diffY=s.touches.startY-s.touches.currentY;
            s.activeSlot.moveY=s.activeSlot.posY-s.touches.diffY;
            if(s.activeSlot.moveY>s.activeSlot.minBouncePosY){
                s.activeSlot.moveY=s.activeSlot.minBouncePosY;
            }else if(s.activeSlot.moveY<s.activeSlot.maxBouncePosY){
                s.activeSlot.moveY=s.activeSlot.maxBouncePosY;
            }
            s.activeSlot.style.WebkitTransform='translate3d(0px,' + s.activeSlot.moveY + 'px,0px)';
            s.updateActiveList(s.activeSlot.moveY);

            //Callback
            if(s.params.onScroll)s.params.onScroll(s);
        }
        s.onTouchEnd=function(e){
            if(s.activeSlot.isLock)return;
            //判断是否是tap
            s.touches.endX=e.changedTouches[0].clientX;
            s.touches.endY=e.changedTouches[0].clientY;
            s.touches.diffX=s.touches.startX-s.touches.endX;
            s.touches.diffY=s.touches.startY-s.touches.endY;
            if(Math.abs(s.touches.diffX) < 6 && Math.abs(s.touches.diffY) < 6 ){
                return;
            }
            //设置当前坐标值
            s.activeSlot.posY=s.activeSlot.moveY;
            //计算拖动时间
            s.touches.duration=e.timeStamp-s.touches.startTimeStamp;
            //惯性值计算
            var inertance=s.getInertance(s.touches.diffY,s.touches.duration,s.params.friction);
            //惯性Y坐标
            var newPosY=s.activeSlot.posY + inertance.distance;
            //如果原坐标和目标坐标相同，则不执行transitionEnd
            if(s.activeSlot.moveY==s.activeSlot.minBouncePosY || s.activeSlot.moveY==s.activeSlot.maxBouncePosY){
                isTransitionEnd=false;
            }
            //滚动到指定位置
            s.scrollTo(s.activeSlot,newPosY,inertance.duration);
        }
        //惯性滚动结束后
        s.onTransitionEnd=function(){
            //如果跑到边界之外回到圈内
            if (s.activeSlot.posY > 0){
                s.activeSlot.posY=0;
            }else if(s.activeSlot.posY < s.activeSlot.maxPosY) {
                s.activeSlot.posY=s.activeSlot.maxPosY;
            }
            s.activeSlot.style.WebkitTransform='translate3d(0px,' + s.activeSlot.posY + 'px,0px)';
            //位置矫正
            s.posCorrect();
        }
        function init(){
            if(s.params.container){
                s.attach();
            }
        }
        init();
    }
})(window,document,undefined);

//SpDate 扩展scrollpicker日期控件
(function(window,document,undefined){
	window.SpDate=function(params){
		/*================
	    Model
	    ==================*/
		var defaults={
			"viewType":"date",//"date","month","time","datetime"
			"yearsData":null,
			"monthsData":null,
			"daysData":null,
			"hoursData":null,
			"minutesData":null,

			"yearClass":null,
			"monthClass":null,
			"dayClass":null,
			"hourClass":null,
			"minuteClass":null,

			"yearDefault":null,
			"monthDefault":null,
			"dayDefault":null,
			"hourDefault":null,
			"minuteDefault":null,

			"yyUnit":"年",
			"MMUnit":"月",
			"ddUnit":"日",
			"hhUnit":"时",
			"mmUnit":"分",

			/*callbacks
			onClickDone:function(SpDate)
			onClickCancel:function(SpDate)
			*/
		}
		params=params||{};
		for(var def in defaults){
			if(params[def]===undefined){
				params[def]=defaults[def];
			}
		}
		//SpDate
		var s=this;

		//Params
		s.params = params;

		//Date
	    s.date = new Date();
	    s.currents={},s.defaults={},s.classes={};
	    s.updateDatetime=function(){
	    	//当前值
	    	s.currents.year=s.date.year();
		    s.currents.month=s.date.month();
		    s.currents.day=s.date.day();
		    s.currents.hour=s.date.hour();
		    s.currents.minute=s.date.minute();
		    //默认值
		    s.defaults.year=s.currents.year+s.params.yyUnit;
		    s.defaults.month=s.currents.month+s.params.MMUnit;
		    s.defaults.day=s.currents.day+s.params.ddUnit;
		    s.defaults.hour=s.currents.hour+s.params.hhUnit;
		    s.defaults.minute=s.currents.minute+s.params.mmUnit;
		    //样式值
		    s.classes.year=s.params.yearClass||"";
		    s.classes.month=s.params.monthClass||"";
		    s.classes.day=s.params.dayClass||"";
		    s.classes.hour=s.params.hourClass||"";
		    s.classes.minute=s.params.minuteClass||"";
	    }
	    s.updateDatetime();

	    //年
	    s.years=[];
	    if(s.params.yearsData){
	    	s.years=s.params.yearsData;
	    }else{
		    for(var y=s.currents.year-5;y<=s.currents.year+5;y++){
		    	s.years.push({"key":y,"value":y+s.params.yyUnit,"flag":"date"});
		    }
	    }
	    //月
	    s.months=[];
	    if(s.params.monthsData){
	    	s.months=s.params.monthsData;
	    }else{
	    	for(var m=1;m<=12;m++){
		    	s.months.push({"key":m,"value":m+s.params.MMUnit,"flag":"date"});
		    }
	    }
	    
	    //日
	    s.days=[];
	    if(s.params.daysData){
	    	s.days=s.params.daysData;
	    }else{
	    	for(var d=1;d<=s.date.days();d++){
		    	s.days.push({"key":d,"value":d+s.params.ddUnit,"flag":"date"});
		    }
	    }
	    function replaceDays(maxDay){
	    	s.days=[];
	    	for(var d=1;d<=maxDay;d++){
		    	s.days.push({"key":d,"value":d+s.params.ddUnit,"flag":"date"});
		    }
	    }

	    //时
	    s.hours=[];
	    if(s.params.daysData){
	    	s.hours=s.params.hoursData;
	    }else{
	    	for(var hour=1;hour<=24;hour++){
		        s.hours.push({"key":hour,"value":hour+s.params.hhUnit,"flag":"time"});
		    }
	    }
	    
	    //分
	    s.minutes=[];
	    if(s.params.minutesData){
	    	s.minutes=s.params.minutesData;
	    }else{
	    	for(var minute=1;minute<=60;minute++){
		        s.minutes.push({"key":minute,"value":minute+s.params.mmUnit,"flag":"time"});
		    }
	    }

	    /*================
	    Method
	    ==================*/
	    s.show=function(){
	    	datetimeSp.show();
	    }
	    s.getActiveText=function(activeData){
	    	var activeText="";
	    	var dateArr=[];
	    	var timeArr=[];
	    	activeData.forEach(function(n,i,a){
	    		if(n["flag"]=="date")dateArr.push(n);
                else if(n["flag"]=="time")timeArr.push(n);
                else timeArr.push(n);
            });
            dateArr.forEach(function(n,i,a){
            	if(i==dateArr.length-1){
            		activeText+=n["key"];
            	}else{
            		activeText+=n["key"]+"-";
            	}
            })
            if(activeText!=""){
        		activeText+=" ";
        	}
            timeArr.forEach(function(n,i,a){
            	if(i==timeArr.length-1){
            		activeText+=n["key"];
            	}else{
            		activeText+=n["key"]+":";
            	}
            })
            return activeText;
	    }
	    s.setOnClickDone=function(fn){
	    	s.params.onClickDone=fn;
	    }
	    s.setOnClickCancel=function(fn){
	    	s.params.onClickCancel=fn;
	    }
	    /*================
	    Control
	    ==================*/
	    //滑动面板初始化
	    var datetimeSp=new Scrollpicker({
	    	"onClickDone":function(e){
	    		e.activeText=s.getActiveText(e.activeOptions);
	    		if(s.params.onClickDone)s.params.onClickDone(e);
	    	},
	        "onClickCancel":function(e){
	        	e.activeText=s.getActiveText(e.activeOptions);
	            if(s.params.onClickCancel)s.params.onClickCancel(e);
	            else e.hide();
	            //还原为初始状态
	            //e.updateSlots()
	            //清空数据再注入
	            /*e.reset();
	            addSlot();*/
	        },
	    	"onScrollEnd":function(e){
	    		if((s.params.viewType=="date" || s.params.viewType=="datetime") && e.activeSlotIndex!=2){
	    			var year=e.activeOptions[0]["key"];
					var month=e.activeOptions[1]["key"];
					var maxDay=s.date.days(year,month);
					replaceDays(maxDay);//更新总天数
					renderDay();//渲染天
	    		}
	    	}
	    });
	    function renderDay(){
			datetimeSp.mergeSlot(2,s.days);//修改第三项
		}

	    //添加数据
	    function addMonthSlot(){
	    	datetimeSp.addSlot(s.years,s.classes.year,s.defaults.year);
	        datetimeSp.addSlot(s.months,s.classes.month,s.defaults.month);
	    }
	    function addDateSlot(){
	    	addMonthSlot();
	        datetimeSp.addSlot(s.days,s.classes.day,s.defaults.day);
	    }
	    function addTimeSlot(){
	    	datetimeSp.addSlot(s.hours,s.classes.hour,s.defaults.hour);
	        datetimeSp.addSlot(s.minutes,s.classes.minute,s.defaults.minute);
	    }
	    function addDateTime(){
	    	addDateSlot();
	    	addTimeSlot()
	    }
	    function addSlot(){
	        switch(s.params.viewType){
	        	case "date":addDateSlot();break;
	        	case "month":addMonthSlot();break;
	        	case "time":addTimeSlot();break;
	        	case "datetime":addDateTime();break;
	        }
	    }
	    addSlot();
	}
})(window,document,undefined);

//SpCity 扩展scrollpicker地区控件
(function(window,document,undefined){
	window.SpCity=function(params){
		/*================
	    Model
	    ==================*/
		var defaults={
			viewType:"city",//"city","area"
			data:null,
			defaultValue:"----",
			provinceClass:"",
			cityClass:"",
			areaClass:""

			/*callbacks
			onClickDone:function(SpDate)
			onClickCancel:function(SpDate)
			*/
		}
		params=params||{};
		for(var def in defaults){
			if(params[def]===undefined){
				params[def]=defaults[def];
			}
		}
		//SpCity
		var s=this;

		//Params
		s.params = params;

		//Data
		s.data=s.params.data;
		if(!s.data)return;

		//初始化数据
		var province=[],city=[];
		s.data.forEach(function(n,i,a){
			province.push(n);
			if(i==0){
				city=n.children;
			}
		})
		/*================
	    Method
	    ==================*/
		s.show=function(){
			citySp.show();
		}
		s.getActiveText=function(activeData){
	    	var activeText="";
	    	var cityArr=activeData.filter(function(n,i,a){
	    		return n["value"]!=s.params.defaultValue;
			});
			cityArr.forEach(function(n,i,a){
				if(i==cityArr.length-1){
	        		activeText+=n["value"];
	        	}else{
	        		activeText+=n["value"]+"-";
	        	}
			})
	        return activeText;
	    }
		s.setOnClickDone=function(fn){
	    	s.params.onClickDone=fn;
	    }
	    s.setOnClickCancel=function(fn){
	    	s.params.onClickCancel=fn;
	    }
		/*================
	    Control
	    ==================*/
		//初始化滚动控件
		var citySp=new Scrollpicker({
			"isCascade":true,//是否开启级联更新
			"onClickDone":function(e){
				e.activeText=s.getActiveText(e.activeOptions);
		    	if(s.params.onClickDone)s.params.onClickDone(e);
	    		var activeText="";
	    	},
	    	"onClickCancel":function(e){
	    		e.activeText=s.getActiveText(e.activeOptions);
	            if(s.params.onClickCancel)s.params.onClickCancel(e);
	            else e.hide();
	            //还原为初始状态
	            //e.updateSlots()
	            //清空数据再注入
	            /*e.reset();
	            addSlot();*/
	    	},
			"onScrollEnd":function(e){
				renderAfter(e.activeSlotIndex);
				function renderAfter(index){
					//获得当前选中数据
					var nextSlotIndex=index+1;
					var slot=e.slots[index];
					var activeIndex=slot.activeIndex;
					var childrenData=slot.values[activeIndex].children;
					if(s.params.viewType=="city"){
						if(nextSlotIndex>=2){
							return;
						}
					}
					//如果有子级
		    		if(childrenData){
		    			//修改下一列数据
		    			e.replaceSlot(nextSlotIndex,childrenData,'text-center citycol');
		    			//递归
		    			renderAfter(nextSlotIndex);
		    		}
				}
	    	}
		});
		function addSlot(){
			citySp.addSlot(province,s.params.provinceClass);
			citySp.addSlot(city,s.params.cityClass);
			if(s.params.viewType=="area"){
				citySp.addSlot([{'key':'-','value':s.params.defaultValue}],s.params.areaClass);
			}
		}
		addSlot();
		/*function openWeight() {
			citySp.show();
		}*/
	}
})(window,document,undefined);

//Tree 树结构
(function(window,document,undefined){
window.Tree=function(container,params){
    /*=========================
      Model
      ===========================*/
    var defaults={
        "addButton":"[data-click=add]",
        "removeButton":"[data-click=remove]",
        "selectedContainer":null,
        "optionClass":"mark-grayscale",
        "extandClass":"extand",
        "collapseClass":"collapse",
        "liconClass":"tree-licon",
        "riconClass":"tree-ricon",
        "ticonClass":"tree-ticon",
        "rightClass":"tree-right",
        "titleClass":"tree-title",
        "dataId":"data-id",
        "dataName":"data-name",
        "listClass":"tree-line",
        "listActiveClass":"active"
        /*callbacks
        onTap:function(Tree)
        onTapLastChild:function(Tree)
        */
    }
    params=params||{};
    for(var def in defaults){
        if(params[def]===undefined){
            params[def]=defaults[def];
        }
    }
    //Tree
    var s=this;

    //Params
    s.params = params;
    
    //Container
    s.container=typeof container=="string"?document.querySelector(container):container;
    if(!s.container)return;

    //SelectedContainer
    if(s.params.selectedContainer){
        s.selectedContainer=typeof s.params.selectedContainer=="string"?document.querySelector(s.params.selectedContainer):s.params.selectedContainer;
    }

    //AddButton
    s.addButtonKey=s.params.addButton.substring(s.params.addButton.indexOf("[")+1,s.params.addButton.indexOf("="));
    s.addButtonVal=s.params.addButton.substring(s.params.addButton.indexOf("=")+1,s.params.addButton.length-1);

    //RemoveButton
    s.removeButtonKey=s.params.removeButton.substring(s.params.removeButton.indexOf("[")+1,s.params.removeButton.indexOf("="));
    s.removeButtonVal=s.params.removeButton.substring(s.params.removeButton.indexOf("=")+1,s.params.removeButton.length-1);

    //SelectedContainer
    if(s.params.selectedContainer){
        s.selectedContainer=typeof s.params.selectedContainer=="string"?document.querySelector(s.params.selectedContainer):s.params.selectedContainer;
    }

    //SelectedEl
    s.selected={};

    /*=========================
      Method
      ===========================*/
    //根据id获取树元素
    s.getTreeNodeById=function(id){
        return s.container.querySelector("["+s.params.dataId+"="+id+"]");
    }
    //根据id获得选中容器元素
    s.getSelNodeById=function(id){
        return s.selectedContainer.querySelector("["+s.params.dataId+"="+id+"]");
    }
    //显示选中项
    s.showSelected=function(){
        s.selectedContainer.style.display="block";
    }
    //隐藏选中项
    s.hideSelected=function(){
        s.selectedContainer.style.display="none";
    }
    //显示添加按钮
    s.showAddBtn=function(id){
        var node=s.getTreeNodeById(id);
        var addBtns=[].slice.call(node.parentNode.querySelectorAll(s.params.addButton));
        addBtns.forEach(function(n,i,a){
            n.style.display="block";
        })
    }
    //隐藏添加按钮
    s.hideAddBtn=function(id){
        var addBtns=[].slice.call(node.parentNode.querySelectorAll(s.params.addButton));
        addBtns.forEach(function(n,i,a){
            n.style.display="none";
        })
    }
    //创建选中项
    s.createSelectedOption=function(id,name){
        //var span='<span class="mark-grayscale" data-id="'+treeID+'" data-name="'+treeName+'">'+treeName+'<a class="icon-clear-fill delete-selection"></a></span>';
        var option=document.createElement("span");
        option.setAttribute("class",s.params.optionClass);
        option.setAttribute(s.params.dataId,id);
        option.setAttribute(s.params.dataName,name);
        var optionText=''+name+'<a data-click="remove" class="icon-clear-fill delete-selection"></a>';
        option.innerHTML=optionText;
        return option;
    }
    //添加到选中项
    s.addSelected=function(id,node){
        if(JSON.stringify(s.selected)=="{}"){
            var isFirst=true;
        }
        s.selected[id]=node;
        s.addSelectedNode(id,node);

        if(isFirst)s.showSelected();
    }
    //添加到选中容器
    s.addSelectedNode=function(id,node){
        var name=node.getAttribute(s.params.dataName);
        var option=s.createSelectedOption(id,name);
        s.selectedContainer.appendChild(option);
        
    }
    //删除选中项
    s.removeSelected=function(id){
        if(s.selected[id])delete s.selected[id];
        if(JSON.stringify(s.selected)=="{}"){
            s.hideSelected();
        }
        s.removeSelectedNode(id);
    }
    //选中容器删除选中项
    s.removeSelectedNode=function(id){
        var node=s.getSelNodeById(id);
        if(!node)return;
        s.selectedContainer.removeChild(node);
        //删除树选中状态
        var treeNode=s.getTreeNodeById(id);
        treeNode.classList.remove(s.params.listActiveClass);
    }
    //展开与收缩
    s.toggleCollection=function(targetList){
        if(targetList.classList.contains(s.params.extandClass)){
            targetList.classList.remove(s.params.extandClass);
        }else{
            targetList.classList.add(s.params.extandClass);
        }
    }
    //选中
    s.toggleActive=function(targetList,isActive){
        if(!isActive || targetList.classList.contains(s.params.listActiveClass)){
            targetList.classList.remove(s.params.listActiveClass);
        }else{
            targetList.classList.add(s.params.listActiveClass);
        }
    }
    /*=========================
      Control
      ===========================*/
    //绑定事件
    s.events=function(detach){
        //树结构
        var treeTarget=s.container;
        var action=detach?"removeHandler":"addHandler";
        EventUtil[action](treeTarget,"tap",s.onTapTree);
        //选中容器
        var action2=detach?"removeEventListener":"addEventListener";
        if(s.selectedContainer)s.selectedContainer[action2]("click",s.onClickRemoveBtn,false);
    }
    //attach、dettach事件
    s.attach=function(event){
        s.events();
    }
    s.detach=function(event){
        s.events(true);
    }
    //点击树
    s.onTapTree=function(e){
        //点击树
        s.targetLi,s.targetLine,s.target=e.target;
        
        if(s.target.classList.contains(s.params.listClass)){//点击二级
            s.targetLine=s.target;
            s.targetLi=s.target.parentNode;
        }else if(s.target.classList.contains(s.params.liconClass)||
        s.target.classList.contains(s.params.riconClass)||
        s.target.classList.contains(s.params.ticonClass)||
        s.target.classList.contains(s.params.rightClass)||
        s.target.classList.contains(s.params.titleClass)){//点击三级
            s.targetLine=s.target.parentNode;
            s.targetLi=s.target.parentNode.parentNode;
        }

        //点击添加
        if(s.target.getAttribute(s.addButtonKey)==s.addButtonVal){
            s.onClickAddBtn(s.targetLi);
            //Callback onTap
            if(s.params.onTap)s.params.onTap(s);
            return;
        }

        //点击底层
        if(!s.targetLine.nextElementSibling){
            //Callback
            if(s.params.onTapLastChild)s.params.onTapLastChild(s);
        }
        //展开与收缩
        s.toggleCollection(s.targetLine);
        //Callback onTap
        if(s.params.onTap)s.params.onTap(s);
    }

    //点击添加按钮
    s.onClickAddBtn=function(elLi){
        var elLists=elLi.querySelectorAll("."+s.params.listClass);
        //选中的节点
        var activeList=elLists[0];
        //当前及以下的添加按钮
        var addBtns=elLi.querySelectorAll(s.params.addButton);
        for(var i=0;i<elLists.length;i++){
            var id=elLists[i].getAttribute(s.params.dataId);
            //隐藏添加按钮
            addBtns[i].style.display="none";
            //删除所有选中的子节点
            s.removeSelected(id);
        }
        //添加到选中项
        s.addSelected(activeList.getAttribute(s.params.dataId),activeList);
        //选中当前项
        s.toggleActive(activeList,true);
    }

    //点击选中节点框
    s.onClickRemoveBtn=function(e){
        s.target=e.target;
        if(s.target.getAttribute(s.removeButtonKey)==s.removeButtonVal){
            var id=s.target.parentNode.getAttribute(s.params.dataId);
            //删除选中容器内的标签
            s.removeSelected(id);
            console.log(id);
            //显示添加按钮
            s.showAddBtn(id);
        }
    }

    //主函数
    s.init=function(){
        s.attach();
    }
    s.init();
}
})(window,document,undefined);

//Indexbar
(function(window,document,undefined){
	window.Indexbar=function(container,params){
		/*=========================
          Params
          ===========================*/
		var defaults={
			"indexbarClass":"indexbar",
			"indexbarActiveClass":"active",
			"indexActiveClass":"active",
			"toolTipClass":"indexbar-tooltip",
			"indexlistClass":"indexlist"
		}
		params=params||{};
		for(var def in defaults){
			if(params[def]===undefined){
				params[def]=defaults[def];
			}
		}
		//Indexbar
		var s=this;

		//Params
		s.params = params;

		//Container
		s.container=typeof container=="string"?document.querySelector(container):container;
		if(!s.container)return;

		//IndexList
		s.indexList=s.container.querySelector("."+s.params.indexlistClass);

		//IndexbarContainer
		s.indexBar,s.toolTip;
		s.createIndexBar=function(){
			var indexBar=document.createElement("div")
            indexBar.setAttribute("class",s.params.indexbarClass);
            return indexBar;
		}
		var arrIndexChar=["A","B","C","D","E","F","G","H","I","G","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"];
		s.createIndexs=function(){
			var indexs=[];
			arrIndexChar.forEach(function(n,i,a){
				var indexChar=document.createElement("a");
				indexChar.innerHTML=n;
				indexs.push(indexChar);
			});
            return indexs;
		}
		s.createToolTip=function(){
			var toolTip=document.createElement("div")
            toolTip.setAttribute("class",s.params.toolTipClass);
            return toolTip;
		}
		s.create=function(){
			s.indexBar=s.createIndexBar();
			s.indexs=s.createIndexs();
			s.indexs.forEach(function(n,i,a){
				s.indexBar.appendChild(n);
			});
			s.toolTip=s.createToolTip();
			s.container.appendChild(s.indexBar);
			s.container.appendChild(s.toolTip);
		}
		s.create();

		//Indexs
		s.indexs=s.indexBar.querySelectorAll("a");
		s.updateContainerSize=function(){
			s.indexHeight=s.indexBar.clientHeight/s.indexs.length;
			[].slice.call(s.indexs).forEach(function(n,i,a){
				n.style.height=s.indexHeight+"px";
				n.style.lineHeight=s.indexHeight+"px";
			})
		}
		s.updateContainerSize();

		//Tooltip
		s.tooltip=s.indexBar.parentNode.querySelector("."+s.params.toolTipClass);


		//Controller
		/*=========================
          Touch Events
          ===========================*/
		//body事件绑定
		var touchTarget=s.container;
		s.events=function(detach){
			var action=detach?"removeEventListener":"addEventListener";
			touchTarget[action]("touchmove",s.onTouchMove,false);
			touchTarget[action]("touchend",s.onTouchEnd,false);
			touchTarget[action]("touchcancel",s.onTouchEnd,false);
		}
		//attach、dettach事件
		s.attach=function(event){
			s.events();
		}
		s.detach=function(event){
			s.events(true);
		}
		/*=========================
          Touch Handler
          ===========================*/
        //Touch信息
        s.touches={
        	startX:0,
        	startY:0,
        	currentX:0,
        	currentY:0,
        	endX:0,
        	endY:0
        };
        //索引
        function preventDefault(e){
			e.preventDefault();
		}
		s.onTouchMove=function(e){
			s.touches.currentY=e.touches[0].clientY;
			s.goIndex(s.touches.currentY);
		};
		s.onTouchEnd=function(e){
			touchTarget.removeEventListener("touchmove",preventDefault,false);
			s.detach();
			//移除激活indexbar
			s.indexBar.classList.remove(s.params.indexbarActiveClass);
		};
		s.indexBar.addEventListener("touchstart",function(e){
			touchTarget.addEventListener("touchmove",preventDefault,false);
			s.touches.startX=e.touches[0].clientX;
			s.touches.startY=e.touches[0].clientY;
			//给body绑定触摸事件
			s.attach();
			//滚动到指定位置
			s.goIndex(s.touches.startY);
			//激活indexbar
			s.indexBar.classList.add(s.params.indexbarActiveClass);
		},false);
		/*=========================
          Method
          ===========================*/
        s.indexHTML="A";
        s.goIndex=function(y){
        	//修改文字
        	s.index=document.elementFromPoint(s.touches.startX,y);
        	if(!s.index.parentNode || s.index.parentNode!=s.indexBar)return;
        	s.indexHTML=s.index.innerHTML;
        	s.tooltip.innerHTML=s.indexHTML;
        	s.indexLI=s.container.querySelector('[data-index='+s.indexHTML+']');
        	//移动位置
        	if(s.indexLI)s.indexList.scrollTop=s.indexLI.offsetTop-s.indexList.offsetTop;
        }
	}
})(window,document,undefined);

//Loading
(function(window,document,undefined){
	
	window.Loading=function(loadContainer,maskContainer,params){
		/*================
		Model
		================*/
		var defaults={
			"maskClass":"mask",
			"loadingBoxClass":"loading-box",
			"loadingClass":"loading",
			"isClickMaskHide":false
			/*
            Callbacks:
            onClick:function(Loading)
			*/
		}
		params=params||{};
		for(var def in defaults){
			if(params[def]==undefined){
				params[def]=defaults[def];
			}
		}
		var s=this;
		s.params=params;
		s.container=document.body,s.mask,s.loadingBox;
		//Mask
		s.createMask=function(){
            var mask=document.createElement("div");
            mask.setAttribute("class",s.params.maskClass);
            return mask;
        }
        //LoadingBox
		s.createLoadingBox=function(){
			var loadingBox=document.createElement("div");
			loadingBox.setAttribute("class",s.params.loadingBoxClass);

			loadingBox.loading=document.createElement("div");
			loadingBox.loading.setAttribute("class",s.params.loadingClass);

			loadingBox.appendChild(loadingBox.loading);

			return loadingBox;
		}
		s.create=function(){
			if(loadContainer){
				s.loadingBox=typeof loadContainer=="string"?document.querySelector(loadContainer):loadContainer;
			}else{
				s.loadingBox=s.createLoadingBox();
				s.container.appendChild(s.loadingBox);
			}

			if(maskContainer){
				s.mask=typeof maskContainer=="string"?document.querySelector(maskContainer):maskContainer;
			}else{
				s.mask=s.createMask();
				s.container.insertBefore(s.mask,s.loadingBox);
			}
		}
		s.create();
		/*================
		Method
		================*/
		s.showMask=function(){
            s.mask.style.visibility="visible";
            s.mask.style.opacity="1";
        }
        s.hideMask=function(){
        	s.mask.style.opacity="0";
        }
        s.destoryMask=function(){
        	s.container.removeChild(s.mask);
        }
        s.showLoading=function(){
        	s.loadingBox.style.visibility="visible";
            s.loadingBox.style.opacity="1";
        }
        s.hideLoading=function(){
        	s.loadingBox.style.opacity="0";
        }
        s.destoryLoading=function(){
        	s.container.removeChild(s.loadingBox);
        }
		s.isHid=true;
		s.hide=function(){
			s.isHid=true;
			//显示遮罩
			s.hideMask();
			//显示弹出框
			s.hideLoading();
		};
		s.show=function(){
			s.isHid=false;
			//显示遮罩
			s.showMask();
			//显示弹出框
			s.showLoading();
		};
		s.destory=function(){
			//移动事件监听
			s.detach();
			//移除遮罩
			s.destoryMask();
			//移除弹出框
			s.destoryLoading();
			s=null;
		};
		//动态设置
		s.setOnClick=function(fn){
        	s.params.onClick=fn;
        }
		/*================
		Control
		================*/
        s.events=function(detach){
            var touchTarget=s.loadingBox;
            var action=detach?"removeEventListener":"addEventListener";
            touchTarget[action]("click",s.onClick,false);
            touchTarget[action]("webkitTransitionEnd",s.onTransitionEnd,false);
            //遮罩
            s.mask[action]("click",s.onClickMask,false);
        }
        //attach、dettach事件
        s.attach=function(event){
            s.events();
        }
        s.detach=function(event){
            s.events(true);
        }
		s.onClick=function(e){
			s.target=e.target;
			if(s.params.onClick)s.params.onClick(s);
		}
		s.onClickMask=function(){
			if(s.params.isClickMaskHide)s.hide();
		}
		s.onTransitionEnd=function(e){
			if(s.isHid){
				s.loadingBox.style.visibility="hidden";
				s.mask.style.visibility="hidden";
			}
		}
		/*================
		Init
		================*/
		s.init=function(){
			s.attach();
		}
		s.init();
	}
})(window,document,undefined);

// @koala-prepend "data.lang.js"
// @koala-prepend "device.js"
// @koala-prepend "eventutil.js"
// @koala-prepend "page.js"
// @koala-prepend "aside.js"
// @koala-prepend "counter.js"
// @koala-prepend "animate.js"
// @koala-prepend "baidumap.js"
// @koala-prepend "dateutil.js"
// @koala-prepend "db.js"
// @koala-prepend "shake.js"
// @koala-prepend "dragrefresh.js"
// @koala-prepend "emoji.js"
// @koala-prepend "form.js"
// @koala-prepend "countval.js"
// @koala-prepend "gauge.js"
// @koala-prepend "media.js"
// @koala-prepend "clock.js"
// @koala-prepend "richeditor.js"
// @koala-prepend "richinput.js"
// @koala-prepend "share.js"
// @koala-prepend "slider.js"
// @koala-prepend "type.js"
// @koala-prepend "weather.js"
// @koala-prepend "calendar.js"
// @koala-prepend "alert.js"
// @koala-prepend "actionsheet.js"
// @koala-prepend "toast.js"
// @koala-prepend "prompt.js"
// @koala-prepend "dialog.js"
// @koala-prepend "scrollpicker.js"
// @koala-prepend "scrollpicker.date.js"
// @koala-prepend "scrollpicker.city.js"
// @koala-prepend "tree.js"
// @koala-prepend "indexbar.js"
// @koala-prepend "loading.js"